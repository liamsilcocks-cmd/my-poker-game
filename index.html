<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SYFM Poker</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{width:100%;height:100%;overflow:hidden;background:#1a0d05;font-family:'Segoe UI',Arial,sans-serif}
#c{width:100%;height:100%;display:block;touch-action:none}
.overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(10,5,2,0.88);z-index:200}
.panel{background:linear-gradient(160deg,#1c0e06 0%,#2a1408 100%);border:2px solid #c8a020;border-radius:16px;padding:36px 44px;min-width:340px;max-width:480px;width:90%;text-align:center;box-shadow:0 0 60px rgba(200,160,32,0.20)}
.panel h1{color:#ffd700;font-size:2.2rem;margin-bottom:8px;letter-spacing:2px}
.panel h2{color:#ffd700;font-size:1.5rem;margin-bottom:18px}
.panel h3{color:#c8a020;font-size:1rem;margin:14px 0 8px}
.panel p{color:#c8a060;margin-bottom:14px;line-height:1.5}
.panel input[type=text],.panel input[type=number]{width:100%;padding:12px 16px;margin:8px 0;border-radius:8px;background:#0d0704;border:1px solid #6a5010;color:#ffd700;font-size:1.1rem;outline:none;text-align:center}
.panel input:focus{border-color:#c8a020}
.btn-gold{width:100%;padding:14px;margin-top:14px;border-radius:8px;border:none;background:linear-gradient(135deg,#c8a020,#8a6a08);color:#000;font-size:1.1rem;font-weight:bold;cursor:pointer;letter-spacing:1px;transition:opacity .2s}
.btn-gold:hover{opacity:.85}
.btn-gold:disabled{opacity:.4;cursor:not-allowed}
.btn-sm{padding:8px 18px;border-radius:6px;border:none;font-size:.9rem;font-weight:bold;cursor:pointer;color:#fff;margin:4px}
.btn-approve{background:#1a6a1a}
.btn-reject{background:#6a1a1a}
.player-row{display:flex;justify-content:space-between;align-items:center;background:rgba(255,255,255,0.05);border-radius:8px;padding:10px 14px;margin:6px 0;color:#e0c060;font-size:.95rem}
.player-row .chips{color:#ffd700;font-weight:bold}
.host-badge{font-size:.7rem;background:#c8a020;color:#000;padding:2px 7px;border-radius:4px;font-weight:bold;margin-left:8px}
.pending-row{display:flex;justify-content:space-between;align-items:center;background:rgba(200,160,32,0.1);border-radius:8px;padding:8px 12px;margin:4px 0;color:#e0c060}
#gameUI{display:none;position:fixed;inset:0;pointer-events:none;z-index:100}
#gameUI > *{pointer-events:auto}
#topBar{position:absolute;top:10px;left:10px;right:10px;background:rgba(0,0,0,0.80);padding:8px 14px;border-radius:8px;color:#ffd700;display:flex;justify-content:space-between;align-items:center;gap:6px}
#phase{font-size:14px;font-weight:bold;white-space:nowrap}
#pot{font-size:17px;font-weight:bold;white-space:nowrap}
#roomBadge{font-size:12px;color:#c8a060;padding:3px 8px;background:rgba(200,160,32,0.15);border-radius:6px;white-space:nowrap}
/* ── Bottom bar: single row of everything ── */
#bottomBar{position:absolute;bottom:10px;left:10px;right:10px;background:rgba(0,0,0,0.82);padding:8px 10px;border-radius:8px;color:#c8a820}
#myInfo{font-size:13px;font-weight:bold;color:#ffd700;text-align:center;margin-bottom:6px}
/* Single unified row: info tools + action buttons all inline */
#bottomRow{display:flex;align-items:center;justify-content:center;gap:5px;flex-wrap:nowrap;overflow-x:auto}
.abtn{padding:9px 14px;border-radius:6px;border:none;font-size:13px;font-weight:bold;cursor:pointer;color:#fff;white-space:nowrap;flex-shrink:0}
.abtn-call{background:#1a7a1a}
.abtn-raise{background:#7a5800}
.abtn-fold{background:#7a1a1a}
.abtn-cashout{background:#4a2a00;border:1px solid #c8a020}
#raiseAmt{width:72px;padding:8px 4px;border-radius:4px;border:1px solid #c8a020;background:rgba(0,0,0,0.8);color:#fff;font-size:13px;text-align:center;flex-shrink:0}
.tbtn{padding:8px 11px;border-radius:6px;border:none;font-size:12px;font-weight:bold;cursor:pointer;color:#fff;transition:background .15s,box-shadow .15s;white-space:nowrap;flex-shrink:0}
.tbtn-pause{background:#1a4a7a}
.tbtn-pause.active{background:#c87020;box-shadow:0 0 8px rgba(200,120,32,0.7)}
.tbtn-autofold{background:#3a1a5a}
.tbtn-autofold.active{background:#8a1010;box-shadow:0 0 8px rgba(200,30,30,0.7)}
.tbtn-fs{background:#1a3a1a}
#msg{position:absolute;top:70px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.92);padding:14px 28px;border-radius:12px;color:#fff;font-size:18px;font-weight:bold;text-align:center;display:none;border:1px solid #c8a020;max-width:80%;white-space:pre-line;pointer-events:none}
/* ── Chat & Activity: top-right, collapsed by default ── */
#sideBoxes{position:absolute;top:58px;right:10px;display:flex;flex-direction:column;gap:6px;width:220px}
#chatBox{background:rgba(0,0,0,0.82);border-radius:8px;border:1px solid #3a2a10;overflow:hidden}
#chatBox.flash #chatHeader{animation:chatFlash 0.6s ease 3}
@keyframes chatFlash{0%{background:transparent}50%{background:rgba(200,160,32,0.35)}100%{background:transparent}}
#chatHeader{display:flex;justify-content:space-between;align-items:center;padding:7px 10px;cursor:pointer;color:#c8a060;font-size:11px;font-weight:bold;user-select:none}
#chatHeader span{color:#a09060;font-size:10px}
#chatInner{padding:0 8px 8px;border-top:1px solid #3a2a10;display:none}
#chatLog{height:90px;overflow-y:auto;font-size:11px;color:#c8c8a0;margin-bottom:5px;display:flex;flex-direction:column;gap:2px}
#chatInput{width:100%;padding:5px 8px;border-radius:4px;border:1px solid #4a3a15;background:rgba(0,0,0,0.7);color:#ffd700;font-size:11px}
#activityBox{background:rgba(0,0,0,0.82);border-radius:8px;border:1px solid #2a3a1a;overflow:hidden}
#activityHeader{display:flex;justify-content:space-between;align-items:center;padding:7px 10px;cursor:pointer;color:#60c840;font-size:11px;font-weight:bold;user-select:none}
#activityHeader span{color:#a0d070;font-size:10px}
#activityLog{height:160px;overflow-y:auto;font-size:10px;color:#b0d890;padding:4px 8px 6px;display:none;flex-direction:column;gap:2px;border-top:1px solid #1a2a10}
#activityLog .log-hand{color:#ffd700;font-weight:bold;margin-top:3px}
#activityLog .log-action{color:#90c870}
#activityLog .log-win{color:#40e870;font-weight:bold}
#activityLog .log-community{color:#a0b8ff}
#brightness{position:absolute;top:58px;left:10px;background:rgba(0,0,0,0.65);padding:8px 12px;border-radius:8px;color:#c8a820}
#brightness label{display:block;font-size:10px;margin-bottom:3px}
#brightSlider{width:90px}
#waitingMsg{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.88);padding:20px 32px;border-radius:14px;color:#c8a020;font-size:16px;text-align:center;display:none;border:1px solid #6a5010;pointer-events:none}
#joinRequestNotif{position:absolute;top:58px;right:240px;background:rgba(10,40,10,0.95);padding:12px 14px;border-radius:10px;color:#e0e0e0;font-size:13px;display:none;border:1px solid #20a040;min-width:200px;z-index:10}
#joinRequestNotif h4{color:#40e060;margin-bottom:6px;font-size:14px}
#joinReqList{display:flex;flex-direction:column;gap:5px}
.jr-row{display:flex;justify-content:space-between;align-items:center;background:rgba(255,255,255,0.07);padding:5px 8px;border-radius:6px}
.jr-name{color:#ffd700;font-weight:bold;font-size:12px}
.jr-btns{display:flex;gap:4px}
.jr-admit{background:#1a6a1a;border:none;color:#fff;padding:3px 8px;border-radius:4px;cursor:pointer;font-size:11px;font-weight:bold}
.jr-reject{background:#6a1a1a;border:none;color:#fff;padding:3px 8px;border-radius:4px;cursor:pointer;font-size:11px;font-weight:bold}
#turnIndicator{position:absolute;bottom:68px;left:10px;color:#ffd700;font-size:13px;font-weight:bold;pointer-events:none;text-shadow:0 0 8px rgba(0,0,0,0.9);display:none;background:rgba(0,0,0,0.80);padding:6px 14px;border-radius:8px;border:1px solid #6a5010;max-width:240px;word-wrap:break-word}
#pauseBanner{position:absolute;top:0;left:0;right:0;bottom:0;display:none;pointer-events:none;z-index:50}
#pauseBanner::after{content:'PAUSED - reviewing\2026';position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:rgba(255,200,0,0.25);font-size:clamp(28px,5vw,60px);font-weight:bold;letter-spacing:4px;white-space:nowrap;pointer-events:none}
</style>
</head>
<body>
<canvas id="c"></canvas>
<div id="loginOverlay" class="overlay">
  <div class="panel">
    <svg width="72" height="72" viewBox="0 0 72 72" xmlns="http://www.w3.org/2000/svg" style="margin-bottom:8px">
      <circle cx="36" cy="36" r="34" fill="#1a1a1a" stroke="#c8a020" stroke-width="4"/>
      <g opacity="0.9">
        <path d="M36 2 A34 34 0 0 1 62.4 19" stroke="#c8a020" stroke-width="8" fill="none" stroke-linecap="butt"/>
        <path d="M62.4 19 A34 34 0 0 1 68.8 47" stroke="#2a1408" stroke-width="8" fill="none" stroke-linecap="butt"/>
        <path d="M68.8 47 A34 34 0 0 1 50 66.5" stroke="#c8a020" stroke-width="8" fill="none" stroke-linecap="butt"/>
        <path d="M50 66.5 A34 34 0 0 1 22 66.5" stroke="#2a1408" stroke-width="8" fill="none" stroke-linecap="butt"/>
        <path d="M22 66.5 A34 34 0 0 1 3.2 47" stroke="#c8a020" stroke-width="8" fill="none" stroke-linecap="butt"/>
        <path d="M3.2 47 A34 34 0 0 1 9.6 19" stroke="#2a1408" stroke-width="8" fill="none" stroke-linecap="butt"/>
        <path d="M9.6 19 A34 34 0 0 1 36 2" stroke="#c8a020" stroke-width="8" fill="none" stroke-linecap="butt"/>
      </g>
      <circle cx="36" cy="36" r="24" fill="#1c0e06" stroke="#c8a020" stroke-width="2.5"/>
      <circle cx="36" cy="36" r="20" fill="none" stroke="rgba(200,160,32,0.3)" stroke-width="1"/>
      <text x="36" y="40" font-family="Arial" font-weight="bold" font-size="9" fill="#ffd700" text-anchor="middle">SYFM</text>
    </svg>
    <h1 style="font-size:2.4rem;letter-spacing:4px;margin-bottom:4px">SYFM</h1>
    <div style="color:#c8a060;font-size:0.95rem;letter-spacing:6px;margin-bottom:18px;text-transform:uppercase">Poker</div>
    <p>Enter your name and a room number to play</p>
    <input type="text" id="nameInput" placeholder="Your name" maxlength="18" autocomplete="off">
    <input type="number" id="roomInput" placeholder="Room number (e.g. 1234)" min="1" max="999999">
    <button class="btn-gold" id="joinBtn">JOIN ROOM</button>
    <p id="loginErr" style="color:#e05050;margin-top:10px;font-size:.9rem"></p>
  </div>
</div>

<div id="waitingOverlay" class="overlay" style="display:none">
  <div class="panel">
    <h2>&#9203; Waiting for host&hellip;</h2>
    <p id="waitingTxt">The host will approve your entry shortly.</p>
    <button class="btn-gold" onclick="location.reload()" style="margin-top:10px">Cancel</button>
  </div>
</div>
<div id="lobbyOverlay" class="overlay" style="display:none">
  <div class="panel">
    <h2>&#127920; Room <span id="lobbyRoomId"></span></h2>
    <div id="playerList"></div>
    <div id="pendingSection" style="display:none">
      <h3>&#9203; Requesting to join:</h3>
      <div id="pendingItems"></div>
    </div>
    <p id="lobbyStatus" style="color:#c8a060;margin-top:14px;font-size:.9rem"></p>
    <button class="btn-gold" id="startBtn" style="display:none;margin-top:18px">&#9654; START GAME</button>
  </div>
</div>
<div id="gameUI">
  <div id="topBar">
    <div id="phase">PRE-FLOP</div>
    <div id="pot">POT: &pound;0.00</div>
    <div id="roomBadge">ROOM &mdash;</div>
    <button class="tbtn tbtn-fs" id="fsBtn" onclick="toggleFullscreen()" title="Fullscreen">&#x26F6;</button>
  </div>
  <!-- Single bottom row: chips info + action buttons + tools all in one line -->
  <div id="bottomBar">
    <div id="myInfo">CHIPS: &pound;10.00</div>
    <div id="bottomRow">
      <!-- Action buttons (shown on your turn) -->
      <button class="abtn abtn-call" id="callBtn" style="display:none">CALL</button>
      <input type="number" id="raiseAmt" value="0.40" step="0.20" min="0.40" style="display:none">
      <button class="abtn abtn-raise" id="raiseBtn" style="display:none">RAISE</button>
      <button class="abtn abtn-fold" id="foldBtn" style="display:none">FOLD</button>
      <!-- Permanent tool buttons -->
      <button class="tbtn tbtn-pause" id="pauseBtn" onclick="togglePause()">&#9646;&#9646;</button>
      <button class="tbtn tbtn-autofold" id="autoFoldBtn" onclick="toggleAutoFold()">AUTO-FOLD</button>
      <button class="abtn abtn-cashout" id="cashOutBtn" onclick="doCashOut()">CASH OUT</button>
      <button class="tbtn tbtn-fs" id="fsBtn2" onclick="toggleFullscreen()" title="Fullscreen">&#x26F6;</button>
    </div>
  </div>
  <div id="pauseBanner"></div>
  <div id="msg"></div>
  <div id="waitingMsg"></div>
  <div id="joinRequestNotif">
    <h4>&#9203; Players want to join</h4>
    <div id="joinReqList"></div>
  </div>
  <div id="turnIndicator"></div>
  <!-- Chat and activity collapsed by default, top-right -->
  <div id="sideBoxes">
    <div id="chatBox">
      <div id="chatHeader" onclick="toggleChat()">&#128172; CHAT <span id="chatToggle">&#9654; expand</span></div>
      <div id="chatInner">
        <div id="chatLog"></div>
        <input type="text" id="chatInput" placeholder="Type and press Enter&hellip;" maxlength="100">
      </div>
    </div>
    <div id="activityBox">
      <div id="activityHeader" onclick="toggleActivityLog()">&#128203; LOG <span id="activityToggle">&#9654; expand</span></div>
      <div id="activityLog"></div>
    </div>
  </div>
  <div id="brightness">
    <label>&#9728; Brightness</label>
    <input type="range" id="brightSlider" min="0.5" max="3.5" step="0.1" value="1.8">
  </div>
</div>
<script src="https://cdn.babylonjs.com/babylon.js"></script>
<script>
'use strict';
let audioCtx;
function ensureAudio(){if(!audioCtx)audioCtx=new(window.AudioContext||window.webkitAudioContext)();}
function snd_deal(){ensureAudio();const t=audioCtx.currentTime,len=Math.floor(audioCtx.sampleRate*0.12),buf=audioCtx.createBuffer(1,len,audioCtx.sampleRate),d=buf.getChannelData(0);for(let i=0;i<len;i++)d[i]=(Math.random()*2-1)*Math.pow(Math.sin(Math.PI*i/len),0.6);const src=audioCtx.createBufferSource(),bp=audioCtx.createBiquadFilter();bp.type='bandpass';bp.Q.value=0.6;bp.frequency.setValueAtTime(4200,t);bp.frequency.exponentialRampToValueAtTime(1600,t+0.12);const g=audioCtx.createGain();g.gain.setValueAtTime(0,t);g.gain.linearRampToValueAtTime(0.28,t+0.015);g.gain.exponentialRampToValueAtTime(0.001,t+0.12);src.buffer=buf;src.connect(bp);bp.connect(g);g.connect(audioCtx.destination);src.start(t);}
function snd_flip(){ensureAudio();const t=audioCtx.currentTime,b=audioCtx.createBuffer(1,Math.floor(audioCtx.sampleRate*0.055),audioCtx.sampleRate),d=b.getChannelData(0);for(let i=0;i<d.length;i++)d[i]=(Math.random()*2-1)*Math.pow(1-i/d.length,1.6);const src=audioCtx.createBufferSource(),g=audioCtx.createGain(),hp=audioCtx.createBiquadFilter();hp.type='highpass';hp.frequency.value=2200;g.gain.setValueAtTime(0.32,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.055);src.buffer=b;src.connect(hp);hp.connect(g);g.connect(audioCtx.destination);src.start(t);}
function snd_chip(){ensureAudio();const t=audioCtx.currentTime,base=1600+Math.random()*500;[[1.0,0.16],[1.52,0.09],[2.51,0.05],[3.97,0.025]].forEach(([r,v])=>{const osc=audioCtx.createOscillator(),g=audioCtx.createGain();osc.type='sine';osc.frequency.value=base*r*(0.97+Math.random()*0.06);g.gain.setValueAtTime(v,t);g.gain.exponentialRampToValueAtTime(0.0001,t+0.09+r*0.022);osc.connect(g);g.connect(audioCtx.destination);osc.start(t);osc.stop(t+0.14);});}
function snd_win(){ensureAudio();const t=audioCtx.currentTime;[523,659,784,1047,1319].forEach((f,i)=>{const o=audioCtx.createOscillator(),g=audioCtx.createGain();o.type='triangle';o.frequency.value=f;g.gain.setValueAtTime(0,t+i*0.10);g.gain.linearRampToValueAtTime(0.12,t+i*0.10+0.04);g.gain.exponentialRampToValueAtTime(0.001,t+i*0.10+0.55);o.connect(g);g.connect(audioCtx.destination);o.start(t+i*0.10);o.stop(t+i*0.10+0.6);});}
function snd_joinAlert(){ensureAudio();const t=audioCtx.currentTime;[[0,880],[0.22,1100]].forEach(([delay,freq])=>{const o=audioCtx.createOscillator(),g=audioCtx.createGain();o.type='sine';o.frequency.setValueAtTime(freq*0.8,t+delay);o.frequency.linearRampToValueAtTime(freq,t+delay+0.12);g.gain.setValueAtTime(0,t+delay);g.gain.linearRampToValueAtTime(0.28,t+delay+0.04);g.gain.exponentialRampToValueAtTime(0.001,t+delay+0.28);o.connect(g);g.connect(audioCtx.destination);o.start(t+delay);o.stop(t+delay+0.3);});}
const SUITS=['\u2660','\u2665','\u2666','\u2663'],RANKS=['2','3','4','5','6','7','8','9','10','J','Q','K','A'];
const NP=9,BB=20,TRX=5.4,TRZ=3.5,SRX=7.0,SRZ=5.2;
let myId=localStorage.getItem('pokerPlayerId')||null,mySeat=0,isHost=false,myRoomId=null,ws=null,lastState=null,lastLobbyMsg=null,dealing=false;
// Dynamic seat positioning: players are spaced evenly around the table
// based on how many are actually seated, not fixed NP slots.
// occupiedSeats: sorted list of server seat indices currently at the table
let occupiedSeats=[];
function updateOccupiedSeats(seats){
  // seats is the server seats array (length NP, nulls for empty)
  occupiedSeats=seats.map((s,i)=>s?i:null).filter(i=>i!==null);
}
function vs(serverSeat){
  // Returns visual slot index 0..(occupiedSeats.length-1),
  // rotated so mySeat always appears at the bottom (slot 0)
  if(occupiedSeats.length===0)return(serverSeat-mySeat+NP)%NP;
  const myIdx=occupiedSeats.indexOf(mySeat);
  const seatIdx=occupiedSeats.indexOf(serverSeat);
  if(seatIdx===-1)return 0;
  const n=occupiedSeats.length;
  return(seatIdx-myIdx+n)%n;
}
function numVisualSeats(){return Math.max(occupiedSeats.length,2);}
const canvas=document.getElementById('c');
const engine=new BABYLON.Engine(canvas,true);
window.addEventListener('resize',()=>engine.resize());
canvas.addEventListener('click',()=>ensureAudio(),{once:true});
let scene,spotLight,shadowGen,cardBackMat,cardFrontMats={},cardPool=[],cardIdx=0,chipPool=[],potChips=[],seatBetChips=Array.from({length:NP},()=>[]),playerLabels=[],seatCardMeshes=Array.from({length:NP},()=>[null,null]),communityCardMeshes=[],dealerToken=null,sbToken=null,bbToken=null;
const POT_BASE=new BABYLON.Vector3(0.2,0.32,-1.90);
function betPos(vSeat){const n=numVisualSeats();const a=-Math.PI/2-(vSeat/n)*Math.PI*2,rx=TRX*0.46,rz=TRZ*0.46;return new BABYLON.Vector3(Math.cos(a)*rx,0.32,Math.sin(a)*rz);}
function seatPos(i){const n=numVisualSeats();const a=-Math.PI/2-(i/n)*Math.PI*2;return new BABYLON.Vector3(Math.cos(a)*SRX,0.26,Math.sin(a)*SRZ);}
function cardPos(si,cn){
  // si = visual seat index, cn = card number (0=first/left, 1=second/right)
  const n=numVisualSeats();
  const a=-Math.PI/2-(si/n)*Math.PI*2;
  const rx=TRX*0.70,rz=TRZ*0.70;
  // Perpendicular tangent direction: rotate seat angle +90deg
  const pa=a+Math.PI/2;
  const off=(cn===0?-0.68:0.68);
  return new BABYLON.Vector3(
    Math.cos(a)*rx+Math.cos(pa)*off,
    0.30+cn*0.003,
    Math.sin(a)*rz+Math.sin(pa)*off
  );
}
const DECK_POS=()=>new BABYLON.Vector3(-TRX*0.76,0.32,0);
const COM_POS=[new BABYLON.Vector3(-2.20,0.305,0),new BABYLON.Vector3(-1.05,0.305,0),new BABYLON.Vector3(0.10,0.305,0),new BABYLON.Vector3(1.50,0.305,0),new BABYLON.Vector3(2.65,0.305,0)];
function mkBackTex(){
  const W=512,H=768;
  const tex=new BABYLON.DynamicTexture('bt',{width:W,height:H},scene,true);
  const c=tex.getContext();
  // Deep navy-to-midnight gradient
  const g=c.createLinearGradient(0,0,W,H);
  g.addColorStop(0,'#0b1850');g.addColorStop(1,'#060c2a');
  c.fillStyle=g;c.fillRect(0,0,W,H);
  // Gold outer border
  c.strokeStyle='#c8a020';c.lineWidth=14;c.strokeRect(7,7,W-14,H-14);
  // Inner border
  c.strokeStyle='rgba(200,160,32,0.55)';c.lineWidth=3;c.strokeRect(24,24,W-48,H-48);
  // Subtle diagonal hatching
  c.strokeStyle='rgba(200,160,32,0.10)';c.lineWidth=1;
  for(let x=-H;x<W+H;x+=20){
    c.beginPath();c.moveTo(x,0);c.lineTo(x+H,H);c.stroke();
    c.beginPath();c.moveTo(x+H,0);c.lineTo(x,H);c.stroke();
  }
  // SYFM in large bold gold — same style as the suit on the felt
  c.fillStyle='rgba(200,160,32,0.82)';
  c.font='bold 118px Arial';
  c.textAlign='center';c.textBaseline='middle';
  c.fillText('SYFM',W/2,H/2);
  // Smaller SYFM top-left and bottom-right corners for orientation
  c.font='bold 36px Arial';
  c.fillStyle='rgba(200,160,32,0.55)';
  c.textAlign='left';c.textBaseline='top';
  c.fillText('SYFM',34,34);
  c.save();c.translate(W,H);c.rotate(Math.PI);
  c.textAlign='left';c.textBaseline='top';
  c.fillText('SYFM',34,34);
  c.restore();
  tex.update();return tex;
}
function mkFrontTex(suit,rank){
  // 512x768 power-of-2 — avoids Chrome WebGL clamping
  const W=512,H=768;
  const tex=new BABYLON.DynamicTexture('ft'+rank+suit,{width:W,height:H},scene,true);
  const c=tex.getContext();
  const isRed=suit==='\u2665'||suit==='\u2666';
  const col=isRed?'#cc0000':'#111111';
  const suitNames={'\u2660':'SPADES','\u2665':'HEARTS','\u2666':'DIAMONDS','\u2663':'CLUBS'};
  const suitName=suitNames[suit]||'';

  // Background + thick outer border
  c.fillStyle='#fafafa';c.fillRect(0,0,W,H);
  c.strokeStyle=col;c.lineWidth=10;c.strokeRect(5,5,W-10,H-10);
  // Inner inset box
  const BX=30,BY=30,BW=W-60,BH=H-60;
  c.strokeStyle=col+'44';c.lineWidth=2;c.strokeRect(BX,BY,BW,BH);

  // ── Corner indices (rank + suit pip) ────────────────────────────────
  // Use tight textBaseline='hanging' to avoid clipping ascenders
  const rnkSz=rank==='10'?88:100;
  const cPipSz=64;
  const cx=16,cy=14;
  c.fillStyle=col;
  // TOP-LEFT
  c.textAlign='left';c.textBaseline='top';
  c.font='bold '+rnkSz+'px Arial';c.fillText(rank,cx,cy);
  c.font=cPipSz+'px Arial';c.fillText(suit,cx+2,cy+rnkSz+2);
  // TOP-RIGHT
  c.textAlign='right';c.textBaseline='top';
  c.font='bold '+rnkSz+'px Arial';c.fillText(rank,W-cx,cy);
  c.font=cPipSz+'px Arial';c.fillText(suit,W-cx-2,cy+rnkSz+2);
  // BOTTOM — upside-down via transform so they read correctly when card is rotated
  c.save();c.translate(W,H);c.rotate(Math.PI);
  c.textAlign='left';c.textBaseline='top';
  c.font='bold '+rnkSz+'px Arial';c.fillText(rank,cx,cy);
  c.font=cPipSz+'px Arial';c.fillText(suit,cx+2,cy+rnkSz+2);
  c.textAlign='right';
  c.font='bold '+rnkSz+'px Arial';c.fillText(rank,W-cx,cy);
  c.font=cPipSz+'px Arial';c.fillText(suit,W-cx-2,cy+rnkSz+2);
  c.restore();

  // ── Suit name in strong colour just below top inner border ───────────
  c.fillStyle=col;  // proper red or black — NOT grey
  c.font='bold 30px Arial';c.textAlign='center';c.textBaseline='top';
  c.fillText(suitName,W/2,BY+8);

  // ── Pip area (below corner + suit name) ──────────────────────────────
  const pipTop=BY+52;
  const pipBot=H-BY-52;
  const pipH=pipBot-pipTop;
  const pipLeft=BX+32;
  const pipRight=W-BX-32;
  const pipW=pipRight-pipLeft;

  // Traditional pip layouts [x-fraction, y-fraction, flipBottom?]
  // x,y fractions within pip area; bottom-half pips are rotated 180° on real cards
  const L={
    '2': [[0.5,0.12,false],[0.5,0.88,true]],
    '3': [[0.5,0.12,false],[0.5,0.5,false],[0.5,0.88,true]],
    '4': [[0.2,0.12,false],[0.8,0.12,false],[0.2,0.88,true],[0.8,0.88,true]],
    '5': [[0.2,0.12,false],[0.8,0.12,false],[0.5,0.5,false],[0.2,0.88,true],[0.8,0.88,true]],
    '6': [[0.2,0.12,false],[0.8,0.12,false],[0.2,0.5,false],[0.8,0.5,true],[0.2,0.88,true],[0.8,0.88,true]],
    '7': [[0.2,0.12,false],[0.8,0.12,false],[0.5,0.31,false],[0.2,0.5,false],[0.8,0.5,true],[0.2,0.88,true],[0.8,0.88,true]],
    '8': [[0.2,0.10,false],[0.8,0.10,false],[0.5,0.30,false],[0.2,0.50,false],[0.8,0.50,true],[0.5,0.68,true],[0.2,0.88,true],[0.8,0.88,true]],
    '9': [[0.2,0.10,false],[0.8,0.10,false],[0.2,0.34,false],[0.8,0.34,false],[0.5,0.50,false],[0.2,0.66,true],[0.8,0.66,true],[0.2,0.90,true],[0.8,0.90,true]],
    '10':[[0.2,0.10,false],[0.8,0.10,false],[0.5,0.26,false],[0.2,0.40,false],[0.8,0.40,false],[0.2,0.60,true],[0.8,0.60,true],[0.5,0.74,true],[0.2,0.90,true],[0.8,0.90,true]]
  };

  // Pip sizes — nice and big so readable on mobile
  const pSzMap={'A':190,'2':120,'3':112,'4':108,'5':102,'6':96,'7':90,'8':84,'9':78,'10':74};
  const pSz=pSzMap[rank]||90;

  if(rank==='A'){
    // Ace: single massive centred pip
    c.font=pSz+'px Arial';c.textAlign='center';c.textBaseline='middle';
    c.fillStyle=col;c.fillText(suit,W/2,pipTop+pipH*0.5);

  }else if(['J','Q','K'].includes(rank)){
    // Face cards: clean coloured panel with rank initial + suit
    const fX=BX+8,fY=BY+50,fW=BW-16,fH=BH-100;
    // Tinted background panel
    c.fillStyle=isRed?'#fff5f5':'#f5f5ff';
    c.fillRect(fX,fY,fW,fH);
    c.strokeStyle=col+'33';c.lineWidth=3;c.strokeRect(fX,fY,fW,fH);
    // Large rank letter — using fillText metrics (no clip issues with textBaseline=middle)
    c.fillStyle=col;
    c.font='bold 260px Arial';  // Arial has reliable metrics, no clipping
    c.textAlign='center';c.textBaseline='middle';
    c.fillText(rank,fX+fW/2,fY+fH*0.44);
    // Suit below
    c.font='110px Arial';
    c.fillText(suit,fX+fW/2,fY+fH*0.82);

  }else{
    // Number cards: pip layout
    const pips=L[rank]||[];
    c.fillStyle=col;
    for(const [fx,fy,flip] of pips){
      const px=pipLeft+fx*pipW;
      const py=pipTop+fy*pipH;
      if(flip){
        c.save();c.translate(px,py);c.rotate(Math.PI);
        c.font=pSz+'px Arial';c.textAlign='center';c.textBaseline='middle';
        c.fillText(suit,0,0);
        c.restore();
      }else{
        c.font=pSz+'px Arial';c.textAlign='center';c.textBaseline='middle';
        c.fillText(suit,px,py);
      }
    }
  }

  // For 6 and 9: extra disambiguation text at bottom (subtle)
  if(rank==='6'||rank==='9'){
    const word=rank==='6'?'SIX':'NINE';
    c.fillStyle=col+'66';
    c.font='bold 26px Arial';c.textAlign='center';c.textBaseline='bottom';
    c.fillText(word,W/2,H-BY-10);
  }

  tex.update();return tex;
}
function buildCardMats(){cardBackMat=new BABYLON.StandardMaterial('back',scene);cardBackMat.diffuseTexture=mkBackTex();cardBackMat.specularColor=new BABYLON.Color3(0.1,0.1,0.1);cardBackMat.specularPower=30;cardBackMat.backFaceCulling=false;for(const s of SUITS)for(const r of RANKS){const k=r+s,m=new BABYLON.StandardMaterial('f'+k,scene);m.diffuseTexture=mkFrontTex(s,r);m.specularColor=new BABYLON.Color3(0.08,0.08,0.08);m.specularPower=20;m.backFaceCulling=false;cardFrontMats[k]=m;}}
function buildCardPool(){for(let i=0;i<80;i++){const m=BABYLON.MeshBuilder.CreatePlane('card'+i,{width:1.28,height:1.80},scene);m.rotation.x=Math.PI/2;m.position=DECK_POS();m.material=cardBackMat;m.isVisible=false;m.renderingGroupId=1;shadowGen.addShadowCaster(m);cardPool.push(m);}}
function nextCardMesh(){const m=cardPool[cardIdx%cardPool.length];cardIdx=(cardIdx+1)%cardPool.length;m.position=DECK_POS().clone();m.position.y+=0.28;m.rotation=new BABYLON.Vector3(Math.PI/2,0,0);m.scaling=new BABYLON.Vector3(1,1,1);m.material=cardBackMat;m.isVisible=true;return m;}
const CHIP_DENOM=[{val:500,col:[0.52,0.06,0.62]},{val:100,col:[0.14,0.20,0.88]},{val:25,col:[0.10,0.60,0.16]},{val:5,col:[0.85,0.10,0.10]},{val:1,col:[0.90,0.88,0.86]}];
function buildChipPool(){for(const d of CHIP_DENOM){for(let i=0;i<60;i++){const chip=BABYLON.MeshBuilder.CreateCylinder('chip_'+d.val+'_'+i,{height:0.072,diameter:0.34,tessellation:32},scene),m=new BABYLON.StandardMaterial('cmat_'+d.val+'_'+i,scene);m.diffuseColor=new BABYLON.Color3(...d.col);m.specularColor=new BABYLON.Color3(1,1,1);m.specularPower=300;m.emissiveColor=new BABYLON.Color3(...d.col.map(v=>v*0.22));chip.material=m;chip.isVisible=false;chip.renderingGroupId=1;chip._dval=d.val;chipPool.push(chip);}}}
function acquireChip(forVal){const d=CHIP_DENOM.find(d=>d.val<=forVal)||CHIP_DENOM[CHIP_DENOM.length-1];const ch=chipPool.find(c=>!c.isVisible&&c._dval===d.val)||chipPool.find(c=>!c.isVisible)||null;if(ch)ch.isVisible=true;return ch;}
function freeChip(c){if(c){c.isVisible=false;c.position=new BABYLON.Vector3(0,-5,0);}}
function freeAllChips(){[...potChips].forEach(freeChip);potChips=[];seatBetChips.forEach(arr=>{arr.forEach(freeChip);});seatBetChips=Array.from({length:NP},()=>[]);}
function buildChipStack(amount){const chips=[];let rem=amount;for(const d of CHIP_DENOM){if(rem<=0||chips.length>=12)break;const n=Math.min(Math.floor(rem/d.val),5);for(let i=0;i<n&&chips.length<12;i++){const ch=acquireChip(d.val);if(ch){chips.push(ch);rem-=d.val;}}}return chips;}
function animChipArc(chips,srcPos,dstBase,staggerMs,baseY,cb){
  if(!chips.length){if(cb)setTimeout(cb,50);return;}
  let done=0;
  chips.forEach((chip,i)=>{
    chip.position=new BABYLON.Vector3(srcPos.x,srcPos.y+0.45+i*0.07,srcPos.z);
    const tgt=new BABYLON.Vector3(dstBase.x+(Math.random()-0.5)*0.20,baseY+i*0.060,dstBase.z+(Math.random()-0.5)*0.20);
    const mid=new BABYLON.Vector3((chip.position.x+tgt.x)*0.5,chip.position.y+2.0,(chip.position.z+tgt.z)*0.5);
    const a=mkAnim('position',BABYLON.Animation.ANIMATIONTYPE_VECTOR3,[{frame:0,value:chip.position.clone()},{frame:10,value:mid},{frame:22,value:tgt}],'out');
    chip.animations=[a];
    setTimeout(()=>{scene.beginAnimation(chip,0,22,false,1.4,()=>{snd_chip();done++;if(done===chips.length&&cb)cb();});},i*staggerMs);
  });}
function showBet(serverSeat,amount){
  if(amount<=0)return;
  const vSeat=vs(serverSeat),src=seatPos(vSeat),dst=betPos(vSeat);
  const existH=seatBetChips[serverSeat].length*0.060;
  const chips=buildChipStack(amount);
  seatBetChips[serverSeat].push(...chips);
  animChipArc(chips,src,dst,38,0.32+existH,null);}
function sweepBetsToPot(cb){
  const all=[];seatBetChips.forEach(arr=>all.push(...arr));
  seatBetChips=Array.from({length:NP},()=>[]);
  if(!all.length){if(cb)setTimeout(cb,60);return;}
  const baseY=0.32+potChips.length*0.055;
  let done=0;
  all.forEach((chip,i)=>{
    const tgt=new BABYLON.Vector3(POT_BASE.x+(Math.random()-0.5)*0.38,baseY+i*0.055,POT_BASE.z+(Math.random()-0.5)*0.28);
    const mid=new BABYLON.Vector3((chip.position.x+tgt.x)*0.5,chip.position.y+1.5,(chip.position.z+tgt.z)*0.5);
    const a=mkAnim('position',BABYLON.Animation.ANIMATIONTYPE_VECTOR3,[{frame:0,value:chip.position.clone()},{frame:8,value:mid},{frame:18,value:tgt}],'out');
    chip.animations=[a];
    setTimeout(()=>{scene.beginAnimation(chip,0,18,false,1.6,()=>{snd_chip();potChips.push(chip);done++;if(done===all.length&&cb)cb();});},i*28);});}
function chipsFlyToWinner(winSeat,cb){
  const wp=seatPos(vs(winSeat));wp.y+=0.8;
  const all=[...potChips];seatBetChips.forEach(arr=>all.push(...arr));
  potChips=[];seatBetChips=Array.from({length:NP},()=>[]);
  if(!all.length){if(cb)cb();return;}
  let done=0;
  all.forEach((chip,i)=>{
    const start=chip.position.clone(),mid=new BABYLON.Vector3((start.x+wp.x)*0.5,start.y+2.4,(start.z+wp.z)*0.5);
    const a=mkAnim('position',BABYLON.Animation.ANIMATIONTYPE_VECTOR3,[{frame:0,value:start},{frame:8,value:mid},{frame:18,value:wp}],'in');
    chip.animations=[a];
    setTimeout(()=>{scene.beginAnimation(chip,0,18,false,1.5,()=>{snd_chip();freeChip(chip);done++;if(done===all.length&&cb)cb();});},i*18);});}
function buildTokens(){function makeToken(name,r,g,b,label){const tok=BABYLON.MeshBuilder.CreateCylinder(name,{height:0.12,diameter:0.48,tessellation:32},scene),m=new BABYLON.StandardMaterial(name+'m',scene);m.diffuseColor=new BABYLON.Color3(r,g,b);m.specularColor=new BABYLON.Color3(1,1,1);m.specularPower=300;m.emissiveColor=new BABYLON.Color3(r*0.3,g*0.3,b*0.3);tok.material=m;tok.isVisible=false;tok.renderingGroupId=1;const discTex=new BABYLON.DynamicTexture(name+'dt',{width:128,height:128},scene,false),dc=discTex.getContext();dc.fillStyle='rgb('+Math.round(r*255)+','+Math.round(g*255)+','+Math.round(b*255)+')';dc.beginPath();dc.arc(64,64,62,0,Math.PI*2);dc.fill();dc.strokeStyle='rgba(0,0,0,0.5)';dc.lineWidth=3;dc.stroke();dc.fillStyle=(r+g+b>1.5)?'#000':'#fff';dc.font='bold 42px Arial';dc.textAlign='center';dc.textBaseline='middle';dc.fillText(label,64,64);discTex.update();const disc=BABYLON.MeshBuilder.CreateDisc(name+'d',{radius:0.24,tessellation:32},scene),dm=new BABYLON.StandardMaterial(name+'dm',scene);dm.diffuseTexture=discTex;dm.emissiveColor=new BABYLON.Color3(1,1,1);dm.disableLighting=true;dm.backFaceCulling=false;disc.material=dm;disc.rotation.x=-Math.PI/2;disc.position.y=0.07;disc.parent=tok;disc.renderingGroupId=2;return tok;}dealerToken=makeToken('dealer',0.95,0.95,0.95,'D');sbToken=makeToken('sb',0.15,0.40,0.90,'SB');bbToken=makeToken('bb',0.90,0.80,0.10,'BB');}
function positionTokens(dSeat,sbSeat,bbSeat){
  const RX=TRX*0.50,RZ=TRZ*0.50;
  const _n=numVisualSeats();
  function seatA(seat){return -Math.PI/2-(seat/_n)*Math.PI*2;}
  function place(tok,seat,angOffset){const a=seatA(seat)+angOffset;tok.position=new BABYLON.Vector3(Math.cos(a)*RX,0.38,Math.sin(a)*RZ);tok.isVisible=true;}
  if(dSeat===sbSeat){place(dealerToken,dSeat,0.18);place(sbToken,sbSeat,-0.18);}
  else{place(dealerToken,dSeat,0);place(sbToken,sbSeat,0.06);}
  place(bbToken,bbSeat,0.06);}
const LW=320,LH=128;
function buildPlayerLabels(){for(let i=0;i<NP;i++){const tex=new BABYLON.DynamicTexture('plbtex'+i,{width:LW,height:LH},scene,false);tex.hasAlpha=true;const mat=new BABYLON.StandardMaterial('plbm'+i,scene);mat.diffuseTexture=tex;mat.hasAlpha=true;mat.emissiveColor=new BABYLON.Color3(1,1,1);mat.disableLighting=true;mat.backFaceCulling=false;const plane=BABYLON.MeshBuilder.CreatePlane('plbp'+i,{width:2.2,height:0.88},scene);plane.material=mat;const sp=seatPos(i);plane.position=new BABYLON.Vector3(sp.x*0.78,0.98,sp.z*0.78);plane.billboardMode=BABYLON.Mesh.BILLBOARDMODE_ALL;plane.isVisible=false;plane.renderingGroupId=2;playerLabels.push({plane,tex});}}
function updateLabel(seat,name,chips,bet,action,isMe,isDead){const vSeat=vs(seat),lb=playerLabels[vSeat];if(!lb)return;const sp=seatPos(vSeat);lb.plane.position=new BABYLON.Vector3(sp.x*0.78,0.98,sp.z*0.78);const ctx=lb.tex.getContext();ctx.clearRect(0,0,LW,LH);if(!name){lb.plane.isVisible=false;lb.tex.update();return;}const bgCol=isDead?'rgba(80,20,20,0.82)':isMe?'rgba(10,60,10,0.88)':'rgba(10,10,50,0.82)';ctx.fillStyle=bgCol;ctx.beginPath();if(ctx.roundRect)ctx.roundRect(2,2,LW-4,LH-4,10);else ctx.rect(2,2,LW-4,LH-4);ctx.fill();const borderCol=isMe?'#20c040':isDead?'#802020':'#c8a020';ctx.strokeStyle=borderCol;ctx.lineWidth=2;ctx.beginPath();if(ctx.roundRect)ctx.roundRect(2,2,LW-4,LH-4,10);else ctx.rect(2,2,LW-4,LH-4);ctx.stroke();ctx.fillStyle='#ffffff';ctx.font='bold 24px Arial';ctx.textAlign='center';ctx.textBaseline='top';const dispName=(name.length>14?name.slice(0,13)+'\u2026':name).toUpperCase();ctx.fillText(dispName,LW/2,8);ctx.fillStyle='#ffd700';ctx.font='19px Arial';ctx.fillText('\u00a3'+(chips/100).toFixed(2),LW/2,38);if(bet>0){ctx.fillStyle='#80cfff';ctx.font='15px Arial';ctx.fillText('STAKE: \u00a3'+(bet/100).toFixed(2),LW/2,64);}if(action){const ac=action.toUpperCase(),acCol=ac.startsWith('FOLD')?'#c04040':ac.startsWith('RAISE')?'#e09020':'#20c040';ctx.fillStyle=acCol;ctx.font='bold 16px Arial';ctx.fillText(ac,LW/2,bet>0?90:68);}lb.tex.update();lb.plane.isVisible=true;}
function mkAnim(prop,type,keys,ease){const a=new BABYLON.Animation('a_'+prop,prop,60,type,BABYLON.Animation.ANIMATIONLOOPMODE_CONSTANT);a.setKeys(keys);const ef=ease==='in'?new BABYLON.QuadraticEase():new BABYLON.CubicEase();ef.setEasingMode(ease==='in'?BABYLON.EasingFunction.EASINGMODE_EASEIN:BABYLON.EasingFunction.EASINGMODE_EASEOUT);a.setEasingFunction(ef);return a;}
function animDeal(mesh,target,cb){const start=mesh.position.clone(),mid=new BABYLON.Vector3((start.x+target.x)*.5,start.y+2.8,(start.z+target.z)*.5),a=mkAnim('position',BABYLON.Animation.ANIMATIONTYPE_VECTOR3,[{frame:0,value:start},{frame:10,value:mid},{frame:24,value:target}],'out');scene.stopAnimation(mesh);mesh.animations=[a];scene.beginAnimation(mesh,0,24,false,1.5,cb||null);}
function animFlipUp(mesh,frontMat,cb){const a1=mkAnim('scaling.x',BABYLON.Animation.ANIMATIONTYPE_FLOAT,[{frame:0,value:1},{frame:9,value:0}],'in');scene.stopAnimation(mesh);mesh.animations=[a1];scene.beginAnimation(mesh,0,9,false,1,()=>{mesh.material=frontMat;const a2=mkAnim('scaling.x',BABYLON.Animation.ANIMATIONTYPE_FLOAT,[{frame:0,value:0},{frame:9,value:1}],'out');scene.stopAnimation(mesh);mesh.animations=[a2];scene.beginAnimation(mesh,0,9,false,1,cb||null);});}
function createScene(){scene=new BABYLON.Scene(engine);scene.clearColor=new BABYLON.Color4(0.04,0.04,0.04,1);
const cam=new BABYLON.ArcRotateCamera('cam',-Math.PI/2,Math.PI/3.6,17,new BABYLON.Vector3(0,0.5,0),scene);
cam.lowerRadiusLimit=8;cam.upperRadiusLimit=26;cam.lowerBetaLimit=0.22;cam.upperBetaLimit=1.32;cam.wheelPrecision=22;cam.attachControl(canvas,true);
// Ambient — very dim warm fill
const h=new BABYLON.HemisphericLight('h',new BABYLON.Vector3(0,1,0),scene);
h.intensity=0.12;h.diffuse=new BABYLON.Color3(0.7,0.62,0.45);h.groundColor=new BABYLON.Color3(0.04,0.03,0.02);
// Main overhead spot — warm casino bulb colour
spotLight=new BABYLON.SpotLight('sp',new BABYLON.Vector3(0,12,0),new BABYLON.Vector3(0,-1,0),Math.PI/2.2,1.8,scene);
spotLight.intensity=2.2;spotLight.diffuse=new BABYLON.Color3(1.0,0.92,0.72);
// Second softer fill from front-left to reduce harsh shadows on felt
const fillLight=new BABYLON.PointLight('fill',new BABYLON.Vector3(-4,7,4),scene);
fillLight.intensity=0.5;fillLight.diffuse=new BABYLON.Color3(0.8,0.75,0.55);
shadowGen=new BABYLON.ShadowGenerator(2048,spotLight);shadowGen.useBlurExponentialShadowMap=true;shadowGen.blurKernel=16;
// Floor — dark almost-black wood-look
const f=BABYLON.MeshBuilder.CreateGround('floor',{width:44,height:44},scene);
f.position.y=-0.22;f.receiveShadows=true;
const fm=new BABYLON.StandardMaterial('fm',scene);
fm.diffuseColor=new BABYLON.Color3(0.06,0.04,0.02);
fm.specularColor=new BABYLON.Color3(0.25,0.15,0.06);fm.specularPower=120;f.material=fm;
// Table base — dark espresso wood
const T=96;
const base=BABYLON.MeshBuilder.CreateCylinder('base',{height:0.52,diameter:12,tessellation:T},scene);
base.scaling.x=TRX/6;base.scaling.z=TRZ/6;base.position.y=-0.01;
const bm=new BABYLON.StandardMaterial('bm',scene);
bm.diffuseColor=new BABYLON.Color3(0.14,0.07,0.02);
bm.specularColor=new BABYLON.Color3(0.70,0.45,0.12);bm.specularPower=220;
base.material=bm;
// Padded rail — deep burgundy/walnut leather look
const rail=BABYLON.MeshBuilder.CreateTorus('rail',{diameter:11.4,thickness:0.52,tessellation:T,radialSegments:24},scene);
rail.scaling.x=TRX/(11.4/2)*0.97;rail.scaling.z=TRZ/(11.4/2)*0.97;rail.position.y=0.22;
const rm=new BABYLON.StandardMaterial('rm',scene);
rm.diffuseColor=new BABYLON.Color3(0.18,0.06,0.03);   // dark oxblood leather
rm.specularColor=new BABYLON.Color3(0.60,0.25,0.08);rm.specularPower=180;
rm.emissiveColor=new BABYLON.Color3(0.02,0.005,0.002);
rail.material=rm;
// Gold trim ring between rail and felt
const trim=BABYLON.MeshBuilder.CreateTorus('trim',{diameter:10.9,thickness:0.08,tessellation:T,radialSegments:8},scene);
trim.scaling.x=TRX/(10.9/2)*0.93;trim.scaling.z=TRZ/(10.9/2)*0.93;trim.position.y=0.30;
const trm=new BABYLON.StandardMaterial('trm',scene);
trm.diffuseColor=new BABYLON.Color3(0.72,0.52,0.08);
trm.specularColor=new BABYLON.Color3(1,0.9,0.4);trm.specularPower=400;
trm.emissiveColor=new BABYLON.Color3(0.12,0.08,0.01);
trim.material=trm;
// Felt — rich casino green matching the reference
const felt=BABYLON.MeshBuilder.CreateCylinder('felt',{height:0.07,diameter:10.8,tessellation:T},scene);
felt.scaling.x=TRX/(10.8/2)*0.90;felt.scaling.z=TRZ/(10.8/2)*0.90;felt.position.y=0.28;
const ftm=new BABYLON.StandardMaterial('ftm',scene);
ftm.diffuseColor=new BABYLON.Color3(0.04,0.20,0.09);  // deep forest casino green
ftm.specularColor=new BABYLON.Color3(0.02,0.06,0.03);ftm.specularPower=4;
felt.material=ftm;felt.receiveShadows=true;
// Inner felt inlay line (subtle lighter ring)
const inlay=BABYLON.MeshBuilder.CreateTorus('inlay',{diameter:9.8,thickness:0.04,tessellation:T,radialSegments:6},scene);
inlay.scaling.x=TRX/(9.8/2)*0.86;inlay.scaling.z=TRZ/(9.8/2)*0.86;inlay.position.y=0.32;
const ilm=new BABYLON.StandardMaterial('ilm',scene);
ilm.diffuseColor=new BABYLON.Color3(0.08,0.32,0.14);
ilm.emissiveColor=new BABYLON.Color3(0.01,0.04,0.02);
inlay.material=ilm;
const brandTex=new BABYLON.DynamicTexture('brand',{width:1024,height:512},scene,false);brandTex.hasAlpha=true;const bc=brandTex.getContext();bc.clearRect(0,0,1024,512);bc.fillStyle='rgba(255,255,255,0.07)';bc.font='bold 170px Arial';bc.textAlign='center';bc.textBaseline='middle';bc.fillText('SYFM UC',512,256);brandTex.update();const brandMat=new BABYLON.StandardMaterial('brandMat',scene);brandMat.diffuseTexture=brandTex;brandMat.hasAlpha=true;brandMat.emissiveColor=new BABYLON.Color3(1,1,1);brandMat.disableLighting=true;brandMat.backFaceCulling=false;const brandPlane=BABYLON.MeshBuilder.CreatePlane('brand',{width:TRX*1.55,height:TRZ*1.35},scene);brandPlane.rotation.x=Math.PI/2;brandPlane.position.y=0.262;brandPlane.material=brandMat;brandPlane.renderingGroupId=1;buildCardMats();buildCardPool();buildChipPool();buildPlayerLabels();buildTokens();return scene;}
let seatActions={};
function applyState(st){if(!st)return;lastState=st;if(st.players)updateOccupiedSeats(st.players);for(let i=0;i<NP;i++){const p=st.players[i];if(p)updateLabel(i,p.name,p.chips,p.bet||0,seatActions[i]||'',i===mySeat,p.folded);else updateLabel(i,null,0,0,'',false,false);}const comm=st.community||[];for(let ci=0;ci<5;ci++){const mesh=communityCardMeshes[ci];if(ci<comm.length){if(!mesh||!mesh.isVisible){const m=getOrCreateCommunityMesh(ci),target=COM_POS[ci].clone();m.material=cardBackMat;m.isVisible=true;animDeal(m,target,()=>{snd_deal();const cd=comm[ci];if(cd&&cd!=='back')animFlipUp(m,cardFrontMats[cd.r+cd.s]||cardBackMat,()=>snd_flip());});}}else{if(mesh)mesh.isVisible=false;}}for(let i=0;i<NP;i++){const p=st.players[i],meshes=seatCardMeshes[i];if(!p||!p.cards||p.cards.length===0){for(const m of meshes){if(m)m.isVisible=false;}seatCardMeshes[i]=[null,null];continue;}p.cards.forEach((cd,cn)=>{const m=meshes[cn];if(!m||!m.isVisible)return;if(cd&&cd!=='back'){const fmat=cardFrontMats[cd.r+cd.s];if(fmat&&m.material!==fmat)animFlipUp(m,fmat,()=>snd_flip());}});}const p0=st.players[mySeat];if(p0)document.getElementById('myInfo').textContent='YOUR CHIPS: \u00a3'+(p0.chips/100).toFixed(2)+'  |  BET: \u00a3'+(p0.bet/100).toFixed(2);document.getElementById('pot').textContent='POT: \u00a3'+((st.pot||0)/100).toFixed(2);document.getElementById('phase').textContent=(st.phase||'').toUpperCase().replace('PREFLOP','PRE-FLOP');}
function getOrCreateCommunityMesh(idx){if(communityCardMeshes[idx]&&communityCardMeshes[idx].isVisible!==undefined)return communityCardMeshes[idx];const m=nextCardMesh();communityCardMeshes[idx]=m;return m;}
function startDealAnimation(activeSeats,afterDone){
  // activeSeats is already rotated by the caller so SB is first, dealer is last
  dealing=true;
  for(let i=0;i<NP;i++){const meshes=seatCardMeshes[i]||[];for(const m of meshes){if(m)m.isVisible=false;}seatCardMeshes[i]=[null,null];}
  for(const m of communityCardMeshes){if(m)m.isVisible=false;}
  communityCardMeshes=[];freeAllChips();
  // Build deal sequence: one card to each player (round 1), then second card (round 2)
  const seq=[];
  for(let rd=0;rd<2;rd++)for(const si of activeSeats)seq.push(si);
  const dealt={};for(const si of activeSeats)dealt[si]=0;
  let idx=0;
  function next(){
    if(idx>=seq.length){dealing=false;if(afterDone)afterDone();return;}
    const si=seq[idx++],cn=dealt[si]||0;dealt[si]=cn+1;
    const m=nextCardMesh();seatCardMeshes[si][cn]=m;
    const target=cardPos(vs(si),cn);
    animDeal(m,target,()=>{snd_deal();if(lastState&&lastState.players[si]){const cd=lastState.players[si].cards[cn];if(cd&&cd!=='back')animFlipUp(m,cardFrontMats[cd.r+cd.s]||cardBackMat,()=>snd_flip());}setTimeout(next,80);});
  }
  next();}
function connectWS(name,roomId,playerId){const proto=location.protocol==='https:'?'wss:':'ws:';ws=new WebSocket(proto+'//'+location.host);ws.onopen=()=>{ws.send(JSON.stringify({type:'join',id:playerId,name,room:roomId}));};ws.onmessage=(ev)=>{let msg;try{msg=JSON.parse(ev.data);}catch{return;}handleServerMsg(msg);};ws.onclose=()=>{showMsg('\u26a0 Disconnected from server',0);setTimeout(()=>location.reload(),4000);};ws.onerror=()=>{document.getElementById('loginErr').textContent='Could not connect to server.';document.getElementById('loginOverlay').style.display='flex';document.getElementById('waitingOverlay').style.display='none';document.getElementById('lobbyOverlay').style.display='none';};}
function wsSend(obj){if(ws&&ws.readyState===1)ws.send(JSON.stringify(obj));}
function handleServerMsg(msg){switch(msg.type){
case 'joined':myId=msg.id;mySeat=msg.seat;isHost=msg.isHost;localStorage.setItem('pokerPlayerId',myId);document.getElementById('loginOverlay').style.display='none';document.getElementById('waitingOverlay').style.display='none';break;
case 'waiting':document.getElementById('loginOverlay').style.display='none';document.getElementById('waitingOverlay').style.display='flex';break;
case 'rejected':document.getElementById('waitingOverlay').style.display='none';document.getElementById('loginOverlay').style.display='flex';document.getElementById('loginErr').textContent=msg.reason||'Entry declined.';break;
case 'lobby':updateOccupiedSeats(msg.seats||[]);renderLobby(msg);if(isHost&&msg.pending){for(const p of msg.pending){if(!pendingInGame[p.id])pendingInGame[p.id]={id:p.id,name:p.name};}for(const id of Object.keys(pendingInGame)){if(!msg.pending.find(p=>p.id===id))delete pendingInGame[id];}refreshInGameJoinNotif();}break;
case 'joinRequest':if(isHost){ensureAudio();snd_joinAlert();addInGameJoinRequest(msg.id,msg.name);if(document.getElementById('lobbyOverlay').style.display!=='none'&&lastLobbyMsg){if(!lastLobbyMsg.pending.find(p=>p.id===msg.id))lastLobbyMsg.pending.push({id:msg.id,name:msg.name});renderLobby(lastLobbyMsg);}}break;
case 'winner':snd_win();hideTurnIndicator();addLog('\ud83c\udfc6 '+msg.name+' wins \u00a3'+(msg.amount/100).toFixed(2)+' \u2014 '+(msg.label||''),'log-win');showMsg('\ud83c\udfc6 '+msg.name+' wins \u00a3'+(msg.amount/100).toFixed(2)+'\n'+(msg.label||'')+'!',0);chipsFlyToWinner(msg.seat,()=>{});setTimeout(()=>showMsg(''),5500);break;
case 'gameStarting':document.getElementById('lobbyOverlay').style.display='none';document.getElementById('gameUI').style.display='block';document.getElementById('roomBadge').textContent='ROOM '+myRoomId;break;
case 'newHand':{
  seatActions={};showMsg('');setActions(false);hideTurnIndicator();
  document.getElementById('waitingMsg').style.display='none';
  handNumber++;maybeKeepAlive();
  addLog('\u2501\u2501 Hand #'+handNumber+' | Dealer: Seat '+(msg.dealerSeat+1)+' \u2501\u2501','log-hand');
  addLog('SB: Seat '+(msg.sbSeat+1)+' \u00b7 BB: Seat '+(msg.bbSeat+1));
  positionTokens(vs(msg.dealerSeat),vs(msg.sbSeat),vs(msg.bbSeat));
  const sbSeat=msg.sbSeat,bbSeat=msg.bbSeat,dealerSeat=msg.dealerSeat;
  // Rotate deal order so first card goes to player left of dealer, dealer gets last card.
  // Standard poker rule: deal starts from SB (immediately left of dealer) going clockwise.
  // Exception: heads-up (dealer=SB), deal starts from BB so dealer/SB still gets last card.
  const rawSeats=msg.activeSeats||[];
  const dealStartSeat=(dealerSeat===sbSeat)?bbSeat:sbSeat;
  const dsIdx=rawSeats.indexOf(dealStartSeat);
  const dealSeats=dsIdx>=0?[...rawSeats.slice(dsIdx),...rawSeats.slice(0,dsIdx)]:rawSeats;
  startDealAnimation(dealSeats,()=>{
    setTimeout(()=>{showBet(sbSeat,10);},120);
    setTimeout(()=>{showBet(bbSeat,20);},280);
    if(lastState)applyState(lastState);
  });break;}
case 'state':lastState=msg;if(msg.players)updateOccupiedSeats(msg.players);if(document.getElementById('gameUI').style.display==='none'&&document.getElementById('lobbyOverlay').style.display==='none'){document.getElementById('gameUI').style.display='block';if(myRoomId)document.getElementById('roomBadge').textContent='ROOM '+myRoomId;}if(!dealing)applyState(msg);break;
case 'playerAction':{
  const pname=msg.name||'Player';
  const ac=msg.action==='fold'?'FOLD':msg.action==='check'?'CHECK':msg.action==='call'?'CALL \u00a3'+((msg.amount||0)/100).toFixed(2):'RAISE \u00a3'+((msg.amount||0)/100).toFixed(2);
  seatActions[msg.seat]=ac;addLog(pname+': '+ac);
  if(msg.amount>0)showBet(msg.seat,msg.amount);
  hideTurnIndicator();if(lastState)applyState(lastState);break;}
case 'yourTurn':{
  const ca=msg.callAmt||0;
  if(msg.seat===mySeat){
    document.getElementById('callBtn').textContent=ca>0?'CALL \u00a3'+(ca/100).toFixed(2):'CHECK';
    document.getElementById('raiseAmt').value=((msg.minRaise||40)/100).toFixed(2);
    setActions(true);showMsg('\u2b50 Your turn!',0);
    document.getElementById('waitingMsg').style.display='none';
  }else{
    setActions(false);showMsg('');
    const actingPlayer=lastState&&lastState.players[msg.seat];
    const actingName=actingPlayer?actingPlayer.name:'Seat '+(msg.seat+1);
    showTurnIndicator('\u23f3 '+actingName+' is thinking\u2026');
  }break;}
case 'communityDealt':
  addLog('\u25b6 '+(msg.phase||'').toUpperCase()+': '+(msg.newCards||msg.cards||[]).map(c=>c.r+c.s).join(' '),'log-community');
  sweepBetsToPot(()=>{if(lastState)applyState(lastState);});
  break;
case 'showdown':setPhase('Showdown');hideTurnIndicator();
  sweepBetsToPot(null);
  addLog('\u2500\u2500 SHOWDOWN \u2500\u2500','log-hand');showMsg('\ud83c\udccf Showdown!',2000);break;
case 'waitingForPlayers':showMsg('\u23f3 Waiting for more players\u2026',0);hideTurnIndicator();break;
case 'playerLeft':addLog(msg.name+' left the table');addChat('\u2b05 '+msg.name+' left');seatActions[msg.seat]='';if(pendingInGame[msg.id]){delete pendingInGame[msg.id];refreshInGameJoinNotif();}if(lastState)applyState(lastState);break;
case 'sittingOut':{document.getElementById('gameUI').style.display='block';document.getElementById('lobbyOverlay').style.display='none';const wmEl=document.getElementById('waitingMsg');wmEl.textContent=msg.reason||'Sitting out\u2026';wmEl.style.display='block';break;}
case 'gamePaused':handlePaused(true,msg.byName);break;
case 'gameResumed':handlePaused(false,null);break;
case 'voluntaryAutoFoldAck':break;
case 'chat':addChat(msg.name+': '+msg.text);break;
case 'error':addChat('\u26a0 '+msg.msg);break;}}
function renderLobby(msg){lastLobbyMsg=msg;myRoomId=msg.roomId;document.getElementById('lobbyRoomId').textContent=msg.roomId;if(msg.gameActive)return;document.getElementById('loginOverlay').style.display='none';document.getElementById('waitingOverlay').style.display='none';document.getElementById('lobbyOverlay').style.display='flex';const pl=document.getElementById('playerList');pl.innerHTML='<h3 style="color:#c8a020;margin-bottom:8px">Players at table:</h3>';const seated=msg.seats.filter(Boolean);for(const s of seated){const div=document.createElement('div');div.className='player-row';div.innerHTML='<span>'+s.name+(s.id===msg.hostId?'<span class="host-badge">HOST</span>':'')+'</span><span class="chips">\u00a3'+(s.chips/100).toFixed(2)+'</span>';pl.appendChild(div);}const ps=document.getElementById('pendingSection'),pi=document.getElementById('pendingItems'),pending=msg.pending||[];if(isHost&&pending.length>0){ps.style.display='block';pi.innerHTML='';for(const p of pending){const row=document.createElement('div');row.className='pending-row';row.innerHTML='<span>'+p.name+'</span><span><button class="btn-sm btn-approve" onclick="approvePlayer(\''+p.id+'\',true)">\u2713 Admit</button><button class="btn-sm btn-reject" onclick="approvePlayer(\''+p.id+'\',false)">\u2717 Reject</button></span>';pi.appendChild(row);}}else{ps.style.display='none';}const statusEl=document.getElementById('lobbyStatus');if(isHost)statusEl.textContent=seated.length<2?'Waiting for more players to join\u2026':'Ready to start!';else statusEl.textContent='Waiting for host to start the game\u2026';const sb=document.getElementById('startBtn');if(isHost){sb.style.display='block';sb.disabled=seated.length<2;}else{sb.style.display='none';}}
function approvePlayer(id,accept){wsSend({type:'approve',id,accept});}
let pendingInGame={};
function addInGameJoinRequest(id,name){pendingInGame[id]={id,name};refreshInGameJoinNotif();}
function refreshInGameJoinNotif(){const notif=document.getElementById('joinRequestNotif'),list=document.getElementById('joinReqList'),entries=Object.values(pendingInGame);if(!entries.length||!isHost){notif.style.display='none';return;}notif.style.display='block';list.innerHTML='';for(const p of entries){const row=document.createElement('div');row.className='jr-row';row.innerHTML='<span class="jr-name">'+p.name+'</span><span class="jr-btns"><button class="jr-admit" onclick="inGameApprove(\''+p.id+'\',true)">Admit</button><button class="jr-reject" onclick="inGameApprove(\''+p.id+'\',false)">Reject</button></span>';list.appendChild(row);}}
function inGameApprove(id,accept){wsSend({type:'approve',id,accept});delete pendingInGame[id];refreshInGameJoinNotif();}
function showTurnIndicator(txt){document.getElementById('turnIndicator').textContent=txt;document.getElementById('turnIndicator').style.display='block';}
function hideTurnIndicator(){document.getElementById('turnIndicator').style.display='none';}
function setActions(v){
  ['callBtn','raiseAmt','raiseBtn','foldBtn'].forEach(id=>{
    const el=document.getElementById(id);
    if(el)el.style.display=v?'inline-flex':'none';
  });
  // raiseAmt is an input, use block/none
  const ra=document.getElementById('raiseAmt');
  if(ra)ra.style.display=v?'inline-block':'none';
}
function setPhase(p){document.getElementById('phase').textContent=p.toUpperCase();}
function showMsg(m,ms=2400){const el=document.getElementById('msg');el.textContent=m;el.style.display=m?'block':'none';if(ms>0)setTimeout(()=>el.style.display='none',ms);}
function addChat(txt){
  const log=document.getElementById('chatLog'),div=document.createElement('div');
  div.textContent=txt;log.appendChild(div);log.scrollTop=log.scrollHeight;
  while(log.children.length>60)log.removeChild(log.firstChild);
  // Flash the chat header if it's collapsed so users notice new messages
  if(chatCollapsed){
    const box=document.getElementById('chatBox');
    box.classList.remove('flash');
    void box.offsetWidth; // reflow to restart animation
    box.classList.add('flash');
    setTimeout(()=>box.classList.remove('flash'),2200);
  }
}
let handNumber=0;
let keepAliveHandCount=0;
function maybeKeepAlive(){
  keepAliveHandCount++;
  if(keepAliveHandCount%5===0){
    const ts=new Date().toLocaleTimeString('en-GB');
    fetch('/keepalive?room='+(myRoomId||'?')+'&hand='+handNumber)
      .then(r=>r.text()).then(txt=>{
        addLog('\u{1F4E1} Keep-alive sent (hand #'+handNumber+') — server: '+txt,'log-action');
      }).catch(()=>{
        addLog('\u26a0 Keep-alive failed at hand #'+handNumber,'log-action');
      });
  }
}
function addLog(txt,cls='log-action'){const log=document.getElementById('activityLog');if(!log)return;const div=document.createElement('div');div.className=cls;div.textContent=txt;log.appendChild(div);log.scrollTop=log.scrollHeight;while(log.children.length>200)log.removeChild(log.firstChild);}
let gamePaused=false;
function togglePause(){wsSend({type:gamePaused?'resume':'pause'});}
function handlePaused(isPaused,byName){
  gamePaused=isPaused;
  const btn=document.getElementById('pauseBtn');
  const banner=document.getElementById('pauseBanner');
  if(isPaused){btn.classList.add('active');btn.textContent='\u25b6 RESUME';banner.style.display='block';addLog('\u23f8 Game PAUSED by '+(byName||'a player')+' \u2014 reviewing hand history','log-hand');}
  else{btn.classList.remove('active');btn.textContent='\u23ae\u23ae PAUSE';banner.style.display='none';addLog('\u25b6 Game RESUMED','log-hand');}
}
let myAutoFold=false;
function toggleAutoFold(){
  myAutoFold=!myAutoFold;
  wsSend({type:'voluntaryAutoFold',enabled:myAutoFold});
  const btn=document.getElementById('autoFoldBtn');
  if(myAutoFold){btn.classList.add('active');btn.textContent='\u274c AUTO-FOLD ON';showMsg('\u274c Auto-fold ON \u2014 you will fold every hand until you turn it off',3200);}
  else{btn.classList.remove('active');btn.textContent='\u25b6 AUTO-FOLD';showMsg('\u2713 Auto-fold OFF \u2014 you are back in the game',2400);}
}
let activityCollapsed=true;  // start collapsed
function toggleActivityLog(){
  activityCollapsed=!activityCollapsed;
  const logEl=document.getElementById('activityLog'),toggle=document.getElementById('activityToggle');
  logEl.style.display=activityCollapsed?'none':'flex';
  toggle.textContent=activityCollapsed?'\u25b6 expand':'\u25bc collapse';
}
let chatCollapsed=true;  // start collapsed
function toggleChat(){
  chatCollapsed=!chatCollapsed;
  const inner=document.getElementById('chatInner'),toggle=document.getElementById('chatToggle');
  inner.style.display=chatCollapsed?'none':'block';
  toggle.textContent=chatCollapsed?'\u25b6 expand':'\u25bc collapse';
}
function toggleFullscreen(){if(!document.fullscreenElement){document.documentElement.requestFullscreen().catch(()=>{});}else{document.exitFullscreen();}}
function doCashOut(){
  if(!confirm('Cash out and leave the table with your remaining chips?'))return;
  wsSend({type:'cashOut'});
  setTimeout(()=>location.reload(),800);
}
document.addEventListener('fullscreenchange',()=>{document.getElementById('fsBtn').textContent=document.fullscreenElement?'\u29c4':'\u26f6';});
document.getElementById('callBtn').onclick=()=>{ensureAudio();setActions(false);showMsg('');wsSend({type:'action',action:'call'});};
document.getElementById('raiseBtn').onclick=()=>{ensureAudio();setActions(false);showMsg('');const val=Math.round(parseFloat(document.getElementById('raiseAmt').value)*100)||40;wsSend({type:'action',action:'raise',amount:val});};
document.getElementById('foldBtn').onclick=()=>{ensureAudio();setActions(false);showMsg('');wsSend({type:'action',action:'fold'});};
document.getElementById('chatInput').addEventListener('keydown',e=>{if(e.key==='Enter'){const t=e.target.value.trim();if(t){wsSend({type:'chat',text:t});e.target.value='';}}});
document.getElementById('brightSlider').oninput=(e)=>{if(spotLight)spotLight.intensity=parseFloat(e.target.value);};
document.getElementById('startBtn').onclick=()=>{wsSend({type:'startGame'});};
document.getElementById('joinBtn').onclick=()=>{const name=document.getElementById('nameInput').value.trim(),room=document.getElementById('roomInput').value.trim();if(!name){document.getElementById('loginErr').textContent='Please enter your name.';return;}if(!room){document.getElementById('loginErr').textContent='Please enter a room number.';return;}document.getElementById('loginErr').textContent='';document.getElementById('loginOverlay').style.display='none';document.getElementById('waitingOverlay').style.display='flex';document.getElementById('waitingTxt').textContent='Connecting\u2026';myRoomId=room;if(!myId){myId='p_'+Math.random().toString(36).slice(2,10);localStorage.setItem('pokerPlayerId',myId);}connectWS(name,room,myId);};
['nameInput','roomInput'].forEach(id=>{document.getElementById(id).addEventListener('keydown',e=>{if(e.key==='Enter')document.getElementById('joinBtn').click();});});
const scn=createScene();
engine.runRenderLoop(()=>scn.render());
</script>
</body>
</html>
