<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="SYFM Poker">
<meta name="mobile-web-app-capable" content="yes">
<title>SYFM Poker</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{width:100%;height:100%;overflow:hidden;background:#1a0d05;font-family:'Segoe UI',Arial,sans-serif}
#gameUI{--sat:env(safe-area-inset-top,0px);--sar:env(safe-area-inset-right,0px);--sab:env(safe-area-inset-bottom,0px);--sal:env(safe-area-inset-left,0px)}
#c{width:100%;height:100%;display:block;touch-action:none}
.overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(10,5,2,0.88);z-index:200}
.panel{background:linear-gradient(160deg,#1c0e06 0%,#2a1408 100%);border:2px solid #c8a020;border-radius:16px;padding:36px 44px;min-width:340px;max-width:480px;width:90%;text-align:center;box-shadow:0 0 60px rgba(200,160,32,0.20)}
.panel h1{color:#ffd700;font-size:2.2rem;margin-bottom:8px;letter-spacing:2px}
.panel h2{color:#ffd700;font-size:1.5rem;margin-bottom:18px}
.panel h3{color:#c8a020;font-size:1rem;margin:14px 0 8px}
.panel p{color:#c8a060;margin-bottom:14px;line-height:1.5}
.panel input[type=text],.panel input[type=number]{width:100%;padding:12px 16px;margin:8px 0;border-radius:8px;background:#0d0704;border:1px solid #6a5010;color:#ffd700;font-size:1.1rem;outline:none;text-align:center}
.panel input:focus{border-color:#c8a020}
.btn-gold{width:100%;padding:14px;margin-top:14px;border-radius:8px;border:none;background:linear-gradient(135deg,#c8a020,#8a6a08);color:#000;font-size:1.1rem;font-weight:bold;cursor:pointer;letter-spacing:1px;transition:opacity .2s}
.btn-gold:hover{opacity:.85}
.btn-gold:disabled{opacity:.4;cursor:not-allowed}
.btn-sm{padding:8px 18px;border-radius:6px;border:none;font-size:.9rem;font-weight:bold;cursor:pointer;color:#fff;margin:4px}
.btn-approve{background:#1a6a1a}
.btn-reject{background:#6a1a1a}
.player-row{display:flex;justify-content:space-between;align-items:center;background:rgba(255,255,255,0.05);border-radius:8px;padding:10px 14px;margin:6px 0;color:#e0c060;font-size:.95rem}
.player-row .chips{color:#ffd700;font-weight:bold}
.host-badge{font-size:.7rem;background:#c8a020;color:#000;padding:2px 7px;border-radius:4px;font-weight:bold;margin-left:8px}
.pending-row{display:flex;justify-content:space-between;align-items:center;background:rgba(200,160,32,0.1);border-radius:8px;padding:8px 12px;margin:4px 0;color:#e0c060}
/* ‚îÄ‚îÄ Cookie / UAT notice overlay ‚îÄ‚îÄ */
#cookieOverlay{z-index:500}
#cookieOverlay .panel{max-width:560px;text-align:left;padding:32px 36px;overflow-y:auto;max-height:92vh}
#cookieOverlay h2{text-align:center;margin-bottom:4px;font-size:1.35rem}
.cookie-subtitle{color:#e09020;font-size:.82rem;letter-spacing:1px;text-transform:uppercase;text-align:center;margin-bottom:18px;display:block}
.cookie-table{width:100%;border-collapse:collapse;margin:14px 0 6px;font-size:.85rem}
.cookie-table th{background:rgba(200,160,32,0.18);color:#ffd700;padding:7px 10px;text-align:left;border:1px solid #4a3a10;font-size:.8rem;letter-spacing:.5px}
.cookie-table td{padding:7px 10px;border:1px solid #3a2a08;color:#d0b860;vertical-align:top;line-height:1.45}
.cookie-table tr:nth-child(even) td{background:rgba(255,255,255,0.03)}
.cookie-table td:first-child{color:#ffd700;font-weight:bold;white-space:nowrap;width:36%}
.cookie-uat{margin-top:16px;padding:10px 14px;background:rgba(180,40,40,0.18);border:1px solid #8a2020;border-radius:8px;color:#e08080;font-size:.85rem;line-height:1.5;text-align:center}
.cookie-uat strong{color:#ff9090}
.cookie-btns{display:flex;gap:10px;margin-top:20px}
.cookie-btns .btn-gold{flex:1;margin-top:0;font-size:1rem;padding:12px}
.btn-deny{flex:1;padding:12px;border-radius:8px;border:1px solid #6a2020;background:linear-gradient(135deg,#4a1a1a,#2a0a0a);color:#c06060;font-size:1rem;font-weight:bold;cursor:pointer;letter-spacing:1px;transition:opacity .2s}
.btn-deny:hover{opacity:.8}
#gameUI{display:none;position:fixed;inset:0;pointer-events:none;z-index:100}
#gameUI > *{pointer-events:auto}
#topBar{position:absolute;top:calc(10px + env(safe-area-inset-top,0px));left:calc(10px + env(safe-area-inset-left,0px));right:calc(10px + env(safe-area-inset-right,0px));background:rgba(0,0,0,0.80);padding:8px 14px;border-radius:8px;color:#ffd700;display:flex;justify-content:space-between;align-items:center;gap:6px}
#phase{font-size:14px;font-weight:bold;white-space:nowrap}
#pot{font-size:17px;font-weight:bold;white-space:nowrap}
#roomBadge{font-size:12px;color:#c8a060;padding:3px 8px;background:rgba(200,160,32,0.15);border-radius:6px;white-space:nowrap}
#actionPanel{position:absolute;left:0;top:50%;transform:translateY(-50%);display:none;flex-direction:column;gap:8px;z-index:110;width:200px;padding:10px;background:rgba(0,0,0,0.92);border-radius:0 16px 16px 0;border-right:2px solid #c8a020;border-top:1px solid #6a5010;border-bottom:1px solid #6a5010}
.abtn{padding:12px 8px;border-radius:8px;border:none;font-size:15px;font-weight:bold;cursor:pointer;color:#fff;width:100%;text-align:center;-webkit-tap-highlight-color:transparent;letter-spacing:0.5px}
.abtn-call{background:#1a7a1a;border-bottom:3px solid #0a4a0a}
.abtn-raise{background:#7a5800;border-bottom:3px solid #4a3000}
.abtn-allin{background:#8a7a00;border-bottom:3px solid #5a4a00;color:#ffe040}
.abtn-fold{background:#7a1a1a;border-bottom:3px solid #4a0a0a}
#drumWidget{width:100%;display:none;flex-direction:column;gap:3px;align-items:center}
.drum-row{display:flex;gap:6px;justify-content:center;width:100%}
.drum{display:flex;flex-direction:column;align-items:center;gap:2px;flex:1}
.drum-label{font-size:9px;color:#c8a060;text-align:center;letter-spacing:1px;text-transform:uppercase}
.drum-track{background:rgba(0,0,0,0.75);border:1px solid #6a5010;border-radius:8px;overflow:hidden;width:100%;position:relative;height:96px;cursor:pointer;user-select:none;touch-action:none}
.drum-track::before,.drum-track::after{content:'';position:absolute;left:0;right:0;height:28px;z-index:2;pointer-events:none}
.drum-track::before{top:0;background:linear-gradient(to bottom,rgba(0,0,0,0.82),transparent)}
.drum-track::after{bottom:0;background:linear-gradient(to top,rgba(0,0,0,0.82),transparent)}
.drum-highlight{position:absolute;top:50%;transform:translateY(-50%);left:0;right:0;height:32px;border-top:1px solid #c8a020;border-bottom:1px solid #c8a020;pointer-events:none;z-index:1}
.drum-inner{position:absolute;width:100%}
.drum-item{height:32px;display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:bold;color:#a08040}
.drum-item.sel{color:#ffd700;font-size:22px}
.drum-arrow{background:rgba(255,255,255,0.08);border:none;color:#e0c060;font-size:24px;cursor:pointer;padding:7px 0;width:100%;text-align:center;line-height:1;-webkit-tap-highlight-color:transparent;border-radius:5px}
.drum-arrow:active{background:rgba(200,160,32,0.3);color:#ffd700}
#tableSlider{position:absolute;right:calc(8px + env(safe-area-inset-right,0px));top:50%;transform:translateY(-50%);z-index:110;display:flex;flex-direction:column;align-items:center;gap:4px;background:rgba(0,0,0,0.6);border-radius:20px;padding:10px 7px;border:1px solid rgba(200,160,32,0.35)}
#tableSlider label{font-size:11px;color:#c8a060}
#tablePan{writing-mode:vertical-lr;direction:rtl;-webkit-appearance:slider-vertical;appearance:slider-vertical;width:36px;height:130px;cursor:pointer;accent-color:#c8a020}
#tablePan::-webkit-slider-thumb{-webkit-appearance:none;width:32px;height:32px;border-radius:50%;background:#c8a020;border:3px solid #fff;box-shadow:0 0 6px rgba(0,0,0,0.6);cursor:pointer}
#tablePan::-moz-range-thumb{width:32px;height:32px;border-radius:50%;background:#c8a020;border:3px solid #fff;box-shadow:0 0 6px rgba(0,0,0,0.6);cursor:pointer}
#bottomBar{position:absolute;bottom:calc(52px + env(safe-area-inset-bottom,0px));left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.88);padding:6px 20px;border-radius:10px;border:1px solid #6a5010;color:#c8a820;text-align:center;z-index:111;white-space:nowrap;pointer-events:none;box-shadow:0 2px 12px rgba(0,0,0,0.6)}
#myInfo{font-size:14px;font-weight:bold;color:#ffd700;line-height:1.5;letter-spacing:0.5px}

/* ‚îÄ‚îÄ FIX #1: Fullscreen button ‚Äî shown on ALL platforms including Android.
   Only hidden on iOS (which doesn't support the Fullscreen API at all).    ‚îÄ‚îÄ */
#controlBar{position:absolute;bottom:calc(10px + env(safe-area-inset-bottom,0px));right:calc(10px + env(safe-area-inset-right,0px));display:flex;flex-direction:row;gap:5px;align-items:center;z-index:112}
.cbtn-pause{padding:9px 13px;border-radius:6px;border:none;font-size:18px;line-height:1;cursor:pointer;color:#fff;background:#1a4a7a}
.cbtn-pause.active{background:#c87020;box-shadow:0 0 8px rgba(200,120,32,0.7)}
.cbtn-cashout{padding:9px 11px;border-radius:6px;border:1px solid #c8a020;font-size:12px;font-weight:bold;cursor:pointer;color:#fff;background:#4a2a00;white-space:nowrap}
.cbtn-cashout.pending{background:#6a1a00;border-color:#ff6040;animation:pulse 1.2s ease-in-out infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.65}}
.cbtn-autofold{padding:9px 11px;border-radius:6px;border:none;font-size:12px;font-weight:bold;cursor:pointer;color:#fff;background:#3a1a5a;white-space:nowrap;-webkit-tap-highlight-color:transparent}
.cbtn-autofold.active{background:#8a10cc;box-shadow:0 0 10px rgba(180,60,255,0.7)}
/* FIX #1: Show fullscreen button everywhere except iOS Safari (no API support) */
.cbtn-fs{padding:9px 11px;border-radius:6px;border:none;font-size:14px;cursor:pointer;color:#c8a060;background:rgba(0,0,0,0.65);-webkit-tap-highlight-color:transparent;display:block}
/* Hide only on iOS Safari using the -webkit-touch-callout trick */
@supports (-webkit-touch-callout:none) and (not (display:-webkit-box)){
  /* This targets iOS Safari specifically */
  .cbtn-fs{display:none!important}
}

#myCountdown{position:absolute;bottom:calc(10px + env(safe-area-inset-bottom,0px));left:calc(10px + env(safe-area-inset-left,0px));display:none;z-index:111;pointer-events:none}
#myCountdown svg{filter:drop-shadow(0 0 4px rgba(0,0,0,0.8))}
#myCountdownNum{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:16px;font-weight:bold;color:#ffd700;text-shadow:0 1px 3px rgba(0,0,0,1)}
#msg{position:absolute;top:70px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.92);padding:14px 28px;border-radius:12px;color:#fff;font-size:18px;font-weight:bold;text-align:center;display:none;border:1px solid #c8a020;max-width:80%;white-space:pre-line;pointer-events:none}
#sideBoxes{position:absolute;top:58px;right:10px;display:flex;flex-direction:column;gap:6px;width:220px}
#chatBox{background:rgba(0,0,0,0.82);border-radius:8px;border:1px solid #3a2a10;overflow:hidden}
#chatBox.flash #chatHeader{animation:chatFlash 0.6s ease 3}
@keyframes chatFlash{0%{background:transparent}50%{background:rgba(200,160,32,0.35)}100%{background:transparent}}
#chatHeader{display:flex;justify-content:space-between;align-items:center;padding:7px 10px;cursor:pointer;color:#c8a060;font-size:11px;font-weight:bold;user-select:none}
#chatHeader span{color:#a09060;font-size:10px}
#chatInner{padding:0 8px 8px;border-top:1px solid #3a2a10;display:none}
#chatLog{height:90px;overflow-y:auto;font-size:11px;color:#c8c8a0;margin-bottom:5px;display:flex;flex-direction:column;gap:2px}
#chatInput{width:100%;padding:5px 8px;border-radius:4px;border:1px solid #4a3a15;background:rgba(0,0,0,0.7);color:#ffd700;font-size:11px}
#activityBox{background:rgba(0,0,0,0.82);border-radius:8px;border:1px solid #2a3a1a;overflow:hidden}
#activityHeader{display:flex;justify-content:space-between;align-items:center;padding:7px 10px;cursor:pointer;color:#60c840;font-size:11px;font-weight:bold;user-select:none}
#activityHeader span{color:#a0d070;font-size:10px}
#activityLog{height:160px;overflow-y:auto;font-size:10px;color:#b0d890;padding:4px 8px 6px;display:none;flex-direction:column;gap:2px;border-top:1px solid #1a2a10}
#activityLog .log-hand{color:#ffd700;font-weight:bold;margin-top:3px}
#activityLog .log-action{color:#90c870}
#activityLog .log-win{color:#40e870;font-weight:bold}
#activityLog .log-community{color:#a0b8ff}
#activityLog .log-fold{color:#e07050}
#activityLog .log-system{color:#c8a060;font-style:italic}
#waitingMsg{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.88);padding:20px 32px;border-radius:14px;color:#c8a020;font-size:16px;text-align:center;display:none;border:1px solid #6a5010;pointer-events:none}
#joinRequestNotif{position:absolute;top:58px;right:240px;background:rgba(10,40,10,0.95);padding:12px 14px;border-radius:10px;color:#e0e0e0;font-size:13px;display:none;border:1px solid #20a040;min-width:200px;z-index:10}
#joinRequestNotif h4{color:#40e060;margin-bottom:6px;font-size:14px}
#joinReqList{display:flex;flex-direction:column;gap:5px}
.jr-row{display:flex;justify-content:space-between;align-items:center;background:rgba(255,255,255,0.07);padding:5px 8px;border-radius:6px}
.jr-name{color:#ffd700;font-weight:bold;font-size:12px}
.jr-btns{display:flex;gap:4px}
.jr-admit{background:#1a6a1a;border:none;color:#fff;padding:3px 8px;border-radius:4px;cursor:pointer;font-size:11px;font-weight:bold}
.jr-reject{background:#6a1a1a;border:none;color:#fff;padding:3px 8px;border-radius:4px;cursor:pointer;font-size:11px;font-weight:bold}
#turnIndicator{position:absolute;bottom:52px;left:120px;color:#ffd700;font-size:13px;font-weight:bold;pointer-events:none;text-shadow:0 0 8px rgba(0,0,0,0.9);display:none;background:rgba(0,0,0,0.80);padding:6px 14px;border-radius:8px;border:1px solid #6a5010;max-width:240px;word-wrap:break-word}
#spectatorBanner{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.88);padding:16px 32px;border-radius:14px;color:#c8a020;font-size:16px;text-align:center;display:none;border:1px solid #6a5010;pointer-events:none;z-index:50}
#pauseBanner{position:absolute;top:0;left:0;right:0;bottom:0;display:none;pointer-events:none;z-index:50}
#pauseBanner::after{content:'PAUSED \2014 any player can resume';position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:rgba(255,200,0,0.25);font-size:clamp(20px,3.5vw,52px);font-weight:bold;letter-spacing:3px;white-space:nowrap;pointer-events:none}
</style>
</head>
<body>
<canvas id="c"></canvas>
<!-- ‚îÄ‚îÄ Cookie & UAT Notice ‚Äî must be accepted before login screen shows ‚îÄ‚îÄ -->
<div id="cookieOverlay" class="overlay">
  <div class="panel">
    <h2>üç™ Cookie Notice</h2>
    <span class="cookie-subtitle">Please read before continuing</span>
    <p style="color:#c8a060;font-size:.9rem;line-height:1.6;margin-bottom:4px">
      Whilst no cookies are deliberately created to track you or your behaviour,
      the following data is stored locally and on our server for the purposes of
      playing this game online:
    </p>
    <table class="cookie-table">
      <thead>
        <tr><th>Feature</th><th>How it's handled</th></tr>
      </thead>
      <tbody>
        <tr>
          <td>User Identity</td>
          <td>Generated as a random string and saved in Local Storage.</td>
        </tr>
        <tr>
          <td>Session Tracking</td>
          <td>Handled by a persistent WebSocket connection (ws).</td>
        </tr>
        <tr>
          <td>Game History</td>
          <td>Written to text files on the server disk and uploaded via FTP. This is used during development for debug purposes.</td>
        </tr>
        <tr>
          <td>Reconnection</td>
          <td>The client reads the ID from Local Storage and sends it to the server to &ldquo;resume&rdquo; their seat.</td>
        </tr>
      </tbody>
    </table>
    <div class="cookie-uat">
      ‚ö†Ô∏è <strong>Development &amp; UAT Notice</strong><br>
      This game is in development and UAT.<br>
      You should <strong>never</strong> bet any real money using this game.
    </div>
    <div class="cookie-btns">
      <button class="btn-gold" onclick="cookieAccept()">‚úÖ Accept &amp; Continue</button>
      <button class="btn-deny" onclick="cookieDeny()">‚úñ Deny</button>
    </div>
  </div>
</div>

<div id="loginOverlay" class="overlay" style="display:none">
  <div class="panel">
    <svg width="72" height="72" viewBox="0 0 72 72" xmlns="http://www.w3.org/2000/svg" style="margin-bottom:8px">
      <circle cx="36" cy="36" r="34" fill="#1a1a1a" stroke="#c8a020" stroke-width="4"/>
      <g opacity="0.9">
        <path d="M36 2 A34 34 0 0 1 62.4 19" stroke="#c8a020" stroke-width="8" fill="none" stroke-linecap="butt"/>
        <path d="M62.4 19 A34 34 0 0 1 68.8 47" stroke="#2a1408" stroke-width="8" fill="none" stroke-linecap="butt"/>
        <path d="M68.8 47 A34 34 0 0 1 50 66.5" stroke="#c8a020" stroke-width="8" fill="none" stroke-linecap="butt"/>
        <path d="M50 66.5 A34 34 0 0 1 22 66.5" stroke="#2a1408" stroke-width="8" fill="none" stroke-linecap="butt"/>
        <path d="M22 66.5 A34 34 0 0 1 3.2 47" stroke="#c8a020" stroke-width="8" fill="none" stroke-linecap="butt"/>
        <path d="M3.2 47 A34 34 0 0 1 9.6 19" stroke="#2a1408" stroke-width="8" fill="none" stroke-linecap="butt"/>
        <path d="M9.6 19 A34 34 0 0 1 36 2" stroke="#c8a020" stroke-width="8" fill="none" stroke-linecap="butt"/>
      </g>
      <circle cx="36" cy="36" r="24" fill="#1c0e06" stroke="#c8a020" stroke-width="2.5"/>
      <circle cx="36" cy="36" r="20" fill="none" stroke="rgba(200,160,32,0.3)" stroke-width="1"/>
      <text x="36" y="40" font-family="Arial" font-weight="bold" font-size="9" fill="#ffd700" text-anchor="middle">SYFM</text>
    </svg>
    <h1 style="font-size:2.4rem;letter-spacing:4px;margin-bottom:4px">SYFM</h1>
    <div style="color:#c8a060;font-size:0.95rem;letter-spacing:6px;margin-bottom:18px;text-transform:uppercase">Poker</div>
    <p>Enter your name and a room number to play</p>
    <input type="text" id="nameInput" placeholder="Your name" maxlength="18" autocomplete="off">
    <input type="number" id="roomInput" placeholder="Room number (e.g. 1234)" min="1" max="999999">
    <button class="btn-gold" id="joinBtn">JOIN ROOM</button>
    <p id="loginErr" style="color:#e05050;margin-top:10px;font-size:.9rem"></p>
  </div>
</div>

<!-- Buy-back offer overlay ‚Äî FIX #5: works for any player count -->
<div id="buyBackOverlay" class="overlay" style="display:none">
  <div class="panel">
    <h2>üí∏ Out of Chips!</h2>
    <p id="buyBackMsg">You've run out of chips. Buy back in for <strong>¬£10.00</strong>?</p>
    <p style="color:#e09020;font-size:22px;font-weight:bold;margin:4px 0">‚è± <span id="buyBackTimer">15</span>s</p>
    <button class="btn-gold" onclick="respondBuyBack(true)">‚úÖ BUY BACK IN ‚Äî ¬£10.00</button>
    <button class="btn-gold" style="background:linear-gradient(135deg,#6a1a1a,#3a0a0a);margin-top:8px" onclick="respondBuyBack(false)">üëÄ Watch as Spectator</button>
  </div>
</div>

<div id="waitingOverlay" class="overlay" style="display:none">
  <div class="panel">
    <h2>&#9203; Waiting for host&hellip;</h2>
    <p id="waitingTxt">The host will approve your entry shortly.</p>
    <button class="btn-gold" onclick="location.reload()" style="margin-top:10px">Cancel</button>
  </div>
</div>
<div id="lobbyOverlay" class="overlay" style="display:none">
  <div class="panel">
    <h2>&#127920; Room <span id="lobbyRoomId"></span></h2>
    <div id="playerList"></div>
    <div id="pendingSection" style="display:none">
      <h3>&#9203; Requesting to join:</h3>
      <div id="pendingItems"></div>
    </div>
    <p id="lobbyStatus" style="color:#c8a060;margin-top:14px;font-size:.9rem"></p>
    <button class="btn-gold" id="startBtn" style="display:none;margin-top:18px">&#9654; START GAME</button>
  </div>
</div>
<div id="gameUI">
  <div id="topBar">
    <div id="phase">PRE-FLOP</div>
    <div id="pot">POT: &pound;0.00</div>
    <div id="myNameBadge" style="font-size:12px;color:#80cfff;padding:3px 8px;background:rgba(0,80,160,0.25);border-radius:6px;white-space:nowrap"></div>
    <div id="roomBadge">ROOM &mdash;</div>
  </div>
  <div id="actionPanel">
    <!-- FIX #4: callBtn text set dynamically ‚Äî "CHECK" when no bet to call -->
    <button class="abtn abtn-call" id="callBtn" style="display:none">CHECK</button>
    <!-- Drum wheels sit under the CHECK button, above the raise/bet button -->
    <div id="drumWidget">
      <div class="drum-row">
        <div class="drum">
          <div class="drum-label">¬£</div>
          <div class="drum-track" id="drumPounds">
            <div class="drum-highlight"></div>
            <div class="drum-inner" id="drumPoundsInner"></div>
          </div>
          <button class="drum-arrow" onclick="drumStep('pounds',1)">‚ñº</button>
        </div>
        <div class="drum">
          <div class="drum-label">20p</div>
          <div class="drum-track" id="drumPence">
            <div class="drum-highlight"></div>
            <div class="drum-inner" id="drumPenceInner"></div>
          </div>
          <button class="drum-arrow" onclick="drumStep('pence',1)">‚ñº</button>
        </div>
      </div>
    </div>
    <!-- Raise/Bet label is set dynamically inside the button via updateDisplay() -->
    <button class="abtn abtn-raise" id="raiseBtn" style="display:none">BET ¬£0.40</button>
    <!-- ALL IN button ‚Äî always bets the player's entire stack -->
    <button class="abtn abtn-allin" id="allInBtn" style="display:none">ALL IN</button>
    <button class="abtn abtn-fold" id="foldBtn" style="display:none">FOLD</button>
  </div>
  <div id="drumOverlay" style="display:none"></div>
  <div id="bottomBar">
    <div id="myInfo">Stack ¬£10.00</div>
  </div>
  <div id="tableSlider">
    <label>‚ñ≤</label>
    <input type="range" id="tablePan" min="-3" max="3" step="0.1" value="0.5">
    <label>‚ñº</label>
  </div>
  <!-- FIX #1: Fullscreen button ‚Äî no longer unconditionally hidden on touch devices.
       CSS now only hides it on iOS Safari (which lacks the Fullscreen API).
       Android Chrome supports fullscreen fine and will show the button.       -->
  <div id="controlBar">
    <button class="cbtn-pause" id="pauseBtn" onclick="togglePause()">‚è∏</button>
    <button class="cbtn-cashout" id="cashOutBtn" onclick="doCashOut()">CASH OUT</button>
    <button class="cbtn-autofold" id="autoFoldBtn" onclick="toggleAutoFold()">AUTO-FOLD</button>
    <button class="cbtn-fs" id="fsBtn" onclick="toggleFullscreen()" title="Fullscreen">‚õ∂</button>
  </div>
  <div id="pauseBanner"></div>
  <div id="spectatorBanner">üëÄ You are spectating ‚Äî no cards will be dealt to you</div>
  <div id="msg"></div>
  <div id="waitingMsg"></div>
  <div id="myCountdown">
    <svg width="52" height="52" viewBox="0 0 52 52">
      <circle cx="26" cy="26" r="22" fill="rgba(0,0,0,0.7)" stroke="#333" stroke-width="3"/>
      <circle id="myCountdownRing" cx="26" cy="26" r="22" fill="none" stroke="#c8a020" stroke-width="4"
        stroke-dasharray="138.2" stroke-dashoffset="0" stroke-linecap="round"
        transform="rotate(-90 26 26)"/>
    </svg>
    <div id="myCountdownNum">30</div>
  </div>
  <div id="joinRequestNotif">
    <h4>&#9203; Players want to join</h4>
    <div id="joinReqList"></div>
  </div>
  <div id="turnIndicator"></div>
  <div id="sideBoxes">
    <div id="chatBox">
      <div id="chatHeader" onclick="toggleChat()">&#128172; CHAT <span id="chatToggle">&#9654; expand</span></div>
      <div id="chatInner">
        <div id="chatLog"></div>
        <input type="text" id="chatInput" placeholder="Type and press Enter&hellip;" maxlength="100">
      </div>
    </div>
    <div id="activityBox">
      <div id="activityHeader" onclick="toggleActivityLog()">&#128203; LOG <span id="activityToggle">&#9654; expand</span></div>
      <div id="activityLog"></div>
    </div>
  </div>
</div>
<script src="https://cdn.babylonjs.com/babylon.js"></script>
<script>
'use strict';
let audioCtx;
function ensureAudio(){if(!audioCtx)audioCtx=new(window.AudioContext||window.webkitAudioContext)();}
function snd_deal(){ensureAudio();const t=audioCtx.currentTime,len=Math.floor(audioCtx.sampleRate*0.12),buf=audioCtx.createBuffer(1,len,audioCtx.sampleRate),d=buf.getChannelData(0);for(let i=0;i<len;i++)d[i]=(Math.random()*2-1)*Math.pow(Math.sin(Math.PI*i/len),0.6);const src=audioCtx.createBufferSource(),bp=audioCtx.createBiquadFilter();bp.type='bandpass';bp.Q.value=0.6;bp.frequency.setValueAtTime(4200,t);bp.frequency.exponentialRampToValueAtTime(1600,t+0.12);const g=audioCtx.createGain();g.gain.setValueAtTime(0,t);g.gain.linearRampToValueAtTime(0.28,t+0.015);g.gain.exponentialRampToValueAtTime(0.001,t+0.12);src.buffer=buf;src.connect(bp);bp.connect(g);g.connect(audioCtx.destination);src.start(t);}
function snd_flip(){ensureAudio();const t=audioCtx.currentTime,b=audioCtx.createBuffer(1,Math.floor(audioCtx.sampleRate*0.055),audioCtx.sampleRate),d=b.getChannelData(0);for(let i=0;i<d.length;i++)d[i]=(Math.random()*2-1)*Math.pow(1-i/d.length,1.6);const src=audioCtx.createBufferSource(),g=audioCtx.createGain(),hp=audioCtx.createBiquadFilter();hp.type='highpass';hp.frequency.value=2200;g.gain.setValueAtTime(0.32,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.055);src.buffer=b;src.connect(hp);hp.connect(g);g.connect(audioCtx.destination);src.start(t);}
function snd_chip(){ensureAudio();const t=audioCtx.currentTime,base=1600+Math.random()*500;[[1.0,0.16],[1.52,0.09],[2.51,0.05],[3.97,0.025]].forEach(([r,v])=>{const osc=audioCtx.createOscillator(),g=audioCtx.createGain();osc.type='sine';osc.frequency.value=base*r*(0.97+Math.random()*0.06);g.gain.setValueAtTime(v,t);g.gain.exponentialRampToValueAtTime(0.0001,t+0.09+r*0.022);osc.connect(g);g.connect(audioCtx.destination);osc.start(t);osc.stop(t+0.14);});}
function snd_win(){ensureAudio();const t=audioCtx.currentTime;[523,659,784,1047,1319].forEach((f,i)=>{const o=audioCtx.createOscillator(),g=audioCtx.createGain();o.type='triangle';o.frequency.value=f;g.gain.setValueAtTime(0,t+i*0.10);g.gain.linearRampToValueAtTime(0.12,t+i*0.10+0.04);g.gain.exponentialRampToValueAtTime(0.001,t+i*0.10+0.55);o.connect(g);g.connect(audioCtx.destination);o.start(t+i*0.10);o.stop(t+i*0.10+0.6);});}
function snd_joinAlert(){ensureAudio();const t=audioCtx.currentTime;[[0,880],[0.22,1100]].forEach(([delay,freq])=>{const o=audioCtx.createOscillator(),g=audioCtx.createGain();o.type='sine';o.frequency.setValueAtTime(freq*0.8,t+delay);o.frequency.linearRampToValueAtTime(freq,t+delay+0.12);g.gain.setValueAtTime(0,t+delay);g.gain.linearRampToValueAtTime(0.28,t+delay+0.04);g.gain.exponentialRampToValueAtTime(0.001,t+delay+0.28);o.connect(g);g.connect(audioCtx.destination);o.start(t+delay);o.stop(t+delay+0.3);});}
const SUITS=['\u2660','\u2665','\u2666','\u2663'],RANKS=['2','3','4','5','6','7','8','9','10','J','Q','K','A'];
const NP=9,BB=20,TRX=5.4,TRZ=3.5,SRX=7.0,SRZ=5.2;
let myId=localStorage.getItem('pokerPlayerId')||null,myName=localStorage.getItem('pokerPlayerName')||null,mySeat=0,isHost=false,myRoomId=localStorage.getItem('pokerRoomId')||null,ws=null,lastState=null,lastLobbyMsg=null,dealing=false;
let occupiedSeats=[];
function updateOccupiedSeats(seats){
  occupiedSeats=seats.map((s,i)=>s?i:null).filter(i=>i!==null);
}
function vs(serverSeat){
  if(occupiedSeats.length===0)return(serverSeat-mySeat+NP)%NP;
  const myIdx=occupiedSeats.indexOf(mySeat);
  const seatIdx=occupiedSeats.indexOf(serverSeat);
  if(seatIdx===-1)return 0;
  const n=occupiedSeats.length;
  return(seatIdx-myIdx+n)%n;
}
function numVisualSeats(){return Math.max(occupiedSeats.length,2);}
const canvas=document.getElementById('c');
const engine=new BABYLON.Engine(canvas,true);
window.addEventListener('resize',()=>engine.resize());
canvas.addEventListener('click',()=>ensureAudio(),{once:true});
let scene,cam,spotLight,shadowGen,cardBackMat,cardFrontMats={},cardPool=[],cardIdx=0,chipPool=[],potChips=[],seatBetChips=Array.from({length:NP},()=>[]),playerLabels=[],seatCardMeshes=Array.from({length:NP},()=>[null,null]),communityCardMeshes=[],dealerToken=null,sbToken=null,bbToken=null,highlightLayer=null,_cardPulseTimer=null;
const POT_BASE=new BABYLON.Vector3(0.2,0.32,-1.90);
function betPos(vSeat){const n=numVisualSeats();const a=-Math.PI/2-(vSeat/n)*Math.PI*2,rx=TRX*0.46,rz=TRZ*0.46;return new BABYLON.Vector3(Math.cos(a)*rx,0.32,Math.sin(a)*rz);}
function seatPos(i){const n=numVisualSeats();const a=-Math.PI/2-(i/n)*Math.PI*2;return new BABYLON.Vector3(Math.cos(a)*SRX,0.26,Math.sin(a)*SRZ);}
function cardPos(si,cn){
  const n=numVisualSeats();
  const a=-Math.PI/2-(si/n)*Math.PI*2;
  const rx=TRX*0.70,rz=TRZ*0.70;
  const pa=a+Math.PI/2;
  const off=(cn===0?-0.72:0.72);
  return new BABYLON.Vector3(
    Math.cos(a)*rx+Math.cos(pa)*off,
    0.40+cn*0.018,
    Math.sin(a)*rz+Math.sin(pa)*off
  );
}
function cardPosOther(si,cn){
  const n=numVisualSeats();
  const a=-Math.PI/2-(si/n)*Math.PI*2;
  const rx=SRX*0.78,rz=SRZ*0.78;
  const pa=a+Math.PI/2;
  const off=(cn===0?-0.42:0.42);
  return new BABYLON.Vector3(
    Math.cos(a)*rx+Math.cos(pa)*off,
    1.72,
    Math.sin(a)*rz+Math.sin(pa)*off
  );
}
const DECK_POS=()=>new BABYLON.Vector3(-TRX*0.76,0.42,0);
const COM_POS=[new BABYLON.Vector3(-2.84,0.55,0.55),new BABYLON.Vector3(-1.42,0.55,0.55),new BABYLON.Vector3(0.00,0.55,0.55),new BABYLON.Vector3(1.42,0.55,0.55),new BABYLON.Vector3(2.84,0.55,0.55)];
function mkBackTex(){
  const W=512,H=768;
  const tex=new BABYLON.DynamicTexture('bt',{width:W,height:H},scene,true);
  const c=tex.getContext();
  const g=c.createLinearGradient(0,0,W,H);
  g.addColorStop(0,'#0b1850');g.addColorStop(1,'#060c2a');
  c.fillStyle=g;c.fillRect(0,0,W,H);
  c.strokeStyle='#c8a020';c.lineWidth=14;c.strokeRect(7,7,W-14,H-14);
  c.strokeStyle='rgba(200,160,32,0.55)';c.lineWidth=3;c.strokeRect(24,24,W-48,H-48);
  c.strokeStyle='rgba(200,160,32,0.10)';c.lineWidth=1;
  for(let x=-H;x<W+H;x+=20){
    c.beginPath();c.moveTo(x,0);c.lineTo(x+H,H);c.stroke();
    c.beginPath();c.moveTo(x+H,0);c.lineTo(x,H);c.stroke();
  }
  c.fillStyle='rgba(200,160,32,0.82)';
  c.font='bold 118px Arial';
  c.textAlign='center';c.textBaseline='middle';
  c.fillText('SYFM',W/2,H/2);
  c.font='bold 36px Arial';
  c.fillStyle='rgba(200,160,32,0.55)';
  c.textAlign='left';c.textBaseline='top';
  c.fillText('SYFM',34,34);
  c.save();c.translate(W,H);c.rotate(Math.PI);
  c.textAlign='left';c.textBaseline='top';
  c.fillText('SYFM',34,34);
  c.restore();
  tex.update();return tex;
}
function mkFrontTex(suit,rank){
  const W=512,H=768;
  const tex=new BABYLON.DynamicTexture('ft'+rank+suit,{width:W,height:H},scene,true);
  const c=tex.getContext();
  const isRed=suit==='\u2665'||suit==='\u2666';
  const col=isRed?'#cc0000':'#111111';
  const suitNames={'\u2660':'SPADES','\u2665':'HEARTS','\u2666':'DIAMONDS','\u2663':'CLUBS'};
  const suitName=suitNames[suit]||'';
  c.fillStyle='#fafafa';c.fillRect(0,0,W,H);
  c.strokeStyle='rgba(80,80,80,0.18)';c.lineWidth=3;c.strokeRect(2,2,W-4,H-4);
  const BX=30,BY=30,BW=W-60,BH=H-60;
  const rnkSz=rank==='10'?88:100;
  const cPipSz=64;
  const cx=16,cy=14;
  c.fillStyle=col;
  c.textAlign='left';c.textBaseline='top';
  c.font='bold '+rnkSz+'px Arial';c.fillText(rank,cx,cy);
  c.font=cPipSz+'px Arial';c.fillText(suit,cx+2,cy+rnkSz+2);
  c.textAlign='right';c.textBaseline='top';
  c.font='bold '+rnkSz+'px Arial';c.fillText(rank,W-cx,cy);
  c.font=cPipSz+'px Arial';c.fillText(suit,W-cx-2,cy+rnkSz+2);
  c.save();c.translate(W,H);c.rotate(Math.PI);
  c.textAlign='left';c.textBaseline='top';
  c.font='bold '+rnkSz+'px Arial';c.fillText(rank,cx,cy);
  c.font=cPipSz+'px Arial';c.fillText(suit,cx+2,cy+rnkSz+2);
  c.textAlign='right';
  c.font='bold '+rnkSz+'px Arial';c.fillText(rank,W-cx,cy);
  c.font=cPipSz+'px Arial';c.fillText(suit,W-cx-2,cy+rnkSz+2);
  c.restore();
  c.fillStyle=col;
  c.font='bold 30px Arial';c.textAlign='center';c.textBaseline='top';
  c.fillText(suitName,W/2,BY+8);
  const pipTop=BY+52;
  const pipBot=H-BY-52;
  const pipH=pipBot-pipTop;
  const pipLeft=BX+32;
  const pipRight=W-BX-32;
  const pipW=pipRight-pipLeft;
  const L={
    '2': [[0.5,0.12,false],[0.5,0.88,true]],
    '3': [[0.5,0.12,false],[0.5,0.5,false],[0.5,0.88,true]],
    '4': [[0.2,0.12,false],[0.8,0.12,false],[0.2,0.88,true],[0.8,0.88,true]],
    '5': [[0.2,0.12,false],[0.8,0.12,false],[0.5,0.5,false],[0.2,0.88,true],[0.8,0.88,true]],
    '6': [[0.2,0.12,false],[0.8,0.12,false],[0.2,0.5,false],[0.8,0.5,true],[0.2,0.88,true],[0.8,0.88,true]],
    '7': [[0.2,0.12,false],[0.8,0.12,false],[0.5,0.31,false],[0.2,0.5,false],[0.8,0.5,true],[0.2,0.88,true],[0.8,0.88,true]],
    '8': [[0.2,0.10,false],[0.8,0.10,false],[0.5,0.30,false],[0.2,0.50,false],[0.8,0.50,true],[0.5,0.68,true],[0.2,0.88,true],[0.8,0.88,true]],
    '9': [[0.2,0.10,false],[0.8,0.10,false],[0.2,0.34,false],[0.8,0.34,false],[0.5,0.50,false],[0.2,0.66,true],[0.8,0.66,true],[0.2,0.90,true],[0.8,0.90,true]],
    '10':[[0.2,0.10,false],[0.8,0.10,false],[0.5,0.26,false],[0.2,0.40,false],[0.8,0.40,false],[0.2,0.60,true],[0.8,0.60,true],[0.5,0.74,true],[0.2,0.90,true],[0.8,0.90,true]]
  };
  const pSzMap={'A':190,'2':120,'3':112,'4':108,'5':102,'6':96,'7':90,'8':84,'9':78,'10':74};
  const pSz=pSzMap[rank]||90;
  if(rank==='A'){
    c.font=pSz+'px Arial';c.textAlign='center';c.textBaseline='middle';
    c.fillStyle=col;c.fillText(suit,W/2,pipTop+pipH*0.5);
  }else if(['J','Q','K'].includes(rank)){
    c.fillStyle=col;
    c.font='bold 260px Arial';
    c.textAlign='center';c.textBaseline='middle';
    c.fillText(rank,W/2,H*0.52);
    c.font='100px Arial';
    c.fillText(suit,W/2,H*0.78);
  }else{
    const pips=L[rank]||[];
    c.fillStyle=col;
    for(const [fx,fy,flip] of pips){
      const px=pipLeft+fx*pipW;
      const py=pipTop+fy*pipH;
      if(flip){
        c.save();c.translate(px,py);c.rotate(Math.PI);
        c.font=pSz+'px Arial';c.textAlign='center';c.textBaseline='middle';
        c.fillText(suit,0,0);
        c.restore();
      }else{
        c.font=pSz+'px Arial';c.textAlign='center';c.textBaseline='middle';
        c.fillText(suit,px,py);
      }
    }
  }
  if(rank==='6'||rank==='9'){
    const word=rank==='6'?'SIX':'NINE';
    c.fillStyle=col+'66';
    c.font='bold 26px Arial';c.textAlign='center';c.textBaseline='bottom';
    c.fillText(word,W/2,H-BY-10);
  }
  tex.update();return tex;
}
let cardFoldedMat=null;
function buildCardMats(){cardBackMat=new BABYLON.StandardMaterial('back',scene);cardBackMat.diffuseTexture=mkBackTex();cardBackMat.specularColor=new BABYLON.Color3(0.1,0.1,0.1);cardBackMat.specularPower=30;cardBackMat.backFaceCulling=false;
  cardFoldedMat=new BABYLON.StandardMaterial('folded',scene);
  const fTex=new BABYLON.DynamicTexture('foldedTex',{width:64,height:64},scene,false);
  const fc=fTex.getContext();fc.fillStyle='#555';fc.fillRect(0,0,64,64);fTex.update();
  cardFoldedMat.diffuseTexture=fTex;cardFoldedMat.diffuseColor=new BABYLON.Color3(0.45,0.45,0.45);
  cardFoldedMat.specularColor=new BABYLON.Color3(0,0,0);cardFoldedMat.alpha=0.55;cardFoldedMat.backFaceCulling=false;
  for(const s of SUITS)for(const r of RANKS){const k=r+s,m=new BABYLON.StandardMaterial('f'+k,scene);m.diffuseTexture=mkFrontTex(s,r);m.specularColor=new BABYLON.Color3(0.08,0.08,0.08);m.specularPower=20;m.backFaceCulling=false;cardFrontMats[k]=m;}}
function buildCardPool(){for(let i=0;i<80;i++){const m=BABYLON.MeshBuilder.CreatePlane('card'+i,{width:1.28,height:1.80},scene);m.rotation.x=Math.PI/2;m.position=DECK_POS();m.material=cardBackMat;m.isVisible=false;m.renderingGroupId=1;shadowGen.addShadowCaster(m);cardPool.push(m);}}
function nextCardMesh(){const m=cardPool[cardIdx%cardPool.length];cardIdx=(cardIdx+1)%cardPool.length;m.position=DECK_POS().clone();m.position.y+=0.40;m.rotation=new BABYLON.Vector3(Math.PI/2,0,0);m.billboardMode=BABYLON.Mesh.BILLBOARDMODE_NONE;m.scaling=new BABYLON.Vector3(1,1,1);m.material=cardBackMat;m.isVisible=true;return m;}
const CHIP_DENOM=[{val:500,col:[0.52,0.06,0.62]},{val:100,col:[0.14,0.20,0.88]},{val:25,col:[0.10,0.60,0.16]},{val:5,col:[0.85,0.10,0.10]},{val:1,col:[0.90,0.88,0.86]}];
function buildChipPool(){for(const d of CHIP_DENOM){for(let i=0;i<60;i++){const chip=BABYLON.MeshBuilder.CreateCylinder('chip_'+d.val+'_'+i,{height:0.072,diameter:0.34,tessellation:32},scene),m=new BABYLON.StandardMaterial('cmat_'+d.val+'_'+i,scene);m.diffuseColor=new BABYLON.Color3(...d.col);m.specularColor=new BABYLON.Color3(1,1,1);m.specularPower=300;m.emissiveColor=new BABYLON.Color3(...d.col.map(v=>v*0.22));chip.material=m;chip.isVisible=false;chip.renderingGroupId=1;chip._dval=d.val;chipPool.push(chip);}}}
function acquireChip(forVal){const d=CHIP_DENOM.find(d=>d.val<=forVal)||CHIP_DENOM[CHIP_DENOM.length-1];const ch=chipPool.find(c=>!c.isVisible&&c._dval===d.val)||chipPool.find(c=>!c.isVisible)||null;if(ch)ch.isVisible=true;return ch;}
function freeChip(c){if(c){c.isVisible=false;c.position=new BABYLON.Vector3(0,-5,0);}}
function freeAllChips(){[...potChips].forEach(freeChip);potChips=[];seatBetChips.forEach(arr=>{arr.forEach(freeChip);});seatBetChips=Array.from({length:NP},()=>[]);}
function buildChipStack(amount){const chips=[];let rem=amount;for(const d of CHIP_DENOM){if(rem<=0||chips.length>=12)break;const n=Math.min(Math.floor(rem/d.val),5);for(let i=0;i<n&&chips.length<12;i++){const ch=acquireChip(d.val);if(ch){chips.push(ch);rem-=d.val;}}}return chips;}
function animChipArc(chips,srcPos,dstBase,staggerMs,baseY,cb){
  if(!chips.length){if(cb)setTimeout(cb,50);return;}
  let done=0;
  chips.forEach((chip,i)=>{
    chip.position=new BABYLON.Vector3(srcPos.x,srcPos.y+0.45+i*0.07,srcPos.z);
    const tgt=new BABYLON.Vector3(dstBase.x+(Math.random()-0.5)*0.20,baseY+i*0.060,dstBase.z+(Math.random()-0.5)*0.20);
    const mid=new BABYLON.Vector3((chip.position.x+tgt.x)*0.5,chip.position.y+2.0,(chip.position.z+tgt.z)*0.5);
    const a=mkAnim('position',BABYLON.Animation.ANIMATIONTYPE_VECTOR3,[{frame:0,value:chip.position.clone()},{frame:10,value:mid},{frame:22,value:tgt}],'out');
    chip.animations=[a];
    setTimeout(()=>{scene.beginAnimation(chip,0,22,false,1.4,()=>{snd_chip();done++;if(done===chips.length&&cb)cb();});},i*staggerMs);
  });}
function sweepBetsToPot(cb){
  const all=[];seatBetChips.forEach(arr=>all.push(...arr));
  seatBetChips=Array.from({length:NP},()=>[]);
  if(!all.length){if(cb)setTimeout(cb,60);return;}
  const baseY=0.32+potChips.length*0.055;
  let done=0;
  all.forEach((chip,i)=>{
    const tgt=new BABYLON.Vector3(POT_BASE.x+(Math.random()-0.5)*0.38,baseY+i*0.055,POT_BASE.z+(Math.random()-0.5)*0.28);
    const mid=new BABYLON.Vector3((chip.position.x+tgt.x)*0.5,chip.position.y+1.5,(chip.position.z+tgt.z)*0.5);
    const a=mkAnim('position',BABYLON.Animation.ANIMATIONTYPE_VECTOR3,[{frame:0,value:chip.position.clone()},{frame:8,value:mid},{frame:18,value:tgt}],'out');
    chip.animations=[a];
    setTimeout(()=>{scene.beginAnimation(chip,0,18,false,1.6,()=>{snd_chip();potChips.push(chip);done++;if(done===all.length&&cb)cb();});},i*28);});}
function chipsFlyToWinner(winSeat,cb){
  const wp=seatPos(vs(winSeat));wp.y+=0.8;
  const all=[...potChips];seatBetChips.forEach(arr=>all.push(...arr));
  potChips=[];seatBetChips=Array.from({length:NP},()=>[]);
  if(!all.length){if(cb)cb();return;}
  let done=0;
  all.forEach((chip,i)=>{
    const start=chip.position.clone(),mid=new BABYLON.Vector3((start.x+wp.x)*0.5,start.y+2.4,(start.z+wp.z)*0.5);
    const a=mkAnim('position',BABYLON.Animation.ANIMATIONTYPE_VECTOR3,[{frame:0,value:start},{frame:8,value:mid},{frame:18,value:wp}],'in');
    chip.animations=[a];
    setTimeout(()=>{scene.beginAnimation(chip,0,18,false,1.5,()=>{snd_chip();freeChip(chip);done++;if(done===all.length&&cb)cb();});},i*18);});}
function buildTokens(){function makeToken(name,r,g,b,label){const tok=BABYLON.MeshBuilder.CreateCylinder(name,{height:0.12,diameter:0.48,tessellation:32},scene),m=new BABYLON.StandardMaterial(name+'m',scene);m.diffuseColor=new BABYLON.Color3(r,g,b);m.specularColor=new BABYLON.Color3(1,1,1);m.specularPower=300;m.emissiveColor=new BABYLON.Color3(r*0.3,g*0.3,b*0.3);tok.material=m;tok.isVisible=false;tok.renderingGroupId=1;const discTex=new BABYLON.DynamicTexture(name+'dt',{width:128,height:128},scene,false),dc=discTex.getContext();dc.fillStyle='rgb('+Math.round(r*255)+','+Math.round(g*255)+','+Math.round(b*255)+')';dc.beginPath();dc.arc(64,64,62,0,Math.PI*2);dc.fill();dc.strokeStyle='rgba(0,0,0,0.5)';dc.lineWidth=3;dc.stroke();dc.fillStyle=(r+g+b>1.5)?'#000':'#fff';dc.font='bold 42px Arial';dc.textAlign='center';dc.textBaseline='middle';dc.fillText(label,64,64);discTex.update();const disc=BABYLON.MeshBuilder.CreateDisc(name+'d',{radius:0.24,tessellation:32},scene),dm=new BABYLON.StandardMaterial(name+'dm',scene);dm.diffuseTexture=discTex;dm.emissiveColor=new BABYLON.Color3(1,1,1);dm.disableLighting=true;dm.backFaceCulling=false;disc.material=dm;disc.rotation.x=-Math.PI/2;disc.position.y=0.07;disc.parent=tok;disc.renderingGroupId=2;return tok;}dealerToken=makeToken('dealer',0.95,0.95,0.95,'D');sbToken=makeToken('sb',0.15,0.40,0.90,'SB');bbToken=makeToken('bb',0.90,0.80,0.10,'BB');}
function positionTokens(dSeat,sbSeat,bbSeat){
  const RX=TRX*0.50,RZ=TRZ*0.50;
  const _n=numVisualSeats();
  function seatA(seat){return -Math.PI/2-(seat/_n)*Math.PI*2;}
  function place(tok,seat,angOffset){const a=seatA(seat)+angOffset;tok.position=new BABYLON.Vector3(Math.cos(a)*RX,0.38,Math.sin(a)*RZ);tok.isVisible=true;}
  if(dSeat===sbSeat){place(dealerToken,dSeat,0.18);place(sbToken,sbSeat,-0.18);}
  else{place(dealerToken,dSeat,0);place(sbToken,sbSeat,0.06);}
  place(bbToken,bbSeat,0.06);}
const LW=320,LH=128;
function buildPlayerLabels(){for(let i=0;i<NP;i++){const tex=new BABYLON.DynamicTexture('plbtex'+i,{width:LW,height:LH},scene,false);tex.hasAlpha=true;const mat=new BABYLON.StandardMaterial('plbm'+i,scene);mat.diffuseTexture=tex;mat.hasAlpha=true;mat.emissiveColor=new BABYLON.Color3(1,1,1);mat.disableLighting=true;mat.backFaceCulling=false;const plane=BABYLON.MeshBuilder.CreatePlane('plbp'+i,{width:2.2,height:0.88},scene);plane.material=mat;const sp=seatPos(i);plane.position=new BABYLON.Vector3(sp.x*0.78,0.98,sp.z*0.78);plane.billboardMode=BABYLON.Mesh.BILLBOARDMODE_ALL;plane.isVisible=false;plane.renderingGroupId=2;playerLabels.push({plane,tex});}}
function updateLabel(seat,name,chips,bet,action,isMe,isDead,isAutoFold,isSpectator,isPendingBuyBack){const vSeat=vs(seat),lb=playerLabels[vSeat];if(!lb)return;const sp=seatPos(vSeat);lb.plane.position=new BABYLON.Vector3(sp.x*0.78,0.98,sp.z*0.78);const ctx=lb.tex.getContext();ctx.clearRect(0,0,LW,LH);if(!name){lb.plane.isVisible=false;lb.tex.update();return;}
  const bgCol=isAutoFold?'rgba(60,10,80,0.92)':isDead?'rgba(80,20,20,0.82)':isMe?'rgba(10,60,10,0.88)':'rgba(10,10,50,0.82)';
  ctx.fillStyle=bgCol;ctx.beginPath();if(ctx.roundRect)ctx.roundRect(2,2,LW-4,LH-4,10);else ctx.rect(2,2,LW-4,LH-4);ctx.fill();
  const borderCol=isAutoFold?'#aa40ff':isMe?'#20c040':isDead?'#802020':'#c8a020';
  ctx.strokeStyle=borderCol;ctx.lineWidth=3;ctx.beginPath();if(ctx.roundRect)ctx.roundRect(2,2,LW-4,LH-4,10);else ctx.rect(2,2,LW-4,LH-4);ctx.stroke();
  ctx.fillStyle='#ffffff';ctx.font='bold 24px Arial';ctx.textAlign='center';ctx.textBaseline='top';
  const dispName=(name.length>14?name.slice(0,13)+'\u2026':name).toUpperCase();
  ctx.fillText(dispName,LW/2,6);
  ctx.fillStyle='#ffd700';ctx.font='bold 18px Arial';
  ctx.fillText('Stack \u00a3'+(chips/100).toFixed(2),LW/2,34);
  if(bet>0){ctx.fillStyle='#80cfff';ctx.font='15px Arial';ctx.fillText('Bet \u00a3'+(bet/100).toFixed(2),LW/2,58);}
  if(isPendingBuyBack){ctx.fillStyle='#ffaa20';ctx.font='bold 15px Arial';ctx.fillText('\uD83D\uDCB8 BUY-BACK?',LW/2,bet>0?82:58);}
  else if(isSpectator){ctx.fillStyle='#8899aa';ctx.font='bold 15px Arial';ctx.fillText('\uD83D\uDC40 SPECTATOR',LW/2,bet>0?82:58);}
  else if(isAutoFold){ctx.fillStyle='#cc44ff';ctx.font='bold 16px Arial';ctx.fillText('\u23f8 AUTO-FOLD ON',LW/2,bet>0?82:58);}
  else if(action){const ac=action.toUpperCase(),acCol=ac.startsWith('FOLD')?'#c04040':ac.startsWith('RAISE')||ac.startsWith('BET')?'#e09020':'#20c040';ctx.fillStyle=acCol;ctx.font='bold 16px Arial';ctx.fillText(ac,LW/2,bet>0?82:58);}
  lb.tex.update();lb.plane.isVisible=true;
}
function mkAnim(prop,type,keys,ease){const a=new BABYLON.Animation('a_'+prop,prop,60,type,BABYLON.Animation.ANIMATIONLOOPMODE_CONSTANT);a.setKeys(keys);const ef=ease==='in'?new BABYLON.QuadraticEase():new BABYLON.CubicEase();ef.setEasingMode(ease==='in'?BABYLON.EasingFunction.EASINGMODE_EASEIN:BABYLON.EasingFunction.EASINGMODE_EASEOUT);a.setEasingFunction(ef);return a;}
function animDeal(mesh,target,cb){const start=mesh.position.clone(),mid=new BABYLON.Vector3((start.x+target.x)*.5,start.y+2.8,(start.z+target.z)*.5),a=mkAnim('position',BABYLON.Animation.ANIMATIONTYPE_VECTOR3,[{frame:0,value:start},{frame:10,value:mid},{frame:24,value:target}],'out');scene.stopAnimation(mesh);mesh.animations=[a];scene.beginAnimation(mesh,0,24,false,1.5,cb||null);}
function animFlipUp(mesh,frontMat,cb){const a1=mkAnim('scaling.x',BABYLON.Animation.ANIMATIONTYPE_FLOAT,[{frame:0,value:1},{frame:9,value:0}],'in');scene.stopAnimation(mesh);mesh.animations=[a1];scene.beginAnimation(mesh,0,9,false,1,()=>{mesh.material=frontMat;const a2=mkAnim('scaling.x',BABYLON.Animation.ANIMATIONTYPE_FLOAT,[{frame:0,value:0},{frame:9,value:1}],'out');scene.stopAnimation(mesh);mesh.animations=[a2];scene.beginAnimation(mesh,0,9,false,1,cb||null);});}
function createScene(){scene=new BABYLON.Scene(engine);scene.clearColor=new BABYLON.Color4(0.04,0.04,0.04,1);
cam=new BABYLON.ArcRotateCamera('cam',-Math.PI/2,Math.PI/3.6,17,new BABYLON.Vector3(0,0.5,0),scene);
cam.lowerAlphaLimit=-Math.PI/2-0.52;
cam.upperAlphaLimit=-Math.PI/2+0.52;
cam.lowerBetaLimit=0.55;
cam.upperBetaLimit=1.18;
cam.lowerRadiusLimit=5;
cam.upperRadiusLimit=22;
cam.wheelPrecision=28;
cam.pinchPrecision=180;
cam.panningSensibility=0;
cam.attachControl(canvas,true);
const h=new BABYLON.HemisphericLight('h',new BABYLON.Vector3(0,1,0),scene);
h.intensity=0.12;h.diffuse=new BABYLON.Color3(0.7,0.62,0.45);h.groundColor=new BABYLON.Color3(0.04,0.03,0.02);
spotLight=new BABYLON.SpotLight('sp',new BABYLON.Vector3(0,12,0),new BABYLON.Vector3(0,-1,0),Math.PI/2.2,1.8,scene);
spotLight.intensity=2.2;spotLight.diffuse=new BABYLON.Color3(1.0,0.92,0.72);
const fillLight=new BABYLON.PointLight('fill',new BABYLON.Vector3(-4,7,4),scene);
fillLight.intensity=0.5;fillLight.diffuse=new BABYLON.Color3(0.8,0.75,0.55);
shadowGen=new BABYLON.ShadowGenerator(2048,spotLight);shadowGen.useBlurExponentialShadowMap=true;shadowGen.blurKernel=16;
const f=BABYLON.MeshBuilder.CreateGround('floor',{width:44,height:44},scene);
f.position.y=-0.22;f.receiveShadows=true;
const fm=new BABYLON.StandardMaterial('fm',scene);
fm.diffuseColor=new BABYLON.Color3(0.06,0.04,0.02);
fm.specularColor=new BABYLON.Color3(0.25,0.15,0.06);fm.specularPower=120;f.material=fm;
const T=96;
const base=BABYLON.MeshBuilder.CreateCylinder('base',{height:0.52,diameter:12,tessellation:T},scene);
base.scaling.x=TRX/6;base.scaling.z=TRZ/6;base.position.y=-0.01;
const bm=new BABYLON.PBRMaterial('bm',scene);
bm.albedoColor=new BABYLON.Color3(0.12,0.06,0.02);
bm.roughness=0.28;bm.metallic=0;
base.material=bm;
const rail=BABYLON.MeshBuilder.CreateTorus('rail',{diameter:11.4,thickness:0.52,tessellation:T,radialSegments:24},scene);
rail.scaling.x=TRX/(11.4/2)*0.97;rail.scaling.z=TRZ/(11.4/2)*0.97;rail.position.y=0.22;
const rm=new BABYLON.PBRMaterial('rm',scene);
rm.albedoColor=new BABYLON.Color3(0.16,0.04,0.02);
rm.roughness=0.82;rm.metallic=0;
rail.material=rm;
const trim=BABYLON.MeshBuilder.CreateTorus('trim',{diameter:10.9,thickness:0.08,tessellation:T,radialSegments:8},scene);
trim.scaling.x=TRX/(10.9/2)*0.93;trim.scaling.z=TRZ/(10.9/2)*0.93;trim.position.y=0.30;
const trm=new BABYLON.StandardMaterial('trm',scene);
trm.diffuseColor=new BABYLON.Color3(0.72,0.52,0.08);
trm.specularColor=new BABYLON.Color3(1,0.9,0.4);trm.specularPower=400;
trm.emissiveColor=new BABYLON.Color3(0.12,0.08,0.01);
trim.material=trm;
const felt=BABYLON.MeshBuilder.CreateCylinder('felt',{height:0.07,diameter:10.8,tessellation:T},scene);
felt.scaling.x=TRX/(10.8/2)*0.90;felt.scaling.z=TRZ/(10.8/2)*0.90;felt.position.y=0.28;
const ftm=new BABYLON.PBRMaterial('ftm',scene);
ftm.albedoColor=new BABYLON.Color3(0.02,0.16,0.07);
ftm.roughness=0.96;ftm.metallic=0;
ftm.sheen.isEnabled=true;ftm.sheen.intensity=0.38;ftm.sheen.color=new BABYLON.Color3(0.08,0.28,0.12);
felt.material=ftm;felt.receiveShadows=true;
const inlay=BABYLON.MeshBuilder.CreateTorus('inlay',{diameter:9.8,thickness:0.04,tessellation:T,radialSegments:6},scene);
inlay.scaling.x=TRX/(9.8/2)*0.86;inlay.scaling.z=TRZ/(9.8/2)*0.86;inlay.position.y=0.32;
const ilm=new BABYLON.StandardMaterial('ilm',scene);
ilm.diffuseColor=new BABYLON.Color3(0.08,0.32,0.14);
ilm.emissiveColor=new BABYLON.Color3(0.01,0.04,0.02);
inlay.material=ilm;
const brandTex=new BABYLON.DynamicTexture('brand',{width:1024,height:512},scene,false);brandTex.hasAlpha=true;const bc=brandTex.getContext();bc.clearRect(0,0,1024,512);bc.fillStyle='rgba(255,255,255,0.07)';bc.font='bold 170px Arial';bc.textAlign='center';bc.textBaseline='middle';bc.fillText('SYFM UC',512,256);brandTex.update();const brandMat=new BABYLON.StandardMaterial('brandMat',scene);brandMat.diffuseTexture=brandTex;brandMat.hasAlpha=true;brandMat.emissiveColor=new BABYLON.Color3(1,1,1);brandMat.disableLighting=true;brandMat.backFaceCulling=false;const brandPlane=BABYLON.MeshBuilder.CreatePlane('brand',{width:TRX*1.55,height:TRZ*1.35},scene);brandPlane.rotation.x=Math.PI/2;brandPlane.position.y=0.262;brandPlane.material=brandMat;brandPlane.renderingGroupId=1;buildCardMats();buildCardPool();buildChipPool();buildPlayerLabels();buildTokens();
highlightLayer=new BABYLON.HighlightLayer('hl',scene);
highlightLayer.innerGlow=false;
highlightLayer.outerGlow=true;
return scene;}
let seatActions={};

// FIX #2: applyState only shows cards the server has told us to show.
// The server sends 'back' for hidden cards, real card data only for the owner.
// We never flip up a card unless the server explicitly says it's revealed.
function applyState(st){
  if(!st)return;
  lastState=st;
  if(st.players)updateOccupiedSeats(st.players);
  for(let i=0;i<NP;i++){
    const p=st.players[i];
    if(p)updateLabel(i,p.name,p.chips,p.bet||0,seatActions[i]||'',i===mySeat,p.folded,p.voluntaryAutoFold||false,p.spectator||false,p.pendingBuyBack||false);
    else updateLabel(i,null,0,0,'',false,false,false,false,false);
  }
  const comm=st.community||[];
  for(let ci=0;ci<5;ci++){
    const mesh=communityCardMeshes[ci];
    if(ci<comm.length){
      if(!mesh||!mesh.isVisible){
        const m=getOrCreateCommunityMesh(ci),target=COM_POS[ci].clone();
        m.material=cardBackMat;m.isVisible=true;
        animDeal(m,target,()=>{
          snd_deal();
          const cd=comm[ci];
          if(cd&&cd!=='back')animFlipUp(m,cardFrontMats[cd.r+cd.s]||cardBackMat,()=>snd_flip());
        });
      }
    }else{
      if(mesh)mesh.isVisible=false;
    }
  }
  for(let i=0;i<NP;i++){
    const p=st.players[i],meshes=seatCardMeshes[i];
    if(!p||!p.cards||p.cards.length===0){
      for(const m of meshes){if(m)m.isVisible=false;}
      seatCardMeshes[i]=[null,null];
      continue;
    }
    p.cards.forEach((cd,cn)=>{
      const m=meshes[cn];
      if(!m||!m.isVisible)return;
      if(p.folded){
        if(cardFoldedMat&&m.material!==cardFoldedMat)m.material=cardFoldedMat;
        return;
      }
      // FIX #2: Only flip to face-up if server sent actual card data (not 'back')
      if(cd&&cd!=='back'){
        const fmat=cardFrontMats[cd.r+cd.s];
        if(fmat&&m.material!==fmat)animFlipUp(m,fmat,()=>snd_flip());
      } else {
        // Ensure other players' cards stay face-down
        if(m.material!==cardBackMat)m.material=cardBackMat;
      }
    });
  }
  const p0=st.players[mySeat];
  if(p0)document.getElementById('myInfo').innerHTML='Stack \u00a3'+(p0.chips/100).toFixed(2)+(p0.bet>0?'<br><span style="color:#80cfff">Bet \u00a3'+(p0.bet/100).toFixed(2)+'</span>':'');
  document.getElementById('pot').textContent='POT: \u00a3'+((st.pot||0)/100).toFixed(2);
  document.getElementById('phase').textContent=(st.phase||'').toUpperCase().replace('PREFLOP','PRE-FLOP');
}

function getOrCreateCommunityMesh(idx){
  if(communityCardMeshes[idx]&&communityCardMeshes[idx].isVisible!==undefined)return communityCardMeshes[idx];
  const m=nextCardMesh();
  communityCardMeshes[idx]=m;
  return m;
}

// FIX #2: startDealAnimation only deals cards to players in activeSeats.
// No card mesh is created for seats not in the active list.
function startDealAnimation(activeSeats,afterDone){
  dealing=true;
  for(let i=0;i<NP;i++){const meshes=seatCardMeshes[i]||[];for(const m of meshes){if(m)m.isVisible=false;}seatCardMeshes[i]=[null,null];}
  for(const m of communityCardMeshes){if(m)m.isVisible=false;}
  communityCardMeshes=[];freeAllChips();
  const seq=[];
  for(let rd=0;rd<2;rd++)for(const si of activeSeats)seq.push(si);
  const dealt={};for(const si of activeSeats)dealt[si]=0;
  let idx=0;
  function next(){
    if(idx>=seq.length){dealing=false;if(afterDone)afterDone();return;}
    const si=seq[idx++],cn=dealt[si]||0;dealt[si]=cn+1;
    // FIX #2: Guard ‚Äî only deal to active seats
    if(!activeSeats.includes(si)){next();return;}
    const isMe=(si===mySeat);
    const target=isMe ? cardPos(vs(si),cn) : cardPosOther(vs(si),cn);
    const m=nextCardMesh();
    if(!isMe){m.rotation=new BABYLON.Vector3(0,0,0);m.billboardMode=BABYLON.Mesh.BILLBOARDMODE_ALL;}
    seatCardMeshes[si][cn]=m;
    animDeal(m,target,()=>{
      snd_deal();
      if(lastState&&lastState.players[si]){
        const cd=lastState.players[si].cards[cn];
        // FIX #2: Only reveal face if server sent actual card data
        if(cd&&cd!=='back')animFlipUp(m,cardFrontMats[cd.r+cd.s]||cardBackMat,()=>snd_flip());
        // else: stays face-down (back material)
      }
      setTimeout(next,80);
    });
  }
  next();
}

// ‚îÄ‚îÄ WebSocket with auto-reconnect ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _reconnectTimer=null, _reconnectAttempts=0, _intentionalClose=false;
let _serverShutdown=false; // set when server sends explicit shutdown notice
const MAX_RECONNECT_ATTEMPTS=12;
const RECONNECT_DELAYS=[1000,2000,3000,5000,5000,8000,8000,10000,10000,10000,10000,10000];
// After a known server shutdown we wait longer before first retry (Render cold-start ~10-20s)
const SHUTDOWN_FIRST_DELAY=12000;

function connectWS(name,roomId,playerId){
  _intentionalClose=false;
  if(_reconnectTimer){clearTimeout(_reconnectTimer);_reconnectTimer=null;}
  const proto=location.protocol==='https:'?'wss:':'ws:';
  ws=new WebSocket(proto+'//'+location.host);
  ws.onopen=()=>{
    _reconnectAttempts=0;
    _serverShutdown=false;
    const rb=document.getElementById('reconnectBanner');
    if(rb)rb.style.display='none';
    ws.send(JSON.stringify({type:'join',id:playerId,name,room:roomId}));
  };
  ws.onmessage=(ev)=>{let msg;try{msg=JSON.parse(ev.data);}catch{return;}handleServerMsg(msg);};
  ws.onclose=()=>{
    if(_intentionalClose)return;
    if(_reconnectAttempts>=MAX_RECONNECT_ATTEMPTS){
      showRestartPrompt();
      return;
    }
    // If server told us it was shutting down, wait longer for cold-start
    const baseDelay=_serverShutdown&&_reconnectAttempts===0
      ? SHUTDOWN_FIRST_DELAY
      : RECONNECT_DELAYS[Math.min(_reconnectAttempts,RECONNECT_DELAYS.length-1)];
    _reconnectAttempts++;
    showReconnectBanner(_reconnectAttempts,baseDelay);
    _reconnectTimer=setTimeout(()=>{
      if(myName&&myRoomId&&myId)connectWS(myName,myRoomId,myId);
    },baseDelay);
  };
  ws.onerror=()=>{
    if(_reconnectAttempts===0&&document.getElementById('gameUI').style.display==='none'){
      document.getElementById('loginErr').textContent='Could not connect to server.';
      document.getElementById('loginOverlay').style.display='flex';
      document.getElementById('waitingOverlay').style.display='none';
      document.getElementById('lobbyOverlay').style.display='none';
    }
  };
}

// Show the reconnect banner with attempt count and countdown
function showReconnectBanner(attempt,delayMs){
  let rb=document.getElementById('reconnectBanner');
  if(!rb){
    rb=document.createElement('div');
    rb.id='reconnectBanner';
    rb.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.94);border:2px solid #c8a020;border-radius:14px;padding:20px 30px;color:#ffd700;font-size:15px;font-weight:bold;text-align:center;z-index:999;white-space:pre-line;min-width:260px';
    document.body.appendChild(rb);
  }
  rb.style.display='block';
  const secs=Math.round(delayMs/1000);
  const shutMsg=_serverShutdown?'\nServer restarting ‚Äî please wait‚Ä¶':'';
  rb.textContent='‚ö† Reconnecting‚Ä¶ ('+attempt+'/'+MAX_RECONNECT_ATTEMPTS+')\nRetrying in '+secs+'s'+shutMsg;
  // Live countdown
  if(rb._countdown)clearInterval(rb._countdown);
  let remaining=secs;
  rb._countdown=setInterval(()=>{
    remaining--;
    if(remaining<=0){clearInterval(rb._countdown);rb._countdown=null;return;}
    const sm=_serverShutdown?'\nServer restarting ‚Äî please wait‚Ä¶':'';
    rb.textContent='‚ö† Reconnecting‚Ä¶ ('+attempt+'/'+MAX_RECONNECT_ATTEMPTS+')\nRetrying in '+remaining+'s'+sm;
  },1000);
}

// Called when all reconnect attempts exhausted ‚Äî show a hard reload prompt
function showRestartPrompt(){
  let rb=document.getElementById('reconnectBanner');
  if(!rb){rb=document.createElement('div');rb.id='reconnectBanner';document.body.appendChild(rb);}
  rb.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.96);border:2px solid #c84040;border-radius:14px;padding:24px 32px;color:#ff9090;font-size:15px;font-weight:bold;text-align:center;z-index:999;min-width:280px';
  rb.innerHTML='‚ö† Lost connection to server.<br><br><span style="color:#c8a060;font-weight:normal;font-size:13px">The server may have restarted.<br>Your seat will be held if you reconnect.</span><br><br><button onclick="location.reload()" style="padding:10px 24px;border-radius:8px;border:none;background:linear-gradient(135deg,#c8a020,#8a6a08);color:#000;font-size:14px;font-weight:bold;cursor:pointer">üîÑ Reload &amp; Reconnect</button>';
}

function wsSend(obj){if(ws&&ws.readyState===1)ws.send(JSON.stringify(obj));}

document.addEventListener('visibilitychange',()=>{
  if(!document.hidden&&myName&&myRoomId&&myId){
    if(!ws||ws.readyState===WebSocket.CLOSED||ws.readyState===WebSocket.CLOSING){
      if(_reconnectTimer){clearTimeout(_reconnectTimer);_reconnectTimer=null;}
      _reconnectAttempts=0;
      showReconnectBanner(1,0);
      connectWS(myName,myRoomId,myId);
    }
  }
});

function handleServerMsg(msg){switch(msg.type){
case 'serverShutdown':{
  // Server is shutting down cleanly (SIGTERM from Render).
  // Set flag so reconnect logic waits longer and shows the right message.
  _serverShutdown=true;
  showReconnectBanner(0, SHUTDOWN_FIRST_DELAY);
  addLog('‚ö† Server restarting ‚Äî will reconnect automatically‚Ä¶','log-fold');
  break;}
case 'logEvent':{
  // System event from server ‚Äî goes to activity log only, never the chat box
  addLog(msg.text,'log-system');
  break;}
case 'joined':myId=msg.id;mySeat=msg.seat;isHost=msg.isHost;localStorage.setItem('pokerPlayerId',myId);document.getElementById('loginOverlay').style.display='none';document.getElementById('waitingOverlay').style.display='none';break;
case 'waiting':document.getElementById('loginOverlay').style.display='none';document.getElementById('waitingOverlay').style.display='flex';break;
case 'rejected':document.getElementById('waitingOverlay').style.display='none';document.getElementById('loginOverlay').style.display='flex';document.getElementById('loginErr').textContent=msg.reason||'Entry declined.';break;
case 'lobby':updateOccupiedSeats(msg.seats||[]);renderLobby(msg);if(isHost&&msg.pending){for(const p of msg.pending){if(!pendingInGame[p.id])pendingInGame[p.id]={id:p.id,name:p.name};}for(const id of Object.keys(pendingInGame)){if(!msg.pending.find(p=>p.id===id))delete pendingInGame[id];}refreshInGameJoinNotif();}break;
case 'joinRequest':if(isHost){ensureAudio();snd_joinAlert();addInGameJoinRequest(msg.id,msg.name);if(document.getElementById('lobbyOverlay').style.display!=='none'&&lastLobbyMsg){if(!lastLobbyMsg.pending.find(p=>p.id===msg.id))lastLobbyMsg.pending.push({id:msg.id,name:msg.name});renderLobby(lastLobbyMsg);}}break;
case 'winner':snd_win();hideTurnIndicator();addLog('\ud83c\udfc6 '+msg.name+' wins \u00a3'+(msg.amount/100).toFixed(2)+' \u2014 '+(msg.label||''),'log-win');showMsg('\ud83c\udfc6 '+msg.name+' wins \u00a3'+(msg.amount/100).toFixed(2)+'\n'+(msg.label||'')+'!',0);chipsFlyToWinner(msg.seat,()=>{});setTimeout(()=>showMsg(''),5500);break;
case 'gameStarting':document.getElementById('lobbyOverlay').style.display='none';document.getElementById('gameUI').style.display='block';document.getElementById('roomBadge').textContent='ROOM '+myRoomId;document.getElementById('myNameBadge').textContent='\uD83D\uDC64 '+(myName||'');
  // FIX #2: Show a brief fullscreen hint if the API is available on this device
  setTimeout(()=>{
    const fsBtn=document.getElementById('fsBtn');
    if(fsBtn&&fsBtn.style.display!=='none'&&!document.fullscreenElement){
      const hint=document.createElement('div');
      hint.id='fsHint';
      hint.style.cssText='position:fixed;bottom:60px;right:10px;background:rgba(0,0,0,0.92);border:1px solid #c8a020;border-radius:10px;padding:10px 14px;color:#ffd700;font-size:13px;font-weight:bold;z-index:300;pointer-events:none;text-align:right;line-height:1.5;animation:fsHintFade 4.5s ease forwards';
      hint.innerHTML='Tap <strong style="color:#c8a060">&#x26F6;</strong> bottom-right<br><span style="font-size:11px;color:#c8a060;font-weight:normal">for fullscreen</span>';
      // Draw an arrow pointing down-right toward the button
      document.body.appendChild(hint);
      // Add the fade keyframe dynamically if not already present
      if(!document.getElementById('fsHintStyle')){
        const st=document.createElement('style');
        st.id='fsHintStyle';
        st.textContent='@keyframes fsHintFade{0%{opacity:0;transform:translateY(8px)}15%{opacity:1;transform:translateY(0)}80%{opacity:1}100%{opacity:0}}';
        document.head.appendChild(st);
      }
      setTimeout(()=>{const h=document.getElementById('fsHint');if(h)h.remove();},4600);
    }
  },800);
  break;
case 'newHand':{
  seatActions={};showMsg('');setActions(false);hideTurnIndicator();
  document.getElementById('waitingMsg').style.display='none';
  // Clear/reset spectator banner ‚Äî if we bought back in, we're now being dealt in
  const specBanner=document.getElementById('spectatorBanner');
  specBanner.textContent='\uD83D\uDC40 You are spectating \u2014 no cards will be dealt to you';
  specBanner.style.display='none';
  const coBtn=document.getElementById('cashOutBtn');
  coBtn.classList.remove('pending');coBtn.textContent='CASH OUT';
  handNumber++;maybeKeepAlive();
  addLog('\u2501\u2501 Hand #'+handNumber+' | Dealer: Seat '+(msg.dealerSeat+1)+' \u2501\u2501','log-hand');
  addLog('SB: Seat '+(msg.sbSeat+1)+' \u00b7 BB: Seat '+(msg.bbSeat+1));
  positionTokens(vs(msg.dealerSeat),vs(msg.sbSeat),vs(msg.bbSeat));
  const sbSeat=msg.sbSeat,bbSeat=msg.bbSeat,dealerSeat=msg.dealerSeat;
  const rawSeats=msg.activeSeats||[];
  const dealStartSeat=(dealerSeat===sbSeat)?bbSeat:sbSeat;
  const dsIdx=rawSeats.indexOf(dealStartSeat);
  const dealSeats=dsIdx>=0?[...rawSeats.slice(dsIdx),...rawSeats.slice(0,dsIdx)]:rawSeats;
  startDealAnimation(dealSeats,()=>{
    setTimeout(()=>{showBet(sbSeat,10);},120);
    setTimeout(()=>{showBet(bbSeat,20);},280);
    if(lastState)applyState(lastState);
  });break;}
case 'state':lastState=msg;if(msg.players)updateOccupiedSeats(msg.players);if(document.getElementById('gameUI').style.display==='none'&&document.getElementById('lobbyOverlay').style.display==='none'){document.getElementById('gameUI').style.display='block';if(myRoomId)document.getElementById('roomBadge').textContent='ROOM '+myRoomId;document.getElementById('myNameBadge').textContent='\uD83D\uDC64 '+(myName||'');}if(!dealing)applyState(msg);break;
case 'playerAction':{
  const pname=msg.name||'Player';
  let ac=msg.action==='fold'?'FOLD':msg.action==='check'?'CHECK':msg.action==='call'?'CALL \u00a3'+((msg.amount||0)/100).toFixed(2):'RAISE \u00a3'+((msg.amount||0)/100).toFixed(2);
  if(msg.label&&msg.label.trim()) ac+=' ('+msg.label.trim()+')';
  seatActions[msg.seat]=ac;
  const logClass=msg.action==='fold'?'log-action':'log-action';
  addLog('\u27a4 '+pname+': '+ac, logClass);
  if(msg.amount>0)showBet(msg.seat,msg.amount);
  hideTurnIndicator();if(lastState)applyState(lastState);break;}
// FIX #4: yourTurn ‚Äî set callBtn label correctly based on callAmt
// callAmt === 0 means no bet to call ‚Üí show CHECK, not CALL ¬£0.00
case 'yourTurn':{
  const ca=msg.callAmt||0;
  if(msg.seat===mySeat){
    const callLabel = ca > 0 ? 'CALL \u00a3'+(ca/100).toFixed(2) : 'CHECK';
    document.getElementById('callBtn').textContent = callLabel;
    // Store BET vs RAISE so updateDisplay() can label the button correctly
    const raiseBtn=document.getElementById('raiseBtn');
    if(raiseBtn) raiseBtn.dataset.verb = msg.firstBet ? 'BET' : 'RAISE';
    drumSetMin(msg.minRaise||40); // this calls updateDisplay() which sets button text
    setActions(true);showMsg('\u2b50 Your turn!',0);
    document.getElementById('waitingMsg').style.display='none';
    startCountdown(true,'You');
  }else{
    setActions(false);showMsg('');
    const actingPlayer=lastState&&lastState.players[msg.seat];
    const actingName=actingPlayer?actingPlayer.name:'Seat '+(msg.seat+1);
    startCountdown(false,actingName);
  }break;}
case 'communityDealt':
  addLog('\u25b6 '+(msg.phase||'').toUpperCase()+': '+(msg.newCards||msg.cards||[]).map(c=>c.r+c.s).join(' '),'log-community');
  sweepBetsToPot(()=>{if(lastState)applyState(lastState);});
  break;
case 'showdown':setPhase('Showdown');hideTurnIndicator();
  sweepBetsToPot(null);
  addLog('\u2500\u2500 SHOWDOWN \u2500\u2500','log-hand');showMsg('\ud83c\udccf Showdown!',2000);break;
case 'waitingForPlayers':showMsg('\u23f3 Waiting for more players\u2026',0);hideTurnIndicator();break;
case 'playerLeft':
  addLog(msg.name+' left the table');
  addChat('\u2b05 '+msg.name+' left');
  seatActions[msg.seat]='';
  if(pendingInGame[msg.id]){delete pendingInGame[msg.id];refreshInGameJoinNotif();}
  if(msg.id===myId){_intentionalClose=true;setTimeout(()=>location.reload(),600);return;}
  if(lastState)applyState(lastState);
  break;
case 'sittingOut':{document.getElementById('gameUI').style.display='block';document.getElementById('lobbyOverlay').style.display='none';const wmEl=document.getElementById('waitingMsg');wmEl.textContent=msg.reason||'Sitting out\u2026';wmEl.style.display='block';break;}
case 'gamePaused':handlePaused(true,msg.byName);break;
case 'gameResumed':handlePaused(false,msg.byName);break;
case 'cashOutPending':{
  const btn=document.getElementById('cashOutBtn');
  btn.classList.add('pending');
  btn.textContent='CASH OUT \u23f3';
  addLog('\u{1F4B0} CASH OUT: '+(myName||'You')+' will cash out after this hand','log-win');
  showMsg('\u23f3 Cash out queued \u2014 you will leave after this hand.',3500);
  break;}
case 'voluntaryAutoFoldAck':
  addLog('\u23f8 AUTO-FOLD '+(myAutoFold?'ON: You will fold every hand until you turn this off':'OFF: You are back in the game'));
  break;
// FIX #5: buyBackOffer ‚Äî shown to any busted player regardless of player count
case 'buyBackOffer':{
  document.getElementById('buyBackOverlay').style.display='flex';
  addLog('\uD83D\uDCB8 You are out of chips! Choose to buy back in or spectate.','log-hand');
  let _bbSecs=15;
  const _bbEl=document.getElementById('buyBackTimer');
  _bbEl.textContent=_bbSecs;
  if(window._buyBackInterval)clearInterval(window._buyBackInterval);
  window._buyBackInterval=setInterval(()=>{
    _bbSecs--;
    _bbEl.textContent=_bbSecs;
    if(_bbSecs<=0){clearInterval(window._buyBackInterval);window._buyBackInterval=null;respondBuyBack(false);}
  },1000);
  break;}
case 'buyBackAccepted':{
  document.getElementById('buyBackOverlay').style.display='none';
  document.getElementById('spectatorBanner').style.display='none';
  showMsg('\u2705 Bought back in!\nYou\u2019ll be dealt in from the next hand.',4500);
  addLog('\u2705 BUY-BACK: You have bought back in for \u00a310.00 \u2014 joining next hand','log-win');
  // Show spectator banner until next hand starts
  document.getElementById('spectatorBanner').textContent='\u23f3 Bought back in \u2014 you\u2019ll be dealt from the next hand';
  document.getElementById('spectatorBanner').style.display='block';
  break;}
case 'spectating':{
  document.getElementById('buyBackOverlay').style.display='none';
  document.getElementById('spectatorBanner').style.display='block';
  addLog('\uD83D\uDC40 You are now spectating \u2014 you will not be dealt cards','log-hand');
  break;}
case 'chat':addChat(msg.name+': '+msg.text);break;
case 'error':addChat('\u26a0 '+msg.msg);break;}}
function renderLobby(msg){lastLobbyMsg=msg;myRoomId=msg.roomId;document.getElementById('lobbyRoomId').textContent=msg.roomId;if(msg.gameActive)return;document.getElementById('loginOverlay').style.display='none';document.getElementById('waitingOverlay').style.display='none';document.getElementById('lobbyOverlay').style.display='flex';const pl=document.getElementById('playerList');pl.innerHTML='<h3 style="color:#c8a020;margin-bottom:8px">Players at table:</h3>';const seated=msg.seats.filter(Boolean);for(const s of seated){const div=document.createElement('div');div.className='player-row';div.innerHTML='<span>'+s.name+(s.id===msg.hostId?'<span class="host-badge">HOST</span>':'')+'</span><span class="chips">\u00a3'+(s.chips/100).toFixed(2)+'</span>';pl.appendChild(div);}const ps=document.getElementById('pendingSection'),pi=document.getElementById('pendingItems'),pending=msg.pending||[];if(isHost&&pending.length>0){ps.style.display='block';pi.innerHTML='';for(const p of pending){const row=document.createElement('div');row.className='pending-row';row.innerHTML='<span>'+p.name+'</span><span><button class="btn-sm btn-approve" onclick="approvePlayer(\''+p.id+'\',true)">\u2713 Admit</button><button class="btn-sm btn-reject" onclick="approvePlayer(\''+p.id+'\',false)">\u2717 Reject</button></span>';pi.appendChild(row);}}else{ps.style.display='none';}const statusEl=document.getElementById('lobbyStatus');if(isHost)statusEl.textContent=seated.length<2?'Waiting for more players to join\u2026':'Ready to start!';else statusEl.textContent='Waiting for host to start the game\u2026';const sb=document.getElementById('startBtn');if(isHost){sb.style.display='block';sb.disabled=seated.length<2;}else{sb.style.display='none';}}
function approvePlayer(id,accept){wsSend({type:'approve',id,accept});}
function respondBuyBack(accept){
  if(window._buyBackInterval){clearInterval(window._buyBackInterval);window._buyBackInterval=null;}
  wsSend({type:'buyBack',accept});
  document.getElementById('buyBackOverlay').style.display='none';
  if(!accept) document.getElementById('spectatorBanner').style.display='block';
}
let pendingInGame={};
function addInGameJoinRequest(id,name){pendingInGame[id]={id,name};refreshInGameJoinNotif();}
function refreshInGameJoinNotif(){const notif=document.getElementById('joinRequestNotif'),list=document.getElementById('joinReqList'),entries=Object.values(pendingInGame);if(!entries.length||!isHost){notif.style.display='none';return;}notif.style.display='block';list.innerHTML='';for(const p of entries){const row=document.createElement('div');row.className='jr-row';row.innerHTML='<span class="jr-name">'+p.name+'</span><span class="jr-btns"><button class="jr-admit" onclick="inGameApprove(\''+p.id+'\',true)">Admit</button><button class="jr-reject" onclick="inGameApprove(\''+p.id+'\',false)">Reject</button></span>';list.appendChild(row);}}
function inGameApprove(id,accept){wsSend({type:'approve',id,accept});delete pendingInGame[id];refreshInGameJoinNotif();}
function showTurnIndicator(txt){document.getElementById('turnIndicator').textContent=txt;document.getElementById('turnIndicator').style.display='block';}
function hideTurnIndicator(){document.getElementById('turnIndicator').style.display='none';stopCountdown();}

const TURN_SECS=15;
// ‚îÄ‚îÄ Card outline pulse helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function startCardPulse(secs, totalSecs) {
  stopCardPulse();
  if (!highlightLayer) return;
  const meshes = (seatCardMeshes[mySeat] || []).filter(Boolean);
  if (!meshes.length) return;

  // Pulse interval gets shorter as time runs out:
  // >10s ‚Üí 1000ms, 5-10s ‚Üí 600ms, ‚â§5s ‚Üí 250ms (frantic)
  const interval = secs > 10 ? 1000 : secs > 5 ? 600 : 250;
  // Colour: gold ‚Üí orange ‚Üí red
  const r = secs > 10 ? 0.8 : 1.0;
  const g = secs > 10 ? 0.78 : secs > 5 ? 0.45 : 0.0;
  const b = 0.0;
  const col = new BABYLON.Color3(r, g, b);

  let on = true;
  // Add initial highlight
  meshes.forEach(m => { try { highlightLayer.addMesh(m, col); } catch(e){} });

  _cardPulseTimer = setInterval(() => {
    on = !on;
    meshes.forEach(m => {
      try {
        if (on) highlightLayer.addMesh(m, col);
        else highlightLayer.removeMesh(m);
      } catch(e) {}
    });
  }, interval);
}

function stopCardPulse() {
  if (_cardPulseTimer) { clearInterval(_cardPulseTimer); _cardPulseTimer = null; }
  if (highlightLayer) {
    const meshes = (seatCardMeshes[mySeat] || []).filter(Boolean);
    meshes.forEach(m => { try { highlightLayer.removeMesh(m); } catch(e){} });
  }
}

// ‚îÄ‚îÄ Countdown ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _countdownInterval=null;
function startCountdown(isMe,playerName){
  clearInterval(_countdownInterval);
  let secs=TURN_SECS;
  const ring=document.getElementById('myCountdownRing');
  const num=document.getElementById('myCountdownNum');
  const myBox=document.getElementById('myCountdown');
  const foldBtn=document.getElementById('foldBtn');
  const circumference=138.2;
  function tick(){
    const frac=secs/TURN_SECS;
    const colour=secs>10?'#c8a020':secs>5?'#e07020':'#e03030';
    if(isMe){
      myBox.style.display='block';
      ring.style.stroke=colour;
      ring.style.strokeDashoffset=String(circumference*(1-frac));
      num.textContent=secs;
      num.style.color=colour;
      showTurnIndicator('\u23f3 Your turn! ('+secs+'s)');
      // Timer inside fold button
      if(foldBtn){
        foldBtn.textContent='FOLD '+secs+'s';
        foldBtn.style.background=secs>5?'#7a1a1a':secs>3?'#9a1a00':'#cc0000';
        foldBtn.style.boxShadow=secs<=5?'0 0 '+(8+(5-secs)*4)+'px rgba(220,40,40,0.8)':'none';
      }
      // Card pulse ‚Äî restart each second so interval adjusts as time changes
      startCardPulse(secs, TURN_SECS);
    } else {
      myBox.style.display='none';
      showTurnIndicator('\u23f3 '+playerName+' is thinking\u2026 ('+secs+'s)');
    }
    if(secs<=0){clearInterval(_countdownInterval);return;}
    secs--;
  }
  tick();
  _countdownInterval=setInterval(tick,1000);
}
function stopCountdown(){
  clearInterval(_countdownInterval);
  document.getElementById('myCountdown').style.display='none';
  // Reset fold button text and style
  const foldBtn=document.getElementById('foldBtn');
  if(foldBtn){
    foldBtn.textContent='FOLD';
    foldBtn.style.background='';
    foldBtn.style.boxShadow='';
  }
  stopCardPulse();
}
function setActions(v){
  const panel=document.getElementById('actionPanel');
  if(panel)panel.style.display=v?'flex':'none';
  ['callBtn','raiseBtn','allInBtn','foldBtn'].forEach(id=>{
    const el=document.getElementById(id);
    if(el)el.style.display=v?'block':'none';
  });
  const dw=document.getElementById('drumWidget');
  if(dw)dw.style.display=v?'flex':'none';
  if(!v){
    // Turn ended ‚Äî reset fold button and stop card pulse
    const foldBtn=document.getElementById('foldBtn');
    if(foldBtn){foldBtn.textContent='FOLD';foldBtn.style.background='';foldBtn.style.boxShadow='';}
    stopCardPulse();
  }
}
function setPhase(p){document.getElementById('phase').textContent=p.toUpperCase();}
function showMsg(m,ms=2400){const el=document.getElementById('msg');el.textContent=m;el.style.display=m?'block':'none';if(ms>0)setTimeout(()=>el.style.display='none',ms);}
function addChat(txt){
  const log=document.getElementById('chatLog'),div=document.createElement('div');
  div.textContent=txt;log.appendChild(div);log.scrollTop=log.scrollHeight;
  while(log.children.length>60)log.removeChild(log.firstChild);
  if(chatCollapsed){
    const box=document.getElementById('chatBox');
    box.classList.remove('flash');
    void box.offsetWidth;
    box.classList.add('flash');
    setTimeout(()=>box.classList.remove('flash'),2200);
  }
}
let handNumber=0;
let keepAliveHandCount=0;
function maybeKeepAlive(){
  keepAliveHandCount++;
  if(keepAliveHandCount%5===0){
    fetch('/keepalive?room='+(myRoomId||'?')+'&hand='+handNumber)
      .then(r=>r.text()).then(txt=>{
        addLog('\u{1F4E1} Keep-alive sent (hand #'+handNumber+') \u2014 server: '+txt,'log-action');
      }).catch(()=>{
        addLog('\u26a0 Keep-alive failed at hand #'+handNumber,'log-action');
      });
  }
}
function addLog(txt,cls='log-action'){const log=document.getElementById('activityLog');if(!log)return;const div=document.createElement('div');div.className=cls;div.textContent=txt;log.appendChild(div);log.scrollTop=log.scrollHeight;while(log.children.length>200)log.removeChild(log.firstChild);}
let gamePaused=false;
function togglePause(){wsSend({type:gamePaused?'resume':'pause'});}
function handlePaused(isPaused,byName){
  gamePaused=isPaused;
  const btn=document.getElementById('pauseBtn');
  const banner=document.getElementById('pauseBanner');
  if(isPaused){
    btn.classList.add('active');
    btn.textContent='\u25b6';
    banner.style.display='block';
    addLog('\u23f8 Game PAUSED by '+(byName||'a player')+' \u2014 any player can resume','log-hand');
  } else {
    btn.classList.remove('active');
    btn.textContent='\u23f8';
    banner.style.display='none';
    addLog('\u25b6 Game RESUMED'+(byName?' by '+byName:''),'log-hand');
  }
}
let myAutoFold=false;
function toggleAutoFold(){
  myAutoFold=!myAutoFold;
  wsSend({type:'voluntaryAutoFold',enabled:myAutoFold});
  const btn=document.getElementById('autoFoldBtn');
  if(myAutoFold){btn.classList.add('active');btn.textContent='\u23f8 AUTO-FOLD: ON';showMsg('\u23f8 Auto-fold ON \u2014 folding every hand until turned off',3200);}
  else{btn.classList.remove('active');btn.textContent='AUTO-FOLD';showMsg('\u2713 Auto-fold OFF \u2014 you are back in the game',2400);}
}
function showBet(serverSeat,amount){
  if(amount<=0)return;
  const vSeat=vs(serverSeat),src=seatPos(vSeat),dst=betPos(vSeat);
  const existH=seatBetChips[serverSeat].length*0.060;
  const chips=buildChipStack(amount);
  seatBetChips[serverSeat].push(...chips);
  animChipArc(chips,src,dst,38,0.32+existH,null);}
let activityCollapsed=true;
function toggleActivityLog(){
  activityCollapsed=!activityCollapsed;
  const logEl=document.getElementById('activityLog'),toggle=document.getElementById('activityToggle');
  logEl.style.display=activityCollapsed?'none':'flex';
  toggle.textContent=activityCollapsed?'\u25b6 expand':'\u25bc collapse';
}
let chatCollapsed=true;
function toggleChat(){
  chatCollapsed=!chatCollapsed;
  const inner=document.getElementById('chatInner'),toggle=document.getElementById('chatToggle');
  inner.style.display=chatCollapsed?'none':'block';
  toggle.textContent=chatCollapsed?'\u25b6 expand':'\u25bc collapse';
}

// FIX #1: toggleFullscreen works on Android (and desktop).
// We also hide the button if the Fullscreen API is genuinely unavailable.
function toggleFullscreen(){
  if(!document.fullscreenElement && !document.webkitFullscreenElement){
    const el=document.documentElement;
    if(el.requestFullscreen){el.requestFullscreen().catch(()=>{});}
    else if(el.webkitRequestFullscreen){el.webkitRequestFullscreen();}
  } else {
    if(document.exitFullscreen){document.exitFullscreen();}
    else if(document.webkitExitFullscreen){document.webkitExitFullscreen();}
  }
}

// FIX #1: Hide fullscreen button if the API is entirely unavailable on this device
window.addEventListener('load',()=>{
  const fsBtn=document.getElementById('fsBtn');
  if(fsBtn){
    const fsAvailable = !!(
      document.documentElement.requestFullscreen ||
      document.documentElement.webkitRequestFullscreen
    );
    if(!fsAvailable) fsBtn.style.display='none';
  }
});

function doCashOut(){
  if(!confirm('Cash out and leave the table with your remaining chips?'))return;
  _intentionalClose=true;
  wsSend({type:'cashOut'});
}

document.addEventListener('fullscreenchange',()=>{
  const btn=document.getElementById('fsBtn');
  if(btn)btn.textContent=(document.fullscreenElement||document.webkitFullscreenElement)?'\u29c4':'\u26f6';
});
document.addEventListener('webkitfullscreenchange',()=>{
  const btn=document.getElementById('fsBtn');
  if(btn)btn.textContent=(document.fullscreenElement||document.webkitFullscreenElement)?'\u29c4':'\u26f6';
});

document.getElementById('callBtn').onclick=()=>{ensureAudio();setActions(false);showMsg('');wsSend({type:'action',action:'call'});};
document.getElementById('raiseBtn').onclick=()=>{ensureAudio();setActions(false);showMsg('');wsSend({type:'action',action:'raise',amount:drumGetPence()});};
document.getElementById('allInBtn').onclick=()=>{
  ensureAudio();
  // All-in = raise entire stack. Get stack from lastState.
  const me = lastState && lastState.players && lastState.players[mySeat];
  const allInAmount = me ? me.chips : drumGetPence();
  setActions(false);showMsg('');
  wsSend({type:'action',action:'raise',amount:allInAmount});
};
document.getElementById('foldBtn').onclick=()=>{ensureAudio();setActions(false);showMsg('');wsSend({type:'action',action:'fold'});};
document.getElementById('chatInput').addEventListener('keydown',e=>{if(e.key==='Enter'){const t=e.target.value.trim();if(t){wsSend({type:'chat',text:t});e.target.value='';}}});
document.getElementById('startBtn').onclick=()=>{wsSend({type:'startGame'});};
document.getElementById('joinBtn').onclick=()=>{const name=document.getElementById('nameInput').value.trim(),room=document.getElementById('roomInput').value.trim();if(!name){document.getElementById('loginErr').textContent='Please enter your name.';return;}if(!room){document.getElementById('loginErr').textContent='Please enter a room number.';return;}document.getElementById('loginErr').textContent='';document.getElementById('loginOverlay').style.display='none';document.getElementById('waitingOverlay').style.display='flex';document.getElementById('waitingTxt').textContent='Connecting\u2026';myRoomId=room;myName=name;localStorage.setItem('pokerPlayerName',name);localStorage.setItem('pokerRoomId',room);if(!myId){myId='p_'+Math.random().toString(36).slice(2,10);localStorage.setItem('pokerPlayerId',myId);}connectWS(name,room,myId);};
['nameInput','roomInput'].forEach(id=>{document.getElementById(id).addEventListener('keydown',e=>{if(e.key==='Enter')document.getElementById('joinBtn').click();});});
document.getElementById('tablePan').addEventListener('input', function(){
  if(cam) cam.target.y = parseFloat(this.value);
});

// ‚îÄ‚îÄ Raise drum wheels ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
(function(){
  let poundsIdx=0, penceIdx=0, minRaisePence=40;
  const POUNDS=Array.from({length:100},(_,i)=>i);
  const PENCE=[0,20,40,60,80];

  function buildDrum(innerId, items, getIdx){
    const inner=document.getElementById(innerId);
    inner.innerHTML='';
    const pad=1;
    for(let p=0;p<pad;p++){const g=document.createElement('div');g.className='drum-item';g.textContent='\u00a0';inner.appendChild(g);}
    items.forEach((v,i)=>{
      const d=document.createElement('div');
      d.className='drum-item'+(i===getIdx()?' sel':'');
      d.textContent=String(v).padStart(2,'0');
      inner.appendChild(d);
    });
    for(let p=0;p<pad;p++){const g=document.createElement('div');g.className='drum-item';g.textContent='\u00a0';inner.appendChild(g);}
    renderDrum(innerId,getIdx()+pad);
  }

  function renderDrum(innerId,centreRow){
    const inner=document.getElementById(innerId);
    const itemH=32,trackH=96;
    const offset=(trackH/2)-(centreRow*itemH)-(itemH/2);
    inner.style.transform=`translateY(${offset}px)`;
    Array.from(inner.children).forEach((el,i)=>{
      el.classList.toggle('sel',i===centreRow);
    });
  }

  function rebuildAll(){
    buildDrum('drumPoundsInner',POUNDS,()=>poundsIdx);
    buildDrum('drumPenceInner',PENCE,()=>penceIdx);
    updateDisplay();
  }

  function updateDisplay(){
    const total=POUNDS[poundsIdx]*100+PENCE[penceIdx];
    const clamped=Math.max(total,minRaisePence);
    const p=Math.floor(clamped/100), pn=clamped%100;
    const amtStr='\u00a3'+p+'.'+String(pn).padStart(2,'0');
    // Write directly into the raise/bet button so there's no separate display
    const btn=document.getElementById('raiseBtn');
    if(btn){
      const verb=btn.dataset.verb||'RAISE';
      btn.textContent=verb+' '+amtStr;
    }
  }

  window.drumStep=function(drum,dir){
    ensureAudio();
    snd_chip();
    if(drum==='pounds'){
      poundsIdx=Math.max(0,Math.min(POUNDS.length-1,poundsIdx+dir));
      buildDrum('drumPoundsInner',POUNDS,()=>poundsIdx);
    } else {
      penceIdx=Math.max(0,Math.min(PENCE.length-1,penceIdx+dir));
      buildDrum('drumPenceInner',PENCE,()=>penceIdx);
    }
    updateDisplay();
  };

  window.drumSetMin=function(minPence){
    minRaisePence=minPence||40;
    poundsIdx=Math.min(Math.floor(minRaisePence/100),POUNDS.length-1);
    penceIdx=PENCE.indexOf(minRaisePence%100);
    if(penceIdx===-1){
      const nextP=PENCE.find(p=>p>=minRaisePence%100);
      penceIdx=nextP!==undefined?PENCE.indexOf(nextP):0;
      if(penceIdx===-1)penceIdx=0;
    }
    rebuildAll();
  };

  window.drumGetPence=function(){
    const raw=POUNDS[poundsIdx]*100+PENCE[penceIdx];
    return Math.max(raw,minRaisePence);
  };

  function attachSwipe(trackId,drum){
    const el=document.getElementById(trackId);
    let startY=0,startIdx=0;
    el.addEventListener('touchstart',e=>{
      startY=e.touches[0].clientY;
      startIdx=drum==='pounds'?poundsIdx:penceIdx;
      e.preventDefault();
    },{passive:false});
    el.addEventListener('touchmove',e=>{
      const dy=startY-e.touches[0].clientY;
      const steps=Math.round(dy/32);
      const list=drum==='pounds'?POUNDS:PENCE;
      const ni=Math.max(0,Math.min(list.length-1,startIdx+steps));
      if(drum==='pounds'&&ni!==poundsIdx){poundsIdx=ni;buildDrum('drumPoundsInner',POUNDS,()=>poundsIdx);updateDisplay();}
      if(drum==='pence'&&ni!==penceIdx){penceIdx=ni;buildDrum('drumPenceInner',PENCE,()=>penceIdx);updateDisplay();}
      e.preventDefault();
    },{passive:false});
  }

  attachSwipe('drumPounds','pounds');
  attachSwipe('drumPence','pence');
  window.addEventListener('load',()=>rebuildAll());
})();
// ‚îÄ‚îÄ Cookie notice gate ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function cookieAccept() {
  document.getElementById('cookieOverlay').style.display = 'none';
  document.getElementById('loginOverlay').style.display  = 'flex';
}
function cookieDeny() {
  // Redirect to Disney ‚Äî no game access
  window.location.replace('https://www.disney.com');
}

const scn=createScene();
engine.runRenderLoop(()=>scn.render());
</script>
</body>
</html>
