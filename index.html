<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SYFM Poker</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{width:100%;height:100%;overflow:hidden;background:#1a0d05;font-family:'Segoe UI',Arial,sans-serif}
#c{width:100%;height:100%;display:block;touch-action:none}
.overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(10,5,2,0.88);z-index:200}
.panel{background:linear-gradient(160deg,#1c0e06 0%,#2a1408 100%);border:2px solid #c8a020;border-radius:16px;padding:36px 44px;min-width:340px;max-width:480px;width:90%;text-align:center;box-shadow:0 0 60px rgba(200,160,32,0.20)}
.panel h1{color:#ffd700;font-size:2.2rem;margin-bottom:8px;letter-spacing:2px}
.panel h2{color:#ffd700;font-size:1.5rem;margin-bottom:18px}
.panel h3{color:#c8a020;font-size:1rem;margin:14px 0 8px}
.panel p{color:#c8a060;margin-bottom:14px;line-height:1.5}
.panel input[type=text],.panel input[type=number]{width:100%;padding:12px 16px;margin:8px 0;border-radius:8px;background:#0d0704;border:1px solid #6a5010;color:#ffd700;font-size:1.1rem;outline:none;text-align:center}
.panel input:focus{border-color:#c8a020}
.btn-gold{width:100%;padding:14px;margin-top:14px;border-radius:8px;border:none;background:linear-gradient(135deg,#c8a020,#8a6a08);color:#000;font-size:1.1rem;font-weight:bold;cursor:pointer;letter-spacing:1px;transition:opacity .2s}
.btn-gold:hover{opacity:.85}
.btn-gold:disabled{opacity:.4;cursor:not-allowed}
.btn-sm{padding:8px 18px;border-radius:6px;border:none;font-size:.9rem;font-weight:bold;cursor:pointer;color:#fff;margin:4px}
.btn-approve{background:#1a6a1a}
.btn-reject{background:#6a1a1a}
.player-row{display:flex;justify-content:space-between;align-items:center;background:rgba(255,255,255,0.05);border-radius:8px;padding:10px 14px;margin:6px 0;color:#e0c060;font-size:.95rem}
.player-row .chips{color:#ffd700;font-weight:bold}
.host-badge{font-size:.7rem;background:#c8a020;color:#000;padding:2px 7px;border-radius:4px;font-weight:bold;margin-left:8px}
.pending-row{display:flex;justify-content:space-between;align-items:center;background:rgba(200,160,32,0.1);border-radius:8px;padding:8px 12px;margin:4px 0;color:#e0c060}
#gameUI{display:none;position:fixed;inset:0;pointer-events:none;z-index:100}
#gameUI > *{pointer-events:auto}
#topBar{position:absolute;top:10px;left:10px;right:10px;background:rgba(0,0,0,0.72);padding:10px 18px;border-radius:8px;color:#ffd700;display:flex;justify-content:space-between;align-items:center}
#phase{font-size:16px;font-weight:bold}
#pot{font-size:20px;font-weight:bold}
#roomBadge{font-size:13px;color:#c8a060;padding:4px 12px;background:rgba(200,160,32,0.15);border-radius:6px}
#bottomBar{position:absolute;bottom:10px;left:10px;right:10px;background:rgba(0,0,0,0.72);padding:12px 18px;border-radius:8px;color:#c8a820;text-align:center}
#myInfo{font-size:15px;font-weight:bold;margin-bottom:8px;color:#ffd700}
#actions{display:flex;gap:8px;justify-content:center;flex-wrap:wrap}
.abtn{padding:12px 24px;border-radius:6px;border:none;font-size:14px;font-weight:bold;cursor:pointer;color:#fff}
.abtn-call{background:#1a7a1a}
.abtn-raise{background:#7a5800}
.abtn-fold{background:#7a1a1a}
#raiseAmt{width:90px;padding:9px;border-radius:4px;border:1px solid #c8a020;background:rgba(0,0,0,0.8);color:#fff;font-size:14px;text-align:center}
#msg{position:absolute;top:70px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.92);padding:16px 36px;border-radius:12px;color:#fff;font-size:20px;font-weight:bold;text-align:center;display:none;border:1px solid #c8a020;max-width:70%;white-space:pre-line;pointer-events:none}
#chatBox{position:absolute;bottom:110px;right:10px;width:240px;background:rgba(0,0,0,0.70);border-radius:8px;padding:10px;border:1px solid #3a2a10}
#chatLog{height:100px;overflow-y:auto;font-size:12px;color:#c8c8a0;margin-bottom:6px;display:flex;flex-direction:column;gap:3px}
#chatInput{width:100%;padding:6px 10px;border-radius:4px;border:1px solid #4a3a15;background:rgba(0,0,0,0.7);color:#ffd700;font-size:12px}
#activityBox{position:absolute;bottom:110px;left:10px;width:270px;background:rgba(0,0,0,0.70);border-radius:8px;border:1px solid #2a3a1a}
#activityHeader{display:flex;justify-content:space-between;align-items:center;padding:8px 12px;cursor:pointer;color:#60c840;font-size:12px;font-weight:bold;user-select:none}
#activityHeader span{color:#a0d070;font-size:11px}
#activityLog{height:160px;overflow-y:auto;font-size:11px;color:#b0d890;padding:6px 10px 8px;display:flex;flex-direction:column;gap:2px;border-top:1px solid #1a2a10}
#activityLog .log-hand{color:#ffd700;font-weight:bold;margin-top:4px}
#activityLog .log-action{color:#90c870}
#activityLog .log-win{color:#40e870;font-weight:bold}
#activityLog .log-community{color:#a0b8ff}
#brightness{position:absolute;top:70px;left:14px;background:rgba(0,0,0,0.65);padding:10px 14px;border-radius:8px;color:#c8a820}
#brightness label{display:block;font-size:11px;margin-bottom:4px}
#brightSlider{width:110px}
#waitingMsg{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.88);padding:24px 40px;border-radius:14px;color:#c8a020;font-size:18px;text-align:center;display:none;border:1px solid #6a5010;pointer-events:none}
#joinRequestNotif{position:absolute;top:70px;right:260px;background:rgba(10,40,10,0.95);padding:14px 18px;border-radius:10px;color:#e0e0e0;font-size:14px;display:none;border:1px solid #20a040;min-width:220px;z-index:10}
#joinRequestNotif h4{color:#40e060;margin-bottom:8px;font-size:15px}
#joinReqList{display:flex;flex-direction:column;gap:6px}
.jr-row{display:flex;justify-content:space-between;align-items:center;background:rgba(255,255,255,0.07);padding:6px 10px;border-radius:6px}
.jr-name{color:#ffd700;font-weight:bold}
.jr-btns{display:flex;gap:5px}
.jr-admit{background:#1a6a1a;border:none;color:#fff;padding:4px 10px;border-radius:4px;cursor:pointer;font-size:12px;font-weight:bold}
.jr-reject{background:#6a1a1a;border:none;color:#fff;padding:4px 10px;border-radius:4px;cursor:pointer;font-size:12px;font-weight:bold}
#turnIndicator{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:#ffd700;font-size:17px;font-weight:bold;pointer-events:none;text-shadow:0 0 8px rgba(0,0,0,0.9),0 0 16px rgba(0,0,0,0.9);display:none;background:rgba(0,0,0,0.60);padding:8px 20px;border-radius:8px}
</style>
</head>
<body>
<canvas id="c"></canvas>
<div id="loginOverlay" class="overlay">
  <div class="panel">
    <h1>üÉè SYFM POKER</h1>
    <p>Enter your name and a room number to play</p>
    <input type="text" id="nameInput" placeholder="Your name" maxlength="18" autocomplete="off">
    <input type="number" id="roomInput" placeholder="Room number (e.g. 1234)" min="1" max="999999">
    <button class="btn-gold" id="joinBtn">JOIN ROOM</button>
    <p id="loginErr" style="color:#e05050;margin-top:10px;font-size:.9rem"></p>
  </div>
</div>
<div id="waitingOverlay" class="overlay" style="display:none">
  <div class="panel">
    <h2>‚è≥ Waiting for host‚Ä¶</h2>
    <p id="waitingTxt">The host will approve your entry shortly.</p>
    <button class="btn-gold" onclick="location.reload()" style="margin-top:10px">Cancel</button>
  </div>
</div>
<div id="lobbyOverlay" class="overlay" style="display:none">
  <div class="panel">
    <h2>üé∞ Room <span id="lobbyRoomId"></span></h2>
    <div id="playerList"></div>
    <div id="pendingSection" style="display:none">
      <h3>‚è≥ Requesting to join:</h3>
      <div id="pendingItems"></div>
    </div>
    <p id="lobbyStatus" style="color:#c8a060;margin-top:14px;font-size:.9rem"></p>
    <button class="btn-gold" id="startBtn" style="display:none;margin-top:18px">‚ñ∂ START GAME</button>
  </div>
</div>
<div id="gameUI">
  <div id="topBar">
    <div id="phase">PRE-FLOP</div>
    <div id="pot">POT: ¬£0.00</div>
    <div id="roomBadge">ROOM ‚Äî</div>
  </div>
  <div id="bottomBar">
    <div id="myInfo">YOUR CHIPS: ¬£10.00</div>
    <div id="actions" style="display:none">
      <button class="abtn abtn-call" id="callBtn">CALL</button>
      <input type="number" id="raiseAmt" value="0.40" step="0.20" min="0.40">
      <button class="abtn abtn-raise" id="raiseBtn">RAISE</button>
      <button class="abtn abtn-fold" id="foldBtn">FOLD</button>
    </div>
  </div>
  <div id="msg"></div>
  <div id="waitingMsg"></div>
  <div id="joinRequestNotif">
    <h4>‚è≥ Players want to join</h4>
    <div id="joinReqList"></div>
  </div>
  <div id="turnIndicator"></div>
  <div id="activityBox">
    <div id="activityHeader" onclick="toggleActivityLog()">üìã ACTIVITY LOG <span id="activityToggle">‚ñº minimise</span></div>
    <div id="activityLog"></div>
  </div>
  <div id="chatBox">
    <div style="font-size:11px;color:#c8a060;margin-bottom:5px;font-weight:bold">üí¨ CHAT</div>
    <div id="chatLog"></div>
    <input type="text" id="chatInput" placeholder="Type and press Enter‚Ä¶" maxlength="100">
  </div>
  <div id="brightness">
    <label>‚òÄ Brightness</label>
    <input type="range" id="brightSlider" min="0.5" max="3.5" step="0.1" value="1.8">
  </div>
</div>
<script src="https://cdn.babylonjs.com/babylon.js"></script>
<script>
'use strict';
let audioCtx;
function ensureAudio(){if(!audioCtx)audioCtx=new(window.AudioContext||window.webkitAudioContext)();}
function snd_deal(){ensureAudio();const t=audioCtx.currentTime,len=Math.floor(audioCtx.sampleRate*0.12),buf=audioCtx.createBuffer(1,len,audioCtx.sampleRate),d=buf.getChannelData(0);for(let i=0;i<len;i++)d[i]=(Math.random()*2-1)*Math.pow(Math.sin(Math.PI*i/len),0.6);const src=audioCtx.createBufferSource(),bp=audioCtx.createBiquadFilter();bp.type='bandpass';bp.Q.value=0.6;bp.frequency.setValueAtTime(4200,t);bp.frequency.exponentialRampToValueAtTime(1600,t+0.12);const g=audioCtx.createGain();g.gain.setValueAtTime(0,t);g.gain.linearRampToValueAtTime(0.28,t+0.015);g.gain.exponentialRampToValueAtTime(0.001,t+0.12);src.buffer=buf;src.connect(bp);bp.connect(g);g.connect(audioCtx.destination);src.start(t);}
function snd_flip(){ensureAudio();const t=audioCtx.currentTime,b=audioCtx.createBuffer(1,Math.floor(audioCtx.sampleRate*0.055),audioCtx.sampleRate),d=b.getChannelData(0);for(let i=0;i<d.length;i++)d[i]=(Math.random()*2-1)*Math.pow(1-i/d.length,1.6);const src=audioCtx.createBufferSource(),g=audioCtx.createGain(),hp=audioCtx.createBiquadFilter();hp.type='highpass';hp.frequency.value=2200;g.gain.setValueAtTime(0.32,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.055);src.buffer=b;src.connect(hp);hp.connect(g);g.connect(audioCtx.destination);src.start(t);}
function snd_chip(){ensureAudio();const t=audioCtx.currentTime,base=1600+Math.random()*500;[[1.0,0.16],[1.52,0.09],[2.51,0.05],[3.97,0.025]].forEach(([r,v])=>{const osc=audioCtx.createOscillator(),g=audioCtx.createGain();osc.type='sine';osc.frequency.value=base*r*(0.97+Math.random()*0.06);g.gain.setValueAtTime(v,t);g.gain.exponentialRampToValueAtTime(0.0001,t+0.09+r*0.022);osc.connect(g);g.connect(audioCtx.destination);osc.start(t);osc.stop(t+0.14);});}
function snd_win(){ensureAudio();const t=audioCtx.currentTime;[523,659,784,1047,1319].forEach((f,i)=>{const o=audioCtx.createOscillator(),g=audioCtx.createGain();o.type='triangle';o.frequency.value=f;g.gain.setValueAtTime(0,t+i*0.10);g.gain.linearRampToValueAtTime(0.12,t+i*0.10+0.04);g.gain.exponentialRampToValueAtTime(0.001,t+i*0.10+0.55);o.connect(g);g.connect(audioCtx.destination);o.start(t+i*0.10);o.stop(t+i*0.10+0.6);});}
function snd_joinAlert(){ensureAudio();const t=audioCtx.currentTime;[[0,880],[0.22,1100]].forEach(([delay,freq])=>{const o=audioCtx.createOscillator(),g=audioCtx.createGain();o.type='sine';o.frequency.setValueAtTime(freq*0.8,t+delay);o.frequency.linearRampToValueAtTime(freq,t+delay+0.12);g.gain.setValueAtTime(0,t+delay);g.gain.linearRampToValueAtTime(0.28,t+delay+0.04);g.gain.exponentialRampToValueAtTime(0.001,t+delay+0.28);o.connect(g);g.connect(audioCtx.destination);o.start(t+delay);o.stop(t+delay+0.3);});}
const SUITS=['‚ô†','‚ô•','‚ô¶','‚ô£'],RANKS=['2','3','4','5','6','7','8','9','10','J','Q','K','A'];
const NP=9,BB=20,TRX=5.4,TRZ=3.5,SRX=7.0,SRZ=5.2;
let myId=localStorage.getItem('pokerPlayerId')||null,mySeat=null,isHost=false,myRoomId=null,ws=null,lastState=null,lastLobbyMsg=null,dealing=false;
const canvas=document.getElementById('c');
const engine=new BABYLON.Engine(canvas,true);
window.addEventListener('resize',()=>engine.resize());
canvas.addEventListener('click',()=>ensureAudio(),{once:true});
let scene,spotLight,shadowGen,cardBackMat,cardFrontMats={},cardPool=[],cardIdx=0,chipPool=[],potChips=[],playerLabels=[],seatCardMeshes=[],communityCardMeshes=[],dealerToken=null,sbToken=null,bbToken=null;
function seatPos(i){const a=-Math.PI/2+(i/NP)*Math.PI*2;return new BABYLON.Vector3(Math.cos(a)*SRX,0.26,Math.sin(a)*SRZ);}
function cardPos(si,cn){const a=-Math.PI/2+(si/NP)*Math.PI*2,rx=TRX*0.70,rz=TRZ*0.70,pa=a+Math.PI/2,off=(cn-0.5)*0.55;return new BABYLON.Vector3(Math.cos(a)*rx+Math.cos(pa)*off,0.30+cn*0.003,Math.sin(a)*rz+Math.sin(pa)*off);}
const DECK_POS=()=>new BABYLON.Vector3(-TRX*0.76,0.32,0);
const COM_POS=[new BABYLON.Vector3(-1.64,0.305,0),new BABYLON.Vector3(-0.82,0.305,0),new BABYLON.Vector3(0,0.305,0),new BABYLON.Vector3(0.82,0.305,0),new BABYLON.Vector3(1.64,0.305,0)];
const PIP_LAYOUTS={'2':[[.5,.17],[.5,.83]],'3':[[.5,.17],[.5,.5],[.5,.83]],'4':[[.28,.17],[.72,.17],[.28,.83],[.72,.83]],'5':[[.28,.17],[.72,.17],[.5,.5],[.28,.83],[.72,.83]],'6':[[.28,.17],[.72,.17],[.28,.5],[.72,.5],[.28,.83],[.72,.83]],'7':[[.28,.17],[.72,.17],[.5,.34],[.28,.5],[.72,.5],[.28,.83],[.72,.83]],'8':[[.28,.17],[.72,.17],[.5,.34],[.28,.5],[.72,.5],[.5,.66],[.28,.83],[.72,.83]],'9':[[.28,.12],[.72,.12],[.28,.36],[.72,.36],[.5,.5],[.28,.64],[.72,.64],[.28,.88],[.72,.88]],'10':[[.28,.12],[.72,.12],[.5,.25],[.28,.38],[.72,.38],[.28,.62],[.72,.62],[.5,.75],[.28,.88],[.72,.88]]};
function mkBackTex(){const W=256,H=384,tex=new BABYLON.DynamicTexture('bt',{width:W,height:H},scene,true),c=tex.getContext(),g=c.createLinearGradient(0,0,W,H);g.addColorStop(0,'#0b1850');g.addColorStop(1,'#060c2a');c.fillStyle=g;c.fillRect(0,0,W,H);c.strokeStyle='#c8a020';c.lineWidth=10;c.strokeRect(5,5,W-10,H-10);c.strokeStyle='rgba(200,160,32,0.5)';c.lineWidth=2;c.strokeRect(18,18,W-36,H-36);c.strokeStyle='rgba(200,160,32,0.15)';c.lineWidth=1;for(let x=-H;x<W+H;x+=14){c.beginPath();c.moveTo(x,0);c.lineTo(x+H,H);c.stroke();c.beginPath();c.moveTo(x+H,0);c.lineTo(x,H);c.stroke();}c.fillStyle='rgba(200,160,32,0.35)';c.font='72px Arial';c.textAlign='center';c.textBaseline='middle';c.fillText('‚ô†',W/2,H/2);tex.update();return tex;}
function mkFrontTex(suit,rank){const W=320,H=450,tex=new BABYLON.DynamicTexture('ft'+rank+suit,{width:W,height:H},scene,true),c=tex.getContext(),isRed=suit==='‚ô•'||suit==='‚ô¶',col=isRed?'#cc0000':'#111111',suitLetter={‚ô†:'S',‚ô•:'H',‚ô¶:'D',‚ô£:'C'}[suit];c.fillStyle='#fefefe';c.fillRect(0,0,W,H);c.strokeStyle='#bbbbbb';c.lineWidth=5;c.strokeRect(2.5,2.5,W-5,H-5);c.strokeStyle='#dddddd';c.lineWidth=1.5;c.strokeRect(9,9,W-18,H-18);c.fillStyle=col;c.textAlign='center';c.textBaseline='top';const rnkSize=rank==='10'?52:58;c.font=`bold ${rnkSize}px Arial`;const rnkX=rank==='10'?34:29;c.fillText(rank,rnkX,10);c.font='38px Arial';c.fillText(suit,29,rank==='10'?66:72);c.fillStyle=col;c.textAlign='center';c.textBaseline='top';c.font=`bold 36px Arial`;c.fillText(suitLetter,W-26,12);c.font='26px Arial';c.fillText(suit,W-26,52);c.save();c.translate(W,H);c.rotate(Math.PI);c.fillStyle=col;c.textAlign='center';c.textBaseline='top';c.font=`bold ${rnkSize}px Arial`;c.fillText(rank,rnkX,10);c.font='38px Arial';c.fillText(suit,29,rank==='10'?66:72);c.restore();c.save();c.translate(W,H);c.rotate(Math.PI);c.fillStyle=col;c.textAlign='center';c.textBaseline='top';c.font=`bold 36px Arial`;c.fillText(suitLetter,W-26,12);c.font='26px Arial';c.fillText(suit,W-26,52);c.restore();if(rank==='A'){c.fillStyle=col;c.font='220px Arial';c.textAlign='center';c.textBaseline='middle';c.fillText(suit,W/2,H/2+8);}else if(['J','Q','K'].includes(rank)){c.fillStyle=isRed?'#fff4f4':'#f4f4ff';c.fillRect(16,105,W-32,H-210);c.strokeStyle=col+'33';c.lineWidth=2;c.strokeRect(18,107,W-36,H-214);c.fillStyle=col;c.font=`bold 130px Georgia,serif`;c.textAlign='center';c.textBaseline='middle';c.fillText(rank,W/2,H/2-20);c.font='72px Arial';c.fillText(suit,W/2,H/2+90);c.font='28px Arial';c.fillStyle=col+'66';c.fillText(suit,22,H-100);c.fillText(suit,W-22,110);c.save();c.translate(W,H);c.rotate(Math.PI);c.fillText(suit,22,H-100);c.fillText(suit,W-22,110);c.restore();}else{const pips=PIP_LAYOUTS[rank]||[],ax=W*0.13,ay=H*0.17,aw=W*0.74,ah=H*0.66,pSize=pips.length<=4?72:pips.length<=6?60:pips.length<=8?52:44;c.fillStyle=col;c.font=`${pSize}px Arial`;c.textAlign='center';c.textBaseline='middle';for(const[fx,fy]of pips)c.fillText(suit,ax+fx*aw,ay+fy*ah);}tex.update();return tex;}
function buildCardMats(){cardBackMat=new BABYLON.StandardMaterial('back',scene);cardBackMat.diffuseTexture=mkBackTex();cardBackMat.specularColor=new BABYLON.Color3(0.1,0.1,0.1);cardBackMat.specularPower=30;cardBackMat.backFaceCulling=false;for(const s of SUITS)for(const r of RANKS){const k=r+s,m=new BABYLON.StandardMaterial('f'+k,scene);m.diffuseTexture=mkFrontTex(s,r);m.specularColor=new BABYLON.Color3(0.08,0.08,0.08);m.specularPower=20;m.backFaceCulling=false;cardFrontMats[k]=m;}}
function buildCardPool(){for(let i=0;i<80;i++){const m=BABYLON.MeshBuilder.CreatePlane('card'+i,{width:1.0,height:1.40},scene);m.rotation.x=Math.PI/2;m.position=DECK_POS();m.material=cardBackMat;m.isVisible=false;m.renderingGroupId=1;shadowGen.addShadowCaster(m);cardPool.push(m);}}
function nextCardMesh(){const m=cardPool[cardIdx%cardPool.length];cardIdx=(cardIdx+1)%cardPool.length;m.position=DECK_POS().clone();m.position.y+=0.28;m.rotation=new BABYLON.Vector3(Math.PI/2,0,0);m.scaling=new BABYLON.Vector3(1,1,1);m.material=cardBackMat;m.isVisible=true;return m;}
const CHIP_DENOM=[{val:1,col:[0.90,0.88,0.86]},{val:5,col:[0.85,0.10,0.10]},{val:25,col:[0.10,0.60,0.16]},{val:100,col:[0.14,0.20,0.88]},{val:500,col:[0.52,0.06,0.62]}];
function buildChipPool(){for(const d of CHIP_DENOM){for(let i=0;i<30;i++){const chip=BABYLON.MeshBuilder.CreateCylinder('chip',{height:0.068,diameter:0.32,tessellation:32},scene),m=new BABYLON.StandardMaterial('cm',scene);m.diffuseColor=new BABYLON.Color3(...d.col);m.specularColor=new BABYLON.Color3(1,1,1);m.specularPower=280;m.emissiveColor=new BABYLON.Color3(...d.col.map(v=>v*0.12));chip.material=m;chip.isVisible=false;chip._dval=d.val;chipPool.push(chip);}}}
function getChip(amount){const best=CHIP_DENOM.reduce((a,d)=>amount>=d.val&&d.val>a.val?d:a,CHIP_DENOM[0]),ch=chipPool.find(c=>!c.isVisible&&c._dval===best.val)||chipPool.find(c=>!c.isVisible)||chipPool[0];ch.isVisible=true;return ch;}
function freeChip(c){c.isVisible=false;}
function buildTokens(){function makeToken(name,r,g,b,label){const tok=BABYLON.MeshBuilder.CreateCylinder(name,{height:0.12,diameter:0.48,tessellation:32},scene),m=new BABYLON.StandardMaterial(name+'m',scene);m.diffuseColor=new BABYLON.Color3(r,g,b);m.specularColor=new BABYLON.Color3(1,1,1);m.specularPower=300;m.emissiveColor=new BABYLON.Color3(r*0.3,g*0.3,b*0.3);tok.material=m;tok.isVisible=false;tok.renderingGroupId=1;const discTex=new BABYLON.DynamicTexture(name+'dt',{width:128,height:128},scene,false),dc=discTex.getContext();dc.fillStyle=`rgb(${Math.round(r*255)},${Math.round(g*255)},${Math.round(b*255)})`;dc.beginPath();dc.arc(64,64,62,0,Math.PI*2);dc.fill();dc.strokeStyle='rgba(0,0,0,0.5)';dc.lineWidth=3;dc.stroke();dc.fillStyle=(r+g+b>1.5)?'#000':'#fff';dc.font='bold 42px Arial';dc.textAlign='center';dc.textBaseline='middle';dc.fillText(label,64,64);discTex.update();const disc=BABYLON.MeshBuilder.CreateDisc(name+'d',{radius:0.24,tessellation:32},scene),dm=new BABYLON.StandardMaterial(name+'dm',scene);dm.diffuseTexture=discTex;dm.emissiveColor=new BABYLON.Color3(1,1,1);dm.disableLighting=true;dm.backFaceCulling=false;disc.material=dm;disc.rotation.x=-Math.PI/2;disc.position.y=0.07;disc.parent=tok;disc.renderingGroupId=2;return tok;}dealerToken=makeToken('dealer',0.95,0.95,0.95,'D');sbToken=makeToken('sb',0.15,0.40,0.90,'SB');bbToken=makeToken('bb',0.90,0.80,0.10,'BB');}
function positionTokens(dSeat,sbSeat,bbSeat){function placeToken(tok,seat){if(seat===null||seat===undefined){tok.isVisible=false;return;}const a=-Math.PI/2+(seat/NP)*Math.PI*2,rx=TRX*0.56,rz=TRZ*0.56,oa=a+0.30;tok.position=new BABYLON.Vector3(Math.cos(oa)*rx,0.36,Math.sin(oa)*rz);tok.isVisible=true;}placeToken(dealerToken,dSeat);placeToken(sbToken,sbSeat);placeToken(bbToken,bbSeat);}
const LW=320,LH=110;
function buildPlayerLabels(){for(let i=0;i<NP;i++){const tex=new BABYLON.DynamicTexture('plbtex'+i,{width:LW,height:LH},scene,false);tex.hasAlpha=true;const mat=new BABYLON.StandardMaterial('plbm'+i,scene);mat.diffuseTexture=tex;mat.hasAlpha=true;mat.emissiveColor=new BABYLON.Color3(1,1,1);mat.disableLighting=true;mat.backFaceCulling=false;const plane=BABYLON.MeshBuilder.CreatePlane('plbp'+i,{width:2.2,height:0.76},scene);plane.material=mat;const sp=seatPos(i);plane.position=new BABYLON.Vector3(sp.x*0.78,0.95,sp.z*0.78);plane.billboardMode=BABYLON.Mesh.BILLBOARDMODE_ALL;plane.isVisible=false;plane.renderingGroupId=2;playerLabels.push({plane,tex});}}
function updateLabel(seat,name,chips,action,isMe,isDead){const lb=playerLabels[seat];if(!lb)return;const ctx=lb.tex.getContext();ctx.clearRect(0,0,LW,LH);if(!name){lb.plane.isVisible=false;lb.tex.update();return;}const bgCol=isDead?'rgba(80,20,20,0.82)':isMe?'rgba(10,60,10,0.88)':'rgba(10,10,50,0.82)';ctx.fillStyle=bgCol;ctx.beginPath();if(ctx.roundRect)ctx.roundRect(2,2,LW-4,LH-4,10);else ctx.rect(2,2,LW-4,LH-4);ctx.fill();const borderCol=isMe?'#20c040':isDead?'#802020':'#c8a020';ctx.strokeStyle=borderCol;ctx.lineWidth=2;ctx.beginPath();if(ctx.roundRect)ctx.roundRect(2,2,LW-4,LH-4,10);else ctx.rect(2,2,LW-4,LH-4);ctx.stroke();ctx.fillStyle='#ffffff';ctx.font='bold 26px Arial';ctx.textAlign='center';ctx.textBaseline='top';const dispName=(name.length>14?name.slice(0,13)+'‚Ä¶':name).toUpperCase();ctx.fillText(dispName,LW/2,10);ctx.fillStyle='#ffd700';ctx.font='20px Arial';ctx.fillText('¬£'+(chips/100).toFixed(2),LW/2,42);if(action){const ac=action.toUpperCase(),acCol=ac.startsWith('FOLD')?'#c04040':ac.startsWith('RAISE')?'#c08020':'#20a040';ctx.fillStyle=acCol;ctx.font='bold 18px Arial';ctx.fillText(ac,LW/2,78);}lb.tex.update();lb.plane.isVisible=true;}
function mkAnim(prop,type,keys,ease){const a=new BABYLON.Animation('a_'+prop,prop,60,type,BABYLON.Animation.ANIMATIONLOOPMODE_CONSTANT);a.setKeys(keys);const ef=ease==='in'?new BABYLON.QuadraticEase():new BABYLON.CubicEase();ef.setEasingMode(ease==='in'?BABYLON.EasingFunction.EASINGMODE_EASEIN:BABYLON.EasingFunction.EASINGMODE_EASEOUT);a.setEasingFunction(ef);return a;}
function animDeal(mesh,target,cb){const start=mesh.position.clone(),mid=new BABYLON.Vector3((start.x+target.x)*.5,start.y+2.8,(start.z+target.z)*.5),a=mkAnim('position',BABYLON.Animation.ANIMATIONTYPE_VECTOR3,[{frame:0,value:start},{frame:10,value:mid},{frame:24,value:target}],'out');scene.stopAnimation(mesh);mesh.animations=[a];scene.beginAnimation(mesh,0,24,false,1.5,cb||null);}
function animFlipUp(mesh,frontMat,cb){const a1=mkAnim('scaling.x',BABYLON.Animation.ANIMATIONTYPE_FLOAT,[{frame:0,value:1},{frame:9,value:0}],'in');scene.stopAnimation(mesh);mesh.animations=[a1];scene.beginAnimation(mesh,0,9,false,1,()=>{mesh.material=frontMat;const a2=mkAnim('scaling.x',BABYLON.Animation.ANIMATIONTYPE_FLOAT,[{frame:0,value:0},{frame:9,value:1}],'out');scene.stopAnimation(mesh);mesh.animations=[a2];scene.beginAnimation(mesh,0,9,false,1,cb||null);});}
function animChips(seat,amount,cb){const pos=seatPos(seat),n=Math.min(Math.ceil(amount/BB),7);let rem=n;if(n===0){if(cb)setTimeout(cb,80);return;}for(let i=0;i<n;i++){const chip=getChip(amount);potChips.push(chip);chip.position=pos.clone();chip.position.y+=0.40+i*0.06;const angle=Math.random()*Math.PI*2,dr=Math.random()*0.50,target=new BABYLON.Vector3(Math.cos(angle)*dr,0.30+potChips.length*0.072,Math.sin(angle)*dr),start=chip.position.clone(),mid=new BABYLON.Vector3((start.x+target.x)*.5,start.y+1.6,(start.z+target.z)*.5),a=mkAnim('position',BABYLON.Animation.ANIMATIONTYPE_VECTOR3,[{frame:0,value:start},{frame:10,value:mid},{frame:22,value:target}],'out');chip.animations=[a];setTimeout(()=>{scene.beginAnimation(chip,0,22,false,1.3,()=>{snd_chip();rem--;if(rem===0&&cb)cb();});},i*70);}}
function chipsFlyToWinner(winSeat,cb){const wp=seatPos(winSeat);wp.y+=0.7;let rem=potChips.length;if(!rem){if(cb)cb();return;}for(const chip of potChips){const start=chip.position.clone(),mid=new BABYLON.Vector3((start.x+wp.x)*.5,start.y+2.0,(start.z+wp.z)*.5),a=mkAnim('position',BABYLON.Animation.ANIMATIONTYPE_VECTOR3,[{frame:0,value:start},{frame:8,value:mid},{frame:18,value:wp}],'in');chip.animations=[a];scene.beginAnimation(chip,0,18,false,1.4,()=>{snd_chip();freeChip(chip);rem--;if(rem===0){potChips=[];if(cb)cb();}});}}
function createScene(){scene=new BABYLON.Scene(engine);scene.clearColor=new BABYLON.Color4(0.055,0.025,0.010,1);const cam=new BABYLON.ArcRotateCamera('cam',-Math.PI/2,Math.PI/3.8,17,new BABYLON.Vector3(0,0.5,0),scene);cam.lowerRadiusLimit=7;cam.upperRadiusLimit=26;cam.lowerBetaLimit=0.20;cam.upperBetaLimit=1.35;cam.wheelPrecision=22;cam.attachControl(canvas,true);const h=new BABYLON.HemisphericLight('h',new BABYLON.Vector3(0,1,0),scene);h.intensity=0.20;h.diffuse=new BABYLON.Color3(0.55,0.48,0.60);h.groundColor=new BABYLON.Color3(0.06,0.04,0.08);spotLight=new BABYLON.SpotLight('sp',new BABYLON.Vector3(0,11,0),new BABYLON.Vector3(0,-1,0),Math.PI/2.1,1.4,scene);spotLight.intensity=1.8;spotLight.diffuse=new BABYLON.Color3(1,0.97,0.88);shadowGen=new BABYLON.ShadowGenerator(2048,spotLight);shadowGen.useBlurExponentialShadowMap=true;shadowGen.blurKernel=12;const f=BABYLON.MeshBuilder.CreateGround('floor',{width:44,height:44},scene);f.position.y=-0.22;f.receiveShadows=true;const fm=new BABYLON.StandardMaterial('fm',scene);fm.diffuseColor=new BABYLON.Color3(0.10,0.048,0.020);fm.specularColor=new BABYLON.Color3(0.20,0.10,0.04);fm.specularPower=80;f.material=fm;const T=96,base=BABYLON.MeshBuilder.CreateCylinder('base',{height:0.44,diameter:12,tessellation:T},scene);base.scaling.x=TRX/6;base.scaling.z=TRZ/6;base.position.y=-0.01;const bm=new BABYLON.StandardMaterial('bm',scene);bm.diffuseColor=new BABYLON.Color3(0.22,0.10,0.04);bm.specularColor=new BABYLON.Color3(0.55,0.32,0.08);bm.specularPower=160;base.material=bm;const rail=BABYLON.MeshBuilder.CreateTorus('rail',{diameter:11.4,thickness:0.42,tessellation:T,radialSegments:20},scene);rail.scaling.x=TRX/(11.4/2)*0.97;rail.scaling.z=TRZ/(11.4/2)*0.97;rail.position.y=0.18;const rm=new BABYLON.StandardMaterial('rm',scene);rm.diffuseColor=new BABYLON.Color3(0.30,0.14,0.05);rm.specularColor=new BABYLON.Color3(0.80,0.50,0.15);rm.specularPower=220;rm.emissiveColor=new BABYLON.Color3(0.04,0.02,0.005);rail.material=rm;const felt=BABYLON.MeshBuilder.CreateCylinder('felt',{height:0.07,diameter:10.8,tessellation:T},scene);felt.scaling.x=TRX/(10.8/2)*0.90;felt.scaling.z=TRZ/(10.8/2)*0.90;felt.position.y=0.22;const ftm=new BABYLON.StandardMaterial('ftm',scene);ftm.diffuseColor=new BABYLON.Color3(0.10,0.52,0.18);ftm.specularColor=new BABYLON.Color3(0.015,0.06,0.025);ftm.specularPower=6;felt.material=ftm;felt.receiveShadows=true;buildCardMats();buildCardPool();buildChipPool();buildPlayerLabels();buildTokens();for(let i=0;i<NP;i++)seatCardMeshes.push([null,null]);return scene;}
let seatActions={};
function applyState(st){if(!st)return;lastState=st;for(let i=0;i<NP;i++){const p=st.players[i];if(p)updateLabel(i,p.name,p.chips,seatActions[i]||'',i===mySeat,p.folded);else updateLabel(i,null,0,'',false,false);}const comm=st.community||[];for(let ci=0;ci<5;ci++){const mesh=communityCardMeshes[ci];if(ci<comm.length){if(!mesh||!mesh.isVisible){const m=getOrCreateCommunityMesh(ci),target=COM_POS[ci].clone();m.material=cardBackMat;m.isVisible=true;animDeal(m,target,()=>{snd_deal();const cd=comm[ci];if(cd&&cd!=='back')animFlipUp(m,cardFrontMats[cd.r+cd.s]||cardBackMat,()=>snd_flip());});}}else{if(mesh)mesh.isVisible=false;}}for(let i=0;i<NP;i++){const p=st.players[i],meshes=seatCardMeshes[i];if(!p||!p.cards||p.cards.length===0){for(const m of meshes){if(m)m.isVisible=false;}seatCardMeshes[i]=[null,null];continue;}p.cards.forEach((cd,cn)=>{const m=meshes[cn];if(!m||!m.isVisible)return;if(cd&&cd!=='back'){const fmat=cardFrontMats[cd.r+cd.s];if(fmat&&m.material!==fmat)animFlipUp(m,fmat,()=>snd_flip());}});}const p0=st.players[mySeat];if(p0)document.getElementById('myInfo').textContent=`YOUR CHIPS: ¬£${(p0.chips/100).toFixed(2)}  |  BET: ¬£${(p0.bet/100).toFixed(2)}`;document.getElementById('pot').textContent='POT: ¬£'+((st.pot||0)/100).toFixed(2);document.getElementById('phase').textContent=(st.phase||'').toUpperCase().replace('PREFLOP','PRE-FLOP');}
function getOrCreateCommunityMesh(idx){if(communityCardMeshes[idx]&&communityCardMeshes[idx].isVisible!==undefined)return communityCardMeshes[idx];const m=nextCardMesh();communityCardMeshes[idx]=m;return m;}
function startDealAnimation(activeSeats,afterDone){dealing=true;for(let i=0;i<NP;i++){for(const m of seatCardMeshes[i]){if(m)m.isVisible=false;}seatCardMeshes[i]=[null,null];}for(const m of communityCardMeshes){if(m)m.isVisible=false;}communityCardMeshes=[];for(const ch of potChips)freeChip(ch);potChips=[];const seq=[];for(let rd=0;rd<2;rd++)for(const si of activeSeats)seq.push(si);const dealt={};for(const si of activeSeats)dealt[si]=0;let idx=0;function next(){if(idx>=seq.length){dealing=false;if(afterDone)afterDone();return;}const si=seq[idx++],cn=dealt[si]||0;dealt[si]=cn+1;const m=nextCardMesh();seatCardMeshes[si][cn]=m;const target=cardPos(si,cn);animDeal(m,target,()=>{snd_deal();if(lastState&&lastState.players[si]){const cd=lastState.players[si].cards[cn];if(cd&&cd!=='back')animFlipUp(m,cardFrontMats[cd.r+cd.s]||cardBackMat,()=>snd_flip());}setTimeout(next,80);});}next();}
function connectWS(name,roomId,playerId){const proto=location.protocol==='https:'?'wss:':'ws:';ws=new WebSocket(`${proto}//${location.host}`);ws.onopen=()=>{console.log('WebSocket connected');ws.send(JSON.stringify({type:'join',id:playerId,name,room:roomId}));};ws.onmessage=(ev)=>{let msg;try{msg=JSON.parse(ev.data);}catch{return;}handleServerMsg(msg);};ws.onclose=()=>{showMsg('‚ö† Disconnected from server',0);setTimeout(()=>location.reload(),4000);};ws.onerror=()=>{document.getElementById('loginErr').textContent='Could not connect to server.';document.getElementById('loginOverlay').style.display='flex';document.getElementById('waitingOverlay').style.display='none';document.getElementById('lobbyOverlay').style.display='none';};}
function wsSend(obj){if(ws&&ws.readyState===1)ws.send(JSON.stringify(obj));}
function handleServerMsg(msg){switch(msg.type){case 'joined':myId=msg.id;mySeat=msg.seat;isHost=msg.isHost;localStorage.setItem('pokerPlayerId',myId);document.getElementById('loginOverlay').style.display='none';document.getElementById('waitingOverlay').style.display='none';break;case 'waiting':document.getElementById('loginOverlay').style.display='none';document.getElementById('waitingOverlay').style.display='flex';break;case 'rejected':document.getElementById('waitingOverlay').style.display='none';document.getElementById('loginOverlay').style.display='flex';document.getElementById('loginErr').textContent=msg.reason||'Entry declined.';break;case 'lobby':renderLobby(msg);if(isHost&&msg.pending){for(const p of msg.pending){if(!pendingInGame[p.id])pendingInGame[p.id]={id:p.id,name:p.name};}for(const id of Object.keys(pendingInGame)){if(!msg.pending.find(p=>p.id===id))delete pendingInGame[id];}refreshInGameJoinNotif();}break;case 'joinRequest':if(isHost){ensureAudio();snd_joinAlert();addInGameJoinRequest(msg.id,msg.name);if(document.getElementById('lobbyOverlay').style.display!=='none'&&lastLobbyMsg){if(!lastLobbyMsg.pending.find(p=>p.id===msg.id))lastLobbyMsg.pending.push({id:msg.id,name:msg.name});renderLobby(lastLobbyMsg);}}break;case 'winner':snd_win();hideTurnIndicator();addLog(`üèÜ ${msg.name} wins ¬£${(msg.amount/100).toFixed(2)} ‚Äî ${msg.label||''}`,'log-win');showMsg(`üèÜ ${msg.name} wins ¬£${(msg.amount/100).toFixed(2)}\n${msg.label||''}!`,0);chipsFlyToWinner(msg.seat,()=>{});setTimeout(()=>showMsg(''),5500);break;case 'gameStarting':document.getElementById('lobbyOverlay').style.display='none';document.getElementById('gameUI').style.display='block';document.getElementById('roomBadge').textContent='ROOM '+myRoomId;break;case 'newHand':seatActions={};showMsg('');setActions(false);hideTurnIndicator();document.getElementById('waitingMsg').style.display='none';handNumber++;addLog(`‚îÅ‚îÅ Hand #${handNumber} | Dealer: Seat ${(msg.dealerSeat+1)} ‚îÅ‚îÅ`,'log-hand');addLog(`SB: Seat ${msg.sbSeat+1} ¬∑ BB: Seat ${msg.bbSeat+1}`);positionTokens(msg.dealerSeat,msg.sbSeat,msg.bbSeat);startDealAnimation(msg.activeSeats||[],()=>{if(lastState)applyState(lastState);});break;case 'state':lastState=msg;if(!dealing)applyState(msg);break;case 'playerAction':{const pname=msg.name||'Player',ac=msg.action==='fold'?'FOLD':msg.action==='check'?'CHECK':msg.action==='call'?`CALL ¬£${((msg.amount||0)/100).toFixed(2)}`:`RAISE ¬£${((msg.amount||0)/100).toFixed(2)}`;seatActions[msg.seat]=ac;addLog(`${pname}: ${ac}`);if(msg.amount>0)animChips(msg.seat,msg.amount,null);hideTurnIndicator();if(lastState)applyState(lastState);break;}case 'yourTurn':{const ca=msg.callAmt||0;if(msg.seat===mySeat){document.getElementById('callBtn').textContent=ca>0?`CALL ¬£${(ca/100).toFixed(2)}`:'CHECK';document.getElementById('raiseAmt').value=((msg.minRaise||40)/100).toFixed(2);setActions(true);showMsg('‚≠ê Your turn!',0);document.getElementById('waitingMsg').style.display='none';}else{setActions(false);showMsg('');const actingPlayer=lastState&&lastState.players[msg.seat];const actingName=actingPlayer?actingPlayer.name:`Seat ${msg.seat+1}`;showTurnIndicator(`‚è≥ ${actingName} is thinking‚Ä¶`);}break;}case 'communityDealt':if(msg.phase)addLog(`‚ñ∂ ${msg.phase.toUpperCase()}: ${(msg.newCards||msg.cards||[]).map(c=>c.r+c.s).join(' ')}`,'log-community');break;case 'showdown':setPhase('Showdown');hideTurnIndicator();addLog('‚îÄ‚îÄ SHOWDOWN ‚îÄ‚îÄ','log-hand');showMsg('üÉè Showdown!',2000);break;case 'waitingForPlayers':showMsg('‚è≥ Waiting for more players‚Ä¶',0);hideTurnIndicator();break;case 'playerLeft':addLog(`${msg.name} left the table`);addChat(`‚¨Ö ${msg.name} left`);seatActions[msg.seat]='';if(pendingInGame[msg.id]){delete pendingInGame[msg.id];refreshInGameJoinNotif();}if(lastState)applyState(lastState);break;case 'sittingOut':{document.getElementById('gameUI').style.display='block';document.getElementById('lobbyOverlay').style.display='none';const wmEl=document.getElementById('waitingMsg');wmEl.textContent=msg.reason||'Sitting out‚Ä¶';wmEl.style.display='block';break;}case 'chat':addChat(`${msg.name}: ${msg.text}`);break;case 'error':addChat(`‚ö† ${msg.msg}`);break;}}
function renderLobby(msg){lastLobbyMsg=msg;myRoomId=msg.roomId;document.getElementById('lobbyRoomId').textContent=msg.roomId;if(msg.gameActive)return;document.getElementById('loginOverlay').style.display='none';document.getElementById('waitingOverlay').style.display='none';document.getElementById('lobbyOverlay').style.display='flex';const pl=document.getElementById('playerList');pl.innerHTML='<h3 style="color:#c8a020;margin-bottom:8px">Players at table:</h3>';const seated=msg.seats.filter(Boolean);for(const s of seated){const div=document.createElement('div');div.className='player-row';div.innerHTML=`<span>${s.name}${s.id===msg.hostId?'<span class="host-badge">HOST</span>':''}</span><span class="chips">¬£${(s.chips/100).toFixed(2)}</span>`;pl.appendChild(div);}const ps=document.getElementById('pendingSection'),pi=document.getElementById('pendingItems'),pending=msg.pending||[];if(isHost&&pending.length>0){ps.style.display='block';pi.innerHTML='';for(const p of pending){const row=document.createElement('div');row.className='pending-row';row.innerHTML=`<span>${p.name}</span><span><button class="btn-sm btn-approve" onclick="approvePlayer('${p.id}',true)">‚úì Admit</button><button class="btn-sm btn-reject" onclick="approvePlayer('${p.id}',false)">‚úó Reject</button></span>`;pi.appendChild(row);}}else{ps.style.display='none';}const statusEl=document.getElementById('lobbyStatus');if(isHost)statusEl.textContent=seated.length<2?'Waiting for more players to join‚Ä¶':'Ready to start!';else statusEl.textContent='Waiting for host to start the game‚Ä¶';const sb=document.getElementById('startBtn');if(isHost){sb.style.display='block';sb.disabled=seated.length<2;}else{sb.style.display='none';}}
function approvePlayer(id,accept){wsSend({type:'approve',id,accept});}
let pendingInGame={};
function addInGameJoinRequest(id,name){pendingInGame[id]={id,name};refreshInGameJoinNotif();}
function refreshInGameJoinNotif(){const notif=document.getElementById('joinRequestNotif'),list=document.getElementById('joinReqList'),entries=Object.values(pendingInGame);if(!entries.length||!isHost){notif.style.display='none';return;}notif.style.display='block';list.innerHTML='';for(const p of entries){const row=document.createElement('div');row.className='jr-row';row.innerHTML=`<span class="jr-name">${p.name}</span><span class="jr-btns"><button class="jr-admit" onclick="inGameApprove('${p.id}',true)">Admit</button><button class="jr-reject" onclick="inGameApprove('${p.id}',false)">Reject</button></span>`;list.appendChild(row);}}
function inGameApprove(id,accept){wsSend({type:'approve',id,accept});delete pendingInGame[id];refreshInGameJoinNotif();}
function showTurnIndicator(txt){document.getElementById('turnIndicator').textContent=txt;document.getElementById('turnIndicator').style.display='block';}
function hideTurnIndicator(){document.getElementById('turnIndicator').style.display='none';}
function setActions(v){document.getElementById('actions').style.display=v?'flex':'none';}
function setPhase(p){document.getElementById('phase').textContent=p.toUpperCase();}
function showMsg(m,ms=2400){const el=document.getElementById('msg');el.textContent=m;el.style.display=m?'block':'none';if(ms>0)setTimeout(()=>el.style.display='none',ms);}
function addChat(txt){const log=document.getElementById('chatLog'),div=document.createElement('div');div.textContent=txt;log.appendChild(div);log.scrollTop=log.scrollHeight;while(log.children.length>60)log.removeChild(log.firstChild);}
let handNumber=0;
function addLog(txt,cls='log-action'){const log=document.getElementById('activityLog');if(!log)return;const div=document.createElement('div');div.className=cls;div.textContent=txt;log.appendChild(div);log.scrollTop=log.scrollHeight;while(log.children.length>200)log.removeChild(log.firstChild);}
let activityCollapsed=false;
function toggleActivityLog(){activityCollapsed=!activityCollapsed;const logEl=document.getElementById('activityLog'),toggle=document.getElementById('activityToggle');logEl.style.display=activityCollapsed?'none':'flex';toggle.textContent=activityCollapsed?'‚ñ∂ maximise':'‚ñº minimise';}
document.getElementById('callBtn').onclick=()=>{ensureAudio();setActions(false);showMsg('');wsSend({type:'action',action:'call'});};
document.getElementById('raiseBtn').onclick=()=>{ensureAudio();setActions(false);showMsg('');const val=Math.round(parseFloat(document.getElementById('raiseAmt').value)*100)||40;wsSend({type:'action',action:'raise',amount:val});};
document.getElementById('foldBtn').onclick=()=>{ensureAudio();setActions(false);showMsg('');wsSend({type:'action',action:'fold'});};
document.getElementById('chatInput').addEventListener('keydown',e=>{if(e.key==='Enter'){const t=e.target.value.trim();if(t){wsSend({type:'chat',text:t});e.target.value='';}}});
document.getElementById('brightSlider').oninput=(e)=>{if(spotLight)spotLight.intensity=parseFloat(e.target.value);};
document.getElementById('startBtn').onclick=()=>{wsSend({type:'startGame'});};
document.getElementById('joinBtn').onclick=()=>{const name=document.getElementById('nameInput').value.trim(),room=document.getElementById('roomInput').value.trim();if(!name){document.getElementById('loginErr').textContent='Please enter your name.';return;}if(!room){document.getElementById('loginErr').textContent='Please enter a room number.';return;}document.getElementById('loginErr').textContent='';document.getElementById('loginOverlay').style.display='none';document.getElementById('waitingOverlay').style.display='flex';document.getElementById('waitingTxt').textContent='Connecting‚Ä¶';myRoomId=room;if(!myId){myId='p_'+Math.random().toString(36).slice(2,10);localStorage.setItem('pokerPlayerId',myId);}connectWS(name,room,myId);};
['nameInput','roomInput'].forEach(id=>{document.getElementById(id).addEventListener('keydown',e=>{if(e.key==='Enter')document.getElementById('joinBtn').click();});});
const scn=createScene();
engine.runRenderLoop(()=>scn.render());
</script>
</body>
</html>
